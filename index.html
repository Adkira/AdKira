<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AdKira Check-In</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes fall {
      to {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }
      100% {
        background-position: 1000px 0;
      }
    }

    .vip-badge {
      background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 50%, #fbbf24 100%);
      background-size: 200% auto;
      animation: shimmer 3s linear infinite;
    }
    
    .animate-slide-in {
      animation: slideIn 0.4s ease-out;
    }

    .animate-pulse-slow {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 14px;
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
      max-width: 90%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9000;
      padding: 16px;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-content {
      animation: slideIn 0.3s ease-out;
      max-width: 600px;
      width: 100%;
      max-height: 90%;
      overflow-y: auto;
    }

    #qr-reader {
      width: 100% !important;
      border: none !important;
    }

    #qr-reader__scan_region {
      border: 3px solid #007f9f !important;
    }

    .tab-button {
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }

    .tab-button.active {
      border-bottom-color: #007f9f;
    }

    .confetti {
      position: fixed;
      animation: fall 3s linear;
    }

    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full" style="background-color: #0a1929;">
  <div id="app" class="h-full w-full overflow-auto">
   <div class="flex items-center justify-center h-full">
    <div class="loading-spinner"></div>
   </div>
  </div>
  <script>
    const SUPABASE_URL = 'https://sekkrboqttxpathyxcun.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNla2tyYm9xdHR4cGF0aHl4Y3VuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNjY0OTYsImV4cCI6MjA3OTc0MjQ5Nn0.JqrLUWHs3-jyUNT-0s2DwiyeDjK0uv6uIh0ip1qPWBA';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const config = {
      primary_color: "#007f9f",
      background_color: "#0a1929",
      card_color: "#132f4c",
      text_color: "#ffffff",
      success_color: "#10b981",
      error_color: "#ef4444",
      vip_color: "#fbbf24",
      app_title: "AdKira Check-In"
    };

    let clients = [];
    let guests = [];
    let checkins = [];
    let currentView = 'login';
    let currentUser = null;
    let currentTab = 'home';
    let html5QrCode = null;
    let offlineQueue = [];
    let isOnline = navigator.onLine;
    let currentFilter = 'all';
    let currentSearchQuery = '';

    const STORAGE_KEYS = {
      ADMIN_SESSION: 'adkira_admin_session',
      CLIENT_SESSION: 'adkira_client_session',
      OFFLINE_QUEUE: 'adkira_offline_queue'
    };

    // =============== HELPER: PROCESSAR LISTA DE CONVIDADOS ===============
    
    function parseGuestList(rawText) {
      if (!rawText || !rawText.trim()) return [];
      
      const lines = rawText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
      const parsedGuests = [];
      
      lines.forEach((line, index) => {
        // Remover c√≥digo no in√≠cio (formato: "n√∫mero," ou "n√∫mero.")
        let cleanLine = line.replace(/^\d+[\.,]\s*/, '').trim();
        
        if (!cleanLine) return;
        
        // Detectar se tem acompanhante pelo padr√£o " e "
        const hasCompanion = cleanLine.toLowerCase().includes(' e ');
        
        parsedGuests.push({
          originalLine: line,
          name: cleanLine,
          has_companion: hasCompanion,
          lineNumber: index + 1
        });
      });
      
      return parsedGuests;
    }

    // =============== FILE UPLOAD HANDLER ===============
    
    function handleGuestListFile(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;
      
      // Verificar se todos os arquivos s√£o .txt
      const invalidFiles = Array.from(files).filter(file => !file.name.endsWith('.txt'));
      if (invalidFiles.length > 0) {
        showToast('‚ùå Por favor, selecione apenas arquivos .txt', 'error');
        event.target.value = '';
        return;
      }
      
      const textarea = document.getElementById('guest-list-textarea');
      if (!textarea) return;
      
      let combinedContent = '';
      let filesProcessed = 0;
      let totalLines = 0;
      
      // Processar cada arquivo
      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const content = e.target.result;
          
          // Adicionar separador visual entre arquivos (se houver mais de 1)
          if (files.length > 1 && index > 0 && combinedContent.length > 0) {
            combinedContent += '\n';
          }
          
          combinedContent += content;
          
          const lineCount = content.split('\n').filter(line => line.trim().length > 0).length;
          totalLines += lineCount;
          
          filesProcessed++;
          
          // Quando todos os arquivos forem processados
          if (filesProcessed === files.length) {
            textarea.value = combinedContent;
            
            if (files.length === 1) {
              showToast(`‚úÖ Arquivo carregado! ${totalLines} linhas detectadas`, 'success');
            } else {
              showToast(`‚úÖ ${files.length} arquivos carregados! Total: ${totalLines} linhas`, 'success');
            }
          }
        };
        
        reader.onerror = function() {
          showToast(`‚ùå Erro ao ler o arquivo: ${file.name}`, 'error');
          filesProcessed++;
        };
        
        reader.readAsText(file);
      });
      
      event.target.value = '';
    }

    // =============== SUPABASE FUNCTIONS ===============

    async function loadClients() {
      try {
        const { data, error } = await supabase
          .from('clients')
          .select('*')
          .eq('deleted', false)
          .order('created_at', { ascending: false });

        if (error) throw error;
        clients = data || [];
        return true;
      } catch (error) {
        console.error('Erro ao carregar clientes:', error);
        return false;
      }
    }

    async function loadGuests() {
      try {
        const { data, error } = await supabase
          .from('guests')
          .select('*')
          .eq('deleted', false)
          .order('created_at', { ascending: false });

        if (error) throw error;
        guests = data || [];
        return true;
      } catch (error) {
        console.error('Erro ao carregar convidados:', error);
        return false;
      }
    }

    async function loadCheckins() {
      try {
        const { data, error } = await supabase
          .from('checkins')
          .select('*')
          .order('checked_in_at', { ascending: false });

        if (error) throw error;
        checkins = data || [];
        return true;
      } catch (error) {
        console.error('Erro ao carregar check-ins:', error);
        return false;
      }
    }

    async function loadAllData() {
      const results = await Promise.all([
        loadClients(),
        loadGuests(),
        loadCheckins()
      ]);
      return results.every(r => r === true);
    }

    async function validateAdminCredentials(username, password) {
      try {
        const { data, error } = await supabase
          .from('admin_credentials')
          .select('*')
          .eq('username', username)
          .eq('password', password)
          .eq('active', true)
          .single();

        if (error || !data) return false;
        return true;
      } catch (error) {
        console.error('Erro ao validar admin:', error);
        return false;
      }
    }

    async function createClient(clientData) {
      try {
        const { data, error } = await supabase
          .from('clients')
          .insert([clientData])
          .select();

        if (error) throw error;
        await loadClients();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao criar cliente:', error);
        return { success: false, error };
      }
    }

    async function updateClient(clientId, updates) {
      try {
        const { data, error } = await supabase
          .from('clients')
          .update(updates)
          .eq('id', clientId)
          .select();

        if (error) throw error;
        await loadClients();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao atualizar cliente:', error);
        return { success: false, error };
      }
    }

    async function deleteClient(clientId) {
      try {
        const { data, error } = await supabase
          .from('clients')
          .update({ deleted: true, deleted_at: new Date().toISOString() })
          .eq('id', clientId)
          .select();

        if (error) throw error;
        await loadClients();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao deletar cliente:', error);
        return { success: false, error };
      }
    }

    async function restoreClient(clientId) {
      try {
        const { data, error } = await supabase
          .from('clients')
          .update({ deleted: false, deleted_at: null })
          .eq('id', clientId)
          .select();

        if (error) throw error;
        await loadClients();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao restaurar cliente:', error);
        return { success: false, error };
      }
    }

    async function loadDeletedClients() {
      try {
        const { data, error } = await supabase
          .from('clients')
          .select('*')
          .eq('deleted', true)
          .order('deleted_at', { ascending: false });

        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Erro ao carregar clientes deletados:', error);
        return [];
      }
    }

    async function createGuest(guestData) {
      try {
        const { data, error } = await supabase
          .from('guests')
          .insert([guestData])
          .select();

        if (error) throw error;
        await loadGuests();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao criar convidado:', error);
        return { success: false, error };
      }
    }

    async function createMultipleGuests(guestsArray) {
      try {
        const { data, error } = await supabase
          .from('guests')
          .insert(guestsArray)
          .select();

        if (error) throw error;
        await loadGuests();
        return { success: true, data, count: data.length };
      } catch (error) {
        console.error('Erro ao criar m√∫ltiplos convidados:', error);
        return { success: false, error };
      }
    }

    async function updateGuest(guestId, updates) {
      try {
        const { data, error } = await supabase
          .from('guests')
          .update(updates)
          .eq('id', guestId)
          .select();

        if (error) throw error;
        await loadGuests();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao atualizar convidado:', error);
        return { success: false, error };
      }
    }

    async function deleteGuest(guestId) {
      try {
        const { data, error } = await supabase
          .from('guests')
          .update({ deleted: true, deleted_at: new Date().toISOString() })
          .eq('id', guestId)
          .select();

        if (error) throw error;
        await loadGuests();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao deletar convidado:', error);
        return { success: false, error };
      }
    }

    async function restoreGuest(guestId) {
      try {
        const { data, error } = await supabase
          .from('guests')
          .update({ deleted: false, deleted_at: null })
          .eq('id', guestId)
          .select();

        if (error) throw error;
        await loadGuests();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao restaurar convidado:', error);
        return { success: false, error };
      }
    }

    async function loadDeletedGuests() {
      try {
        const { data, error } = await supabase
          .from('guests')
          .select('*')
          .eq('deleted', true)
          .order('deleted_at', { ascending: false });

        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Erro ao carregar convidados deletados:', error);
        return [];
      }
    }

    async function createCheckin(checkinData) {
      try {
        const { data, error } = await supabase
          .from('checkins')
          .insert([checkinData])
          .select();

        if (error) throw error;
        await loadCheckins();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao criar check-in:', error);
        return { success: false, error };
      }
    }

    async function deleteCheckin(checkinId) {
      try {
        const { error } = await supabase
          .from('checkins')
          .delete()
          .eq('id', checkinId);

        if (error) throw error;
        await loadCheckins();
        return { success: true };
      } catch (error) {
        console.error('Erro ao deletar check-in:', error);
        return { success: false, error };
      }
    }

    async function deleteAllClientCheckins(clientId) {
      try {
        const { error } = await supabase
          .from('checkins')
          .delete()
          .eq('client_id', clientId);

        if (error) throw error;
        await loadCheckins();
        return { success: true };
      } catch (error) {
        console.error('Erro ao deletar check-ins do cliente:', error);
        return { success: false, error };
      }
    }

    // =============== PDF EXPORT ===============

    async function exportClientPDF(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (!client) return;

      const clientGuests = guests.filter(g => g.client_id === clientId);
      const clientCheckins = checkins.filter(c => c.client_id === clientId);

      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const primaryColor = [0, 127, 159];
        const darkColor = [10, 25, 41];
        const successColor = [16, 185, 129];
        const grayColor = [148, 163, 184];
        const vipColor = [251, 191, 36];
        
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        // CABE√áALHO
        doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
        doc.rect(0, 0, pageWidth, 45, 'F');
        
        doc.setFillColor(255, 255, 255);
        doc.circle(20, 22, 8, 'F');
        doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('‚úì', 20, 25, { align: 'center' });

        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.setFont(undefined, 'bold');
        doc.text('RELAT√ìRIO DE CHECK-IN', pageWidth / 2, 20, { align: 'center' });
        
        doc.setFontSize(11);
        doc.setFont(undefined, 'normal');
        doc.text('Sistema Profissional de Gest√£o de Eventos', pageWidth / 2, 28, { align: 'center' });
        
        doc.setFontSize(9);
        doc.setTextColor(240, 240, 240);
        doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, pageWidth / 2, 36, { align: 'center' });

        let yPos = 55;
        
        doc.setFillColor(245, 247, 250);
        doc.roundedRect(15, yPos, pageWidth - 30, 40, 3, 3, 'F');
        
        doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text(client.client_name, 20, yPos + 10);
        
        if (client.is_vip) {
          doc.setFillColor(vipColor[0], vipColor[1], vipColor[2]);
          doc.roundedRect(20 + doc.getTextWidth(client.client_name) + 5, yPos + 3, 20, 8, 2, 2, 'F');
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(8);
          doc.setFont(undefined, 'bold');
          doc.text('VIP', 30 + doc.getTextWidth(client.client_name), yPos + 9, { align: 'center' });
        }
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(100, 100, 100);
        doc.text(`Token de Acesso: ${client.token}`, 20, yPos + 20);
        
        if (client.event_date) {
          const eventDate = new Date(parseInt(client.event_date));
          const timeUntilEvent = parseInt(client.event_date) - Date.now();
          const daysUntil = Math.floor(timeUntilEvent / (1000 * 60 * 60 * 24));
          const hoursUntil = Math.floor((timeUntilEvent % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          
          doc.text(`Data do Evento: ${eventDate.toLocaleString('pt-BR')}`, 20, yPos + 28);
          if (timeUntilEvent > 0) {
            doc.text(`Faltam: ${daysUntil} dias e ${hoursUntil} horas`, 20, yPos + 35);
          } else {
            doc.text(`Evento j√° ocorreu`, 20, yPos + 35);
          }
        } else {
          const expiryDate = new Date(parseInt(client.expiry)).toLocaleString('pt-BR');
          const isExpired = parseInt(client.expiry) < Date.now();
          doc.text(`Validade: ${expiryDate} ${isExpired ? '(EXPIRADO)' : '(ATIVO)'}`, 20, yPos + 28);
        }

        yPos = 105;
        
        const uniqueCheckins = clientCheckins.filter(c => !c.is_companion_only).length;
        const companionCount = clientCheckins.filter(c => c.is_companion_only || c.with_companion).length;
        const vipGuests = clientGuests.filter(g => g.is_vip).length;
        const attendanceRate = clientGuests.length > 0 ? ((uniqueCheckins / clientGuests.length) * 100).toFixed(1) : 0;

        const cardWidth = (pageWidth - 50) / 4;
        const cardHeight = 28;
        const cardSpacing = 5;

        doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
        doc.roundedRect(15, yPos, cardWidth, cardHeight, 2, 2, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('TOTAL', 15 + cardWidth/2, yPos + 8, { align: 'center' });
        doc.text('CONVIDADOS', 15 + cardWidth/2, yPos + 14, { align: 'center' });
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text(clientGuests.length.toString(), 15 + cardWidth/2, yPos + 24, { align: 'center' });

        doc.setFillColor(successColor[0], successColor[1], successColor[2]);
        doc.roundedRect(15 + cardWidth + cardSpacing, yPos, cardWidth, cardHeight, 2, 2, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('CHECK-INS', 15 + cardWidth + cardSpacing + cardWidth/2, yPos + 11, { align: 'center' });
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text(uniqueCheckins.toString(), 15 + cardWidth + cardSpacing + cardWidth/2, yPos + 24, { align: 'center' });

        doc.setFillColor(vipColor[0], vipColor[1], vipColor[2]);
        doc.roundedRect(15 + (cardWidth + cardSpacing) * 2, yPos, cardWidth, cardHeight, 2, 2, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('VIP', 15 + (cardWidth + cardSpacing) * 2 + cardWidth/2, yPos + 11, { align: 'center' });
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text(vipGuests.toString(), 15 + (cardWidth + cardSpacing) * 2 + cardWidth/2, yPos + 24, { align: 'center' });

        doc.setFillColor(99, 102, 241);
        doc.roundedRect(15 + (cardWidth + cardSpacing) * 3, yPos, cardWidth, cardHeight, 2, 2, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('TAXA', 15 + (cardWidth + cardSpacing) * 3 + cardWidth/2, yPos + 8, { align: 'center' });
        doc.text('COMPARECIMENTO', 15 + (cardWidth + cardSpacing) * 3 + cardWidth/2, yPos + 14, { align: 'center' });
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text(`${attendanceRate}%`, 15 + (cardWidth + cardSpacing) * 3 + cardWidth/2, yPos + 24, { align: 'center' });

        yPos = 145;
        
        doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('     Check-ins Realizados', 15, yPos);
        
        yPos += 8;
        
        doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
        doc.rect(15, yPos, pageWidth - 30, 10, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('#', 20, yPos + 7);
        doc.text('CONVIDADO', 35, yPos + 7);
        doc.text('DATA E HORA', pageWidth - 65, yPos + 7);
        
        yPos += 10;
        
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        
        if (clientCheckins.length === 0) {
          doc.setTextColor(grayColor[0], grayColor[1], grayColor[2]);
          doc.text('Nenhum check-in realizado at√© o momento', pageWidth / 2, yPos + 15, { align: 'center' });
        } else {
          let rowIndex = 0;
          
          const sortedCheckins = [...clientCheckins].sort((a, b) => 
            new Date(b.checked_in_at) - new Date(a.checked_in_at)
          );
          
          sortedCheckins.forEach((checkin, index) => {
            if (yPos > pageHeight - 30) {
              doc.addPage();
              yPos = 20;
              
              doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
              doc.rect(15, yPos, pageWidth - 30, 10, 'F');
              doc.setTextColor(255, 255, 255);
              doc.setFontSize(10);
              doc.setFont(undefined, 'bold');
              doc.text('#', 20, yPos + 7);
              doc.text('CONVIDADO', 35, yPos + 7);
              doc.text('DATA E HORA', pageWidth - 65, yPos + 7);
              yPos += 10;
              doc.setFont(undefined, 'normal');
              doc.setFontSize(9);
            }
            
            if (rowIndex % 2 === 0) {
              doc.setFillColor(249, 250, 251);
              doc.rect(15, yPos, pageWidth - 30, 12, 'F');
            }
            
            doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
            doc.text((index + 1).toString(), 20, yPos + 8);
            
            let guestName = checkin.guest_name;
            const guest = guests.find(g => g.qr_code === checkin.guest_qr);
            
            if (guest && guest.is_vip) {
              guestName = `‚≠ê ${guestName}`;
            }
            
            if (checkin.is_companion_only) {
              guestName = `üë§ Acompanhante de ${guestName}`;
            } else if (checkin.with_companion) {
              guestName = `${guestName} üë•`;
            }
            
            const maxNameWidth = pageWidth - 100;
            if (doc.getTextWidth(guestName) > maxNameWidth) {
              while (doc.getTextWidth(guestName + '...') > maxNameWidth && guestName.length > 0) {
                guestName = guestName.slice(0, -1);
              }
              guestName += '...';
            }
            
            doc.text(guestName, 35, yPos + 8);
            
            const checkinTime = new Date(checkin.checked_in_at).toLocaleString('pt-BR', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            doc.text(checkinTime, pageWidth - 25, yPos + 8, { align: 'right' });
            
            yPos += 12;
            rowIndex++;
          });
        }

        if (yPos > pageHeight - 50) {
          doc.addPage();
          yPos = 20;
        } else {
          yPos += 10;
        }
        
        doc.setFillColor(245, 247, 250);
        doc.roundedRect(15, yPos, pageWidth - 30, 40, 3, 3, 'F');
        
        doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('üìä Resumo do Evento', 20, yPos + 10);
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(100, 100, 100);
        doc.text(`‚Ä¢ Total de convidados cadastrados: ${clientGuests.length}`, 20, yPos + 18);
        doc.text(`‚Ä¢ Check-ins realizados (convidados principais): ${uniqueCheckins}`, 20, yPos + 24);
        doc.text(`‚Ä¢ Acompanhantes registrados: ${companionCount}`, 20, yPos + 30);
        doc.text(`‚Ä¢ Convidados VIP: ${vipGuests}`, 20, yPos + 36);

        const footerY = pageHeight - 15;
        doc.setDrawColor(primaryColor[0], primaryColor[1], primaryColor[2]);
        doc.setLineWidth(0.5);
        doc.line(15, footerY - 5, pageWidth - 15, footerY - 5);
        
        doc.setTextColor(grayColor[0], grayColor[1], grayColor[2]);
        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        doc.text('Created By AdKira 2025 ‚Ä¢ Sistema Profissional de Check-In', pageWidth / 2, footerY, { align: 'center' });
        doc.text(`P√°gina 1 de ${doc.internal.pages.length - 1}`, pageWidth - 20, footerY, { align: 'right' });

        const totalPages = doc.internal.pages.length - 1;
        for (let i = 2; i <= totalPages; i++) {
          doc.setPage(i);
          doc.setDrawColor(primaryColor[0], primaryColor[1], primaryColor[2]);
          doc.setLineWidth(0.5);
          doc.line(15, footerY - 5, pageWidth - 15, footerY - 5);
          doc.setTextColor(grayColor[0], grayColor[1], grayColor[2]);
          doc.setFontSize(8);
          doc.text('Created By AdKira 2025 ‚Ä¢ Sistema Profissional de Check-In', pageWidth / 2, footerY, { align: 'center' });
          doc.text(`P√°gina ${i} de ${totalPages}`, pageWidth - 20, footerY, { align: 'right' });
        }

        const fileName = `Relatorio_${client.client_name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`;
        doc.save(fileName);
        showToast('‚úÖ PDF profissional gerado com sucesso!', 'success');
      } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showToast('‚ùå Erro ao gerar PDF', 'error');
      }
    }

    // =============== OFFLINE QUEUE ===============

    function loadOfflineQueue() {
      const saved = localStorage.getItem(STORAGE_KEYS.OFFLINE_QUEUE);
      if (saved) {
        offlineQueue = JSON.parse(saved);
      }
    }

    function saveOfflineQueue() {
      localStorage.setItem(STORAGE_KEYS.OFFLINE_QUEUE, JSON.stringify(offlineQueue));
    }

    async function syncOfflineQueue() {
      if (offlineQueue.length === 0) return;
      
      showToast('üîÑ Sincronizando ' + offlineQueue.length + ' check-ins offline...', 'info');
      
      const successfulSyncs = [];
      
      for (const checkinData of offlineQueue) {
        const result = await createCheckin(checkinData);
        if (result.success) {
          successfulSyncs.push(checkinData.id);
        }
      }
      
      offlineQueue = offlineQueue.filter(item => !successfulSyncs.includes(item.id));
      saveOfflineQueue();
      
      if (offlineQueue.length === 0) {
        showToast('‚úÖ Todos os check-ins foram sincronizados!', 'success');
      } else {
        showToast('‚ö†Ô∏è ' + offlineQueue.length + ' check-ins ainda pendentes', 'warning');
      }
    }

    window.addEventListener('online', () => {
      isOnline = true;
      showToast('üåê Conex√£o restaurada!', 'success');
      syncOfflineQueue();
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      showToast('üì¥ Modo offline ativado', 'warning');
    });

    // =============== UI HELPERS ===============

    function showToast(message, type = 'success') {
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }

      const colors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
      };

      const toast = document.createElement('div');
      toast.className = 'toast text-white font-semibold';
      toast.style.backgroundColor = colors[type] || colors.info;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 4000);
    }

    function generateId(prefix) {
      return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    }

    function generateToken() {
      return 'TKN-' + Math.random().toString(36).substr(2, 9).toUpperCase();
    }

    function saveSession(type, data) {
      const key = type === 'admin' ? STORAGE_KEYS.ADMIN_SESSION : STORAGE_KEYS.CLIENT_SESSION;
      localStorage.setItem(key, JSON.stringify(data));
    }

    function loadSession(type) {
      const key = type === 'admin' ? STORAGE_KEYS.ADMIN_SESSION : STORAGE_KEYS.CLIENT_SESSION;
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : null;
    }

    function clearSession(type) {
      const key = type === 'admin' ? STORAGE_KEYS.ADMIN_SESSION : STORAGE_KEYS.CLIENT_SESSION;
      localStorage.removeItem(key);
    }

    function clearAllSessions() {
      clearSession('admin');
      clearSession('client');
    }

    async function checkExistingSession() {
      const adminSession = loadSession('admin');
      if (adminSession) {
        if (adminSession.username) {
          try {
            const { data, error } = await supabase
              .from('admin_credentials')
              .select('active')
              .eq('username', adminSession.username)
              .single();
            
            if (error || !data || !data.active) {
              clearSession('admin');
              showToast('‚ö†Ô∏è Sess√£o administrativa inv√°lida. Fa√ßa login novamente.', 'warning');
              return false;
            }
          } catch (e) {
            console.log('Erro ao validar admin (modo offline)');
          }
        }
        
        currentUser = { type: 'admin', id: 'admin', name: 'Administrador' };
        currentView = 'admin-dashboard';
        await renderAdminDashboard();
        return true;
      }

      const clientSession = loadSession('client');
      if (clientSession) {
        await loadClients();
        
        const client = clients.find(c => c.id === clientSession.clientId);
        
        if (!client) {
          clearSession('client');
          showToast('‚ö†Ô∏è Sess√£o inv√°lida. Fa√ßa login novamente.', 'warning');
          return false;
        }
        
        if (client.deleted) {
          clearSession('client');
          showToast('‚ùå Token desativado pelo administrador.', 'error');
          return false;
        }
        
        if (parseInt(client.expiry) < Date.now()) {
          clearSession('client');
          showToast('‚ùå Token expirado. Entre em contato com o administrador.', 'error');
          return false;
        }
        
        if (clientSession.token !== client.token) {
          clearSession('client');
          showToast('‚ùå Token alterado. Fa√ßa login novamente.', 'warning');
          return false;
        }

        currentUser = { type: 'client', id: client.id, name: client.client_name };
        currentView = 'client-dashboard';
        await renderClientDashboard();
        return true;
      }

      return false;
    }

    // =============== LOGIN ===============

    function renderLogin() {
      document.getElementById('app').innerHTML = `
        <div class="min-h-full flex flex-col items-center justify-center p-4" style="background: linear-gradient(135deg, ${config.background_color} 0%, ${config.card_color} 100%);">
          <div class="w-full max-w-md animate-slide-in">
            <div class="text-center mb-8">
              <div class="w-24 h-24 mx-auto mb-6 rounded-3xl flex items-center justify-center" style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); box-shadow: 0 20px 60px rgba(0, 127, 159, 0.4);">
                <svg class="w-12 h-12" style="color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h1 class="font-bold mb-2" style="font-size: 40px; color: ${config.text_color};">
                ${config.app_title}
              </h1>
              <p class="opacity-70" style="font-size: 18px; color: ${config.text_color};">
                Sistema Profissional de Check-In
              </p>
            </div>

            <div class="rounded-3xl p-8 backdrop-blur-lg" style="background-color: ${config.card_color}cc; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
              <div class="flex gap-2 mb-6">
                <button onclick="switchLoginType('client')" id="client-tab" class="flex-1 py-3 rounded-xl font-semibold transition-all" style="background-color: ${config.primary_color}; color: white;">
                  Cliente
                </button>
                <button onclick="switchLoginType('admin')" id="admin-tab" class="flex-1 py-3 rounded-xl font-semibold transition-all" style="background-color: ${config.background_color}; color: ${config.text_color};">
                  Administrador
                </button>
              </div>

              <div id="login-form-container"></div>
            </div>

            <div class="text-center mt-6">
              <p class="opacity-40" style="font-size: 12px; color: ${config.text_color};">
                Created By AdKira 2025
              </p>
            </div>
          </div>
        </div>
      `;

      switchLoginType('client');
    }

    function switchLoginType(type) {
      document.getElementById('admin-tab').style.backgroundColor = type === 'admin' ? config.primary_color : config.background_color;
      document.getElementById('client-tab').style.backgroundColor = type === 'client' ? config.primary_color : config.background_color;

      const container = document.getElementById('login-form-container');
      
      if (type === 'admin') {
        container.innerHTML = `
          <form onsubmit="loginAdmin(event); return false;">
            <div class="mb-4">
              <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                Nome de Usu√°rio
              </label>
              <input 
                type="text" 
                name="username" 
                required 
                class="w-full px-4 py-3 rounded-xl outline-none transition-all"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px; border: 2px solid transparent;"
                placeholder="Digite o usu√°rio"
              >
            </div>
            <div class="mb-6">
              <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                Senha do Administrador
              </label>
              <input 
                type="password" 
                name="password" 
                required 
                class="w-full px-4 py-3 rounded-xl outline-none transition-all"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px; border: 2px solid transparent;"
                placeholder="Digite a senha"
              >
            </div>
            <button 
              type="submit" 
              class="w-full py-4 rounded-xl font-bold transition-all transform active:scale-95"
              style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); color: white; font-size: 18px; box-shadow: 0 10px 30px rgba(0, 127, 159, 0.3);"
            >
              Entrar como Admin
            </button>
          </form>
        `;
      } else {
        container.innerHTML = `
          <form onsubmit="loginClient(event); return false;">
            <div class="mb-6">
              <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                Token de Acesso
              </label>
              <input 
                type="text" 
                name="token" 
                required 
                class="w-full px-4 py-3 rounded-xl outline-none transition-all font-mono"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px; border: 2px solid transparent;"
                placeholder="TKN-XXXXXXXXX"
              >
            </div>
            <button 
              type="submit" 
              class="w-full py-4 rounded-xl font-bold transition-all transform active:scale-95"
              style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); color: white; font-size: 18px; box-shadow: 0 10px 30px rgba(0, 127, 159, 0.3);"
            >
              Entrar como Cliente
            </button>
          </form>
        `;
      }
    }

    async function loginAdmin(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const username = formData.get('username');
      const password = formData.get('password');

      const isValid = await validateAdminCredentials(username, password);

      if (isValid) {
        currentUser = { type: 'admin', id: 'admin', name: 'Administrador' };
        saveSession('admin', { loggedIn: true, username: username });
        currentView = 'admin-dashboard';
        currentTab = 'home';
        showToast('Login realizado com sucesso!', 'success');
        await renderAdminDashboard();
      } else {
        showToast('Usu√°rio ou senha incorretos!', 'error');
      }
    }

    async function loginClient(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const token = formData.get('token').trim();

      await loadClients();
      
      const client = clients.find(c => c.token === token);

      if (!client) {
        showToast('‚ùå Token inv√°lido!', 'error');
        clearSession('client');
        return;
      }

      if (client.deleted) {
        showToast('‚ùå Token desativado! Entre em contato com o administrador.', 'error');
        clearSession('client');
        return;
      }

      if (parseInt(client.expiry) < Date.now()) {
        showToast('‚ùå Token expirado! Entre em contato com o administrador.', 'error');
        clearSession('client');
        return;
      }

      currentUser = { type: 'client', id: client.id, name: client.client_name };
      saveSession('client', { clientId: client.id, token: token, expiry: client.expiry });
      currentView = 'client-dashboard';
      currentTab = 'home';
      showToast('‚úÖ Bem-vindo, ' + client.client_name + '!', 'success');
      await renderClientDashboard();
    }

    function logout() {
      clearAllSessions();
      currentUser = null;
      currentView = 'login';
      currentTab = 'home';
      if (html5QrCode) {
        html5QrCode.stop().catch(() => {});
        html5QrCode = null;
      }
      showToast('Logout realizado com sucesso!', 'info');
      renderLogin();
    }

    // =============== ADMIN DASHBOARD ===============

    async function renderAdminDashboard() {
      const activeClients = clients.filter(c => parseInt(c.expiry) > Date.now());
      const totalGuests = guests.length;
      const totalCheckins = checkins.length;
      const vipClients = clients.filter(c => c.is_vip);

      document.getElementById('app').innerHTML = `
        <div class="min-h-full flex flex-col" style="background-color: ${config.background_color};">
          <div class="p-4" style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <div class="flex items-center justify-between">
              <div>
                <h1 class="font-bold mb-1" style="font-size: 28px; color: white;">
                  ${config.app_title}
                  <span class="ml-2 inline-block w-3 h-3 rounded-full animate-pulse-slow" style="background-color: #10b981;"></span>
                </h1>
                <p style="font-size: 14px; color: rgba(255,255,255,0.8);">
                  Painel do Administrador ‚Ä¢ Atualiza√ß√£o em Tempo Real
                </p>
              </div>
              <button onclick="logout()" class="px-4 py-2 rounded-lg font-semibold transition-all" style="background-color: rgba(255,255,255,0.2); color: white; font-size: 14px;">
                Sair
              </button>
            </div>
          </div>

          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-6xl mx-auto">
              <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                <div class="p-6 rounded-2xl" style="background: linear-gradient(135deg, ${config.card_color} 0%, ${config.background_color} 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">
                    Total Clientes
                  </p>
                  <p class="font-bold" style="font-size: 40px; color: ${config.primary_color};">
                    ${clients.length}
                  </p>
                </div>
                <div class="p-6 rounded-2xl" style="background: linear-gradient(135deg, ${config.card_color} 0%, ${config.background_color} 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">
                    Clientes Ativos
                  </p>
                  <p class="font-bold" style="font-size: 40px; color: ${config.success_color};">
                    ${activeClients.length}
                  </p>
                </div>
                <div class="p-6 rounded-2xl" style="background: linear-gradient(135deg, ${config.card_color} 0%, ${config.background_color} 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">
                    Clientes VIP
                  </p>
                  <p class="font-bold" style="font-size: 40px; color: ${config.vip_color};">
                    ${vipClients.length}
                  </p>
                </div>
                <div class="p-6 rounded-2xl" style="background: linear-gradient(135deg, ${config.card_color} 0%, ${config.background_color} 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">
                    Total Convidados
                  </p>
                  <p class="font-bold" style="font-size: 40px; color: ${config.text_color};">
                    ${totalGuests}
                  </p>
                </div>
                <div class="p-6 rounded-2xl" style="background: linear-gradient(135deg, ${config.card_color} 0%, ${config.background_color} 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">
                    Total Check-ins
                  </p>
                  <p class="font-bold" style="font-size: 40px; color: ${config.success_color};">
                    ${totalCheckins}
                  </p>
                </div>
              </div>

              <div class="mb-6 p-6 rounded-2xl" style="background-color: ${config.card_color}; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                <h2 class="font-bold mb-4" style="font-size: 20px; color: ${config.text_color};">
                  üìã Check-ins Recentes (√∫ltimos 10)
                </h2>
                <div class="space-y-2">
                  ${checkins
                    .slice(0, 10)
                    .map(checkin => {
                      const client = clients.find(c => c.id === checkin.client_id);
                      const guest = guests.find(g => g.qr_code === checkin.guest_qr);
                      return `
                        <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: ${config.background_color};">
                          <div class="flex-1">
                            <p class="font-bold flex items-center" style="font-size: 14px; color: ${config.text_color};">
                              ${guest && guest.is_vip ? '‚≠ê ' : ''}${checkin.guest_name}
                            </p>
                            <p class="opacity-70" style="font-size: 12px; color: ${config.text_color};">
                              ${client ? (client.is_vip ? '‚≠ê ' : '') + client.client_name : 'Cliente'} ‚Ä¢ ${new Date(checkin.checked_in_at).toLocaleString('pt-BR')}
                            </p>
                          </div>
                          <button 
                            onclick="undoCheckin('${checkin.id}')"
                            class="px-3 py-2 rounded-lg font-semibold transition-all"
                            style="background-color: rgba(239, 68, 68, 0.2); color: #ef4444; font-size: 12px;"
                          >
                            ‚Ü©Ô∏è Desfazer
                          </button>
                        </div>
                      `;
                    }).join('') || `
                      <p class="text-center opacity-70 py-4" style="font-size: 14px; color: ${config.text_color};">
                        Nenhum check-in realizado ainda
                      </p>
                    `}
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="showAddClientModal()" class="p-6 rounded-2xl font-bold transition-all transform hover:scale-[1.02] active:scale-95 flex items-center justify-center" style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); color: white; font-size: 18px; box-shadow: 0 10px 40px rgba(0, 127, 159, 0.3);">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                  Novo Cliente
                </button>
                <button onclick="showTrashModal()" class="p-6 rounded-2xl font-bold transition-all transform hover:scale-[1.02] active:scale-95 flex items-center justify-center" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; font-size: 18px; box-shadow: 0 10px 40px rgba(239, 68, 68, 0.3);">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                  üóëÔ∏è Lixeira
                </button>
              </div>

              <h2 class="font-bold mb-4" style="font-size: 28px; color: ${config.text_color};">
                Lista de Clientes
              </h2>
              
              <div class="space-y-3 mb-6">
                ${clients.length === 0 ? `
                  <div class="p-8 rounded-2xl text-center" style="background-color: ${config.card_color};">
                    <p class="opacity-70" style="font-size: 16px; color: ${config.text_color};">
                      Nenhum cliente cadastrado ainda
                    </p>
                  </div>
                ` : clients.map(client => {
                  const isExpired = parseInt(client.expiry) < Date.now();
                  const clientGuests = guests.filter(g => g.client_id === client.id);
                  const clientCheckins = checkins.filter(c => c.client_id === client.id);
                  
                  let timeInfo = '';
                  if (client.event_date) {
                    const eventDate = new Date(parseInt(client.event_date));
                    const timeUntilEvent = parseInt(client.event_date) - Date.now();
                    const daysUntil = Math.floor(timeUntilEvent / (1000 * 60 * 60 * 24));
                    const hoursUntil = Math.floor((timeUntilEvent % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    
                    if (timeUntilEvent > 0) {
                      timeInfo = `üéØ Evento em: ${eventDate.toLocaleString('pt-BR')} <span style="color: ${config.primary_color}; font-weight: 600;"> (faltam ${daysUntil}d ${hoursUntil}h)</span>`;
                    } else {
                      timeInfo = `üéØ Evento ocorreu em: ${eventDate.toLocaleString('pt-BR')}`;
                    }
                  } else {
                    const timeRemaining = parseInt(client.expiry) - Date.now();
                    const hoursRemaining = Math.floor(timeRemaining / (1000 * 60 * 60));
                    const daysRemaining = Math.floor(hoursRemaining / 24);
                    timeInfo = `‚è∞ ${isExpired ? 'Expirou em' : 'Expira em'}: ${new Date(parseInt(client.expiry)).toLocaleString('pt-BR')}`;
                    if (!isExpired) {
                      timeInfo += ` <span style="color: ${config.primary_color}; font-weight: 600;"> (${daysRemaining}d ${hoursRemaining % 24}h restantes)</span>`;
                    }
                  }

                  return `
                    <div class="p-6 rounded-2xl" style="background-color: ${config.card_color}; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                      <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                          <h3 class="font-bold mb-2 flex items-center gap-2" style="font-size: 20px; color: ${config.text_color};">
                            ${client.client_name}
                            ${client.is_vip ? `
                              <span class="px-3 py-1 rounded-full text-xs font-bold vip-badge" style="color: white;">
                                ‚≠ê VIP
                              </span>
                            ` : ''}
                            ${isExpired ? `
                              <span class="px-3 py-1 rounded-full text-xs" style="background-color: rgba(239, 68, 68, 0.2); color: #ef4444;">
                                üîí Expirado
                              </span>
                            ` : `
                              <span class="px-3 py-1 rounded-full text-xs" style="background-color: rgba(16, 185, 129, 0.2); color: ${config.success_color};">
                                ‚úì Ativo
                              </span>
                            `}
                          </h3>
                          <div class="flex flex-wrap gap-4 mb-3">
                            <p class="opacity-70" style="font-size: 14px; color: ${config.text_color};">
                              üé´ Token: <span class="font-mono font-bold" style="color: ${config.primary_color};">${client.token}</span>
                            </p>
                          </div>
                          <p class="opacity-70 mb-3" style="font-size: 14px; color: ${config.text_color};">
                            ${timeInfo}
                          </p>
                          <div class="flex gap-4">
                            <span class="px-3 py-1 rounded-lg text-sm font-semibold" style="background-color: rgba(59, 130, 246, 0.2); color: #3b82f6;">
                              üë• ${clientGuests.length} convidados
                            </span>
                            <span class="px-3 py-1 rounded-lg text-sm font-semibold" style="background-color: rgba(16, 185, 129, 0.2); color: ${config.success_color};">
                                 ${clientCheckins.length} check-ins
                            </span>
                          </div>
                        </div>
                        <div class="flex flex-col gap-2 ml-4">
                          <button onclick="showClientDetails('${client.id}')" class="px-4 py-2 rounded-lg font-semibold transition-all whitespace-nowrap" style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); color: white; font-size: 14px;">
                            üìã Ver Detalhes
                          </button>
                          <button onclick="exportClientPDF('${client.id}')" class="px-4 py-2 rounded-lg font-semibold transition-all whitespace-nowrap" style="background-color: #3b82f6; color: white; font-size: 14px;">
                            üìÑ Baixar PDF
                          </button>
                          <button onclick="showExtendTokenModal('${client.id}')" class="px-4 py-2 rounded-lg font-semibold transition-all whitespace-nowrap" style="background-color: #10b981; color: white; font-size: 14px;">
                            ‚è∞ Estender
                          </button>
                          <button onclick="toggleClientVIP('${client.id}')" class="px-4 py-2 rounded-lg font-semibold transition-all whitespace-nowrap" style="background-color: ${client.is_vip ? 'rgba(251, 191, 36, 0.3)' : 'rgba(148, 163, 184, 0.2)'}; color: ${client.is_vip ? config.vip_color : config.text_color}; font-size: 14px;">
                            ${client.is_vip ? '‚≠ê Remover VIP' : '‚≠ê Tornar VIP'}
                          </button>
                          ${clientCheckins.length > 0 ? `
                            <button onclick="showClearCheckinsConfirmation('${client.id}')" class="px-4 py-2 rounded-lg font-semibold transition-all whitespace-nowrap" style="background-color: rgba(251, 191, 36, 0.2); color: #f59e0b; font-size: 14px;">
                              üîÑ Limpar Check-ins
                            </button>
                          ` : ''}
                          <button onclick="showDeleteClientConfirmation('${client.id}')" class="px-4 py-2 rounded-lg font-semibold transition-all whitespace-nowrap" style="background-color: rgba(239, 68, 68, 0.2); color: #ef4444; font-size: 14px;">
                            üóëÔ∏è Deletar
                          </button>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>

          <div class="text-center py-6" style="background-color: ${config.card_color};">
            <p class="opacity-40" style="font-size: 12px; color: ${config.text_color};">
              Created By AdKira 2025
            </p>
          </div>
        </div>
      `;
    }

    // =============== CLIENT DASHBOARD ===============

    async function renderClientDashboard() {
      await loadClients();
      const client = clients.find(c => c.id === currentUser.id);
      
      if (!client || client.deleted || parseInt(client.expiry) < Date.now()) {
        clearSession('client');
        currentUser = null;
        currentView = 'login';
        showToast('‚ùå Sess√£o expirada ou desativada. Fa√ßa login novamente.', 'error');
        renderLogin();
        return;
      }
      
      if (currentTab === 'home') {
        await renderClientHome();
      } else if (currentTab === 'scanner') {
        await renderClientScanner();
      }
    }

    async function renderClientHome() {
      const client = clients.find(c => c.id === currentUser.id);
      if (!client) {
        logout();
        return;
      }

      const clientGuests = guests.filter(g => g.client_id === currentUser.id);
      const clientCheckins = checkins.filter(c => c.client_id === currentUser.id);

      let timeInfo = '';
      if (client.event_date) {
        const eventDate = new Date(parseInt(client.event_date));
        const timeUntilEvent = parseInt(client.event_date) - Date.now();
        const daysUntil = Math.floor(timeUntilEvent / (1000 * 60 * 60 * 24));
        const hoursUntil = Math.floor((timeUntilEvent % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        
        if (timeUntilEvent > 0) {
          timeInfo = `üéØ Evento em: <span class="font-bold">${daysUntil}d ${hoursUntil}h</span>`;
        } else {
          timeInfo = `üéØ Evento ocorreu em: ${eventDate.toLocaleDateString('pt-BR')}`;
        }
      } else {
        const timeRemaining = parseInt(client.expiry) - Date.now();
        const hoursRemaining = Math.floor(timeRemaining / (1000 * 60 * 60));
        const daysRemaining = Math.floor(hoursRemaining / 24);
        timeInfo = `‚è∞ Token expira em: <span class="font-bold">${daysRemaining}d ${hoursRemaining % 24}h</span>`;
      }

      const uniqueCheckins = clientCheckins.filter(c => !c.is_companion_only).length;

      document.getElementById('app').innerHTML = `
        <div class="min-h-full flex flex-col" style="background-color: ${config.background_color};">
          <div class="p-4" style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h1 class="font-bold mb-1 flex items-center gap-2" style="font-size: 28px; color: white;">
                  ${config.app_title}
                  ${client.is_vip ? `<span class="px-2 py-1 rounded-full text-sm font-bold vip-badge" style="color: white;">‚≠ê VIP</span>` : ''}
                  <span class="inline-block w-3 h-3 rounded-full animate-pulse-slow" style="background-color: #10b981;"></span>
                </h1>
                <p style="font-size: 14px; color: rgba(255,255,255,0.9);">
                  ${currentUser.name}
                </p>
              </div>
              <button onclick="logout()" class="px-4 py-2 rounded-lg font-semibold transition-all" style="background-color: rgba(255,255,255,0.2); color: white; font-size: 14px;">
                Sair
              </button>
            </div>
            <div class="px-3 py-2 rounded-lg" style="background-color: rgba(255,255,255,0.15);">
              <p style="font-size: 14px; color: white;">
                ${timeInfo}
              </p>
            </div>
          </div>

          <div class="flex border-b" style="background-color: ${config.card_color}; border-color: ${config.background_color};">
            <button onclick="switchClientTab('home')" class="tab-button flex-1 py-4 font-semibold active" style="color: ${config.text_color}; font-size: 14px;">
              üè† In  cio
            </button>
            <button onclick="switchClientTab('scanner')" class="tab-button flex-1 py-4 font-semibold" style="color: ${config.text_color}; font-size: 14px;">
              üì∑ Scanner
            </button>
          </div>

          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-4xl mx-auto">
              <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-6 rounded-2xl text-center" style="background: linear-gradient(135deg, ${config.card_color} 0%, ${config.background_color} 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">
                    Convidados
                  </p>
                  <p class="font-bold" style="font-size: 32px; color: ${config.primary_color};">
                    ${clientGuests.length}
                  </p>
                </div>
                <div class="p-6 rounded-2xl text-center" style="background: linear-gradient(135deg, ${config.card_color} 0%, ${config.background_color} 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">
                    Check-ins
                  </p>
                  <p class="font-bold" style="font-size: 32px; color: ${config.success_color};">
                    ${uniqueCheckins}
                  </p>
                </div>
              </div>

              <div class="flex items-center justify-between mb-4">
                <h2 class="font-bold" style="font-size: 24px; color: ${config.text_color};">
                  Lista de Convidados
                </h2>
              </div>

              <div class="mb-4">
                <input 
                  type="text" 
                  id="guest-search-input"
                  placeholder="üîç Pesquisar convidado por nome..."
                  class="w-full px-4 py-3 rounded-xl outline-none"
                  style="background-color: ${config.card_color}; color: ${config.text_color}; font-size: 16px; border: 2px solid ${config.primary_color};"
                  oninput="searchGuests(this.value)"
                >
              </div>

              <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                <button onclick="filterGuests('all')" id="filter-all" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap transition-all" style="background-color: ${config.primary_color}; color: white; font-size: 14px;">
                  Todos (${clientGuests.length})
                </button>
                <button onclick="filterGuests('checked-in')" id="filter-checked-in" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap transition-all" style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 14px;">
                  Entraram (${uniqueCheckins})
                </button>
                <button onclick="filterGuests('pending')" id="filter-pending" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap transition-all" style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 14px;">
                  Pendentes (${clientGuests.length - uniqueCheckins})
                </button>
                <button onclick="filterGuests('vip')" id="filter-vip" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap transition-all" style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 14px;">
                  VIP (${clientGuests.filter(g => g.is_vip).length})
                </button>
                <button onclick="filterGuests('companion')" id="filter-companion" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap transition-all" style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 14px;">
                  Com Acompanhante (${clientGuests.filter(g => g.has_companion).length})
                </button>
              </div>
              
              <div id="guests-list" class="space-y-3 mb-6">
                ${renderGuestsList(clientGuests, clientCheckins)}
              </div>
            </div>
          </div>

          <div class="text-center py-6" style="background-color: ${config.card_color};">
            <p class="opacity-40" style="font-size: 12px; color: ${config.text_color};">
              Created By AdKira 2025
            </p>
          </div>
        </div>
      `;
    }

    function renderGuestsList(filteredGuests, clientCheckins) {
      const sortedGuests = [...filteredGuests].sort((a, b) => {
        const aCheckin = clientCheckins.find(c => c.guest_qr === a.qr_code && !c.is_companion_only);
        const bCheckin = clientCheckins.find(c => c.guest_qr === b.qr_code && !c.is_companion_only);
        
        if (aCheckin && !bCheckin) return -1;
        if (!aCheckin && bCheckin) return 1;
        if (aCheckin && bCheckin) {
          return new Date(bCheckin.checked_in_at) - new Date(aCheckin.checked_in_at);
        }
        return 0;
      });

      if (sortedGuests.length === 0) {
        return `
          <div class="p-8 rounded-2xl text-center" style="background-color: ${config.card_color};">
            <p class="opacity-70" style="font-size: 16px; color: ${config.text_color};">
              Nenhum convidado encontrado
            </p>
          </div>
        `;
      }

      return sortedGuests.map(guest => {
        const guestCheckins = clientCheckins.filter(c => c.guest_qr === guest.qr_code);
        const hasCheckedIn = guestCheckins.length > 0;
        const mainCheckin = guestCheckins.find(c => !c.is_companion_only);
        const companionCheckin = guestCheckins.find(c => c.is_companion_only);

        return `
          <div class="p-4 rounded-xl" style="background-color: ${config.card_color}; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <h3 class="font-bold mb-2 flex items-center gap-2" style="font-size: 18px; color: ${config.text_color};">
                  ${guest.is_vip ? `<span class="px-2 py-1 rounded text-xs font-bold vip-badge" style="color: white;">‚≠ê</span>` : ''}
                  ${guest.name}
                  ${guest.has_companion ? `<span class="opacity-70 text-xs">üë•</span>` : ''}
                </h3>
                ${mainCheckin ? `
                  <p class="font-semibold mb-1" style="font-size: 12px; color: ${config.success_color};">
                    ‚úÖ Check-in: ${new Date(mainCheckin.checked_in_at).toLocaleString('pt-BR')}
                    ${mainCheckin.with_companion ? ' (Com acompanhante)' : guest.has_companion ? ' (Sem acompanhante)' : ''}
                  </p>
                ` : ''}
                ${companionCheckin ? `
                  <p class="font-semibold" style="font-size: 12px; color: ${config.success_color};">
                    ‚úÖ Acompanhante: ${new Date(companionCheckin.checked_in_at).toLocaleString('pt-BR')}
                  </p>
                ` : ''}
              </div>
              ${hasCheckedIn ? `
                <span class="px-4 py-2 rounded-lg font-bold" style="background-color: rgba(16, 185, 129, 0.2); color: ${config.success_color};">
                  ‚úì
                </span>
              ` : `
                <span class="px-4 py-2 rounded-lg font-semibold opacity-50" style="background-color: ${config.background_color}; color: ${config.text_color};">
                  Pendente
                </span>
              `}
            </div>
          </div>
        `;
      }).join('');
    }

    function searchGuests(query) {
      currentSearchQuery = query.toLowerCase();
      updateGuestsList();
    }

    async function filterGuests(filterType) {
      currentFilter = filterType;
      
      document.querySelectorAll('[id^="filter-"]').forEach(btn => {
        btn.style.backgroundColor = config.background_color;
        btn.style.color = config.text_color;
      });
      
      const activeBtn = document.getElementById('filter-' + filterType);
      if (activeBtn) {
        activeBtn.style.backgroundColor = config.primary_color;
        activeBtn.style.color = 'white';
      }
      
      updateGuestsList();
    }

    function updateGuestsList() {
      const clientGuests = guests.filter(g => g.client_id === currentUser.id);
      const clientCheckins = checkins.filter(c => c.client_id === currentUser.id);
      
      let filteredGuests = clientGuests;
      
      if (currentFilter === 'checked-in') {
        filteredGuests = filteredGuests.filter(g => clientCheckins.some(c => c.guest_qr === g.qr_code && !c.is_companion_only));
      } else if (currentFilter === 'pending') {
        filteredGuests = filteredGuests.filter(g => !clientCheckins.some(c => c.guest_qr === g.qr_code && !c.is_companion_only));
      } else if (currentFilter === 'vip') {
        filteredGuests = filteredGuests.filter(g => g.is_vip);
      } else if (currentFilter === 'companion') {
        filteredGuests = filteredGuests.filter(g => g.has_companion);
      }
      
      if (currentSearchQuery) {
        filteredGuests = filteredGuests.filter(g => 
          g.name.toLowerCase().includes(currentSearchQuery) ||
          g.qr_code.toLowerCase().includes(currentSearchQuery)
        );
      }
      
      const guestsList = document.getElementById('guests-list');
      if (guestsList) {
        guestsList.innerHTML = renderGuestsList(filteredGuests, clientCheckins);
      }
    }

    // =============== SCANNER ===============

    async function renderClientScanner() {
      document.getElementById('app').innerHTML = `
        <div class="h-full flex flex-col" style="background-color: ${config.background_color};">
          <div class="p-3 flex items-center justify-between" style="background-color: ${config.card_color};">
            <button onclick="switchClientTab('home')" class="px-3 py-2 rounded-lg font-semibold" style="background-color: ${config.primary_color}; color: white; font-size: 14px;">
              ‚Üê Voltar
            </button>
            <h1 class="font-bold" style="font-size: 20px; color: ${config.text_color};">
              Scanner QR Code
            </h1>
            <button onclick="logout()" class="px-3 py-2 rounded-lg font-semibold" style="background-color: rgba(239, 68, 68, 0.2); color: #ef4444; font-size: 14px;">
              Sair
            </button>
          </div>

          <div class="flex-1 flex flex-col" style="background-color: #000;">
            <div id="qr-reader" class="flex-1"></div>
            
            <div class="p-4 space-y-3" style="background-color: ${config.card_color};">
              <p class="text-center opacity-70" style="font-size: 14px; color: ${config.text_color};">
                üì∑ Aponte a c√¢mera para o QR Code do convidado
              </p>
              <p class="text-center opacity-40" style="font-size: 11px; color: ${config.text_color};">
                Created By AdKira 2025
              </p>
            </div>
          </div>
        </div>
      `;

      setTimeout(() => {
        startQrScanner();
      }, 100);
    }

    function startQrScanner() {
      if (html5QrCode) {
        html5QrCode.stop().catch(() => {});
      }

      html5QrCode = new Html5Qrcode("qr-reader");

      html5QrCode.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: { width: 250, height: 250 }
        },
        (decodedText, decodedResult) => {
          processQrCode(decodedText);
        }
      ).catch(err => {
        showToast('Erro ao acessar c√¢mera', 'error');
        console.error(err);
      });
    }

    async function processQrCode(qrCode) {
      if (!qrCode) return;

      if (html5QrCode) {
        html5QrCode.pause(true);
      }

      await loadClients();
      const client = clients.find(c => c.id === currentUser.id);
      
      if (!client || client.deleted || parseInt(client.expiry) < Date.now()) {
        showErrorAnimation('ACESSO NEGADO', 'Token expirado ou desativado');
        playErrorSound();
        setTimeout(() => {
          logout();
        }, 2000);
        return;
      }

      const cleanCode = qrCode.includes(',') ? qrCode.split(',')[0].trim() : qrCode.trim();

      const clientGuests = guests.filter(g => g.client_id === currentUser.id);
      const guest = clientGuests.find(g => g.qr_code === cleanCode);

      if (!guest) {
        showErrorAnimation('ENTRADA N√ÉO PERMITIDA', 'Convidado n√£o encontrado');
        playErrorSound();
        setTimeout(() => {
          if (html5QrCode) html5QrCode.resume();
        }, 2500);
        return;
      }

      const clientCheckins = checkins.filter(c => c.client_id === currentUser.id);
      const existingCheckins = clientCheckins.filter(c => c.guest_qr === cleanCode);

      if (existingCheckins.length > 0 && (!guest.has_companion || existingCheckins.length >= 2)) {
        showErrorAnimation('ENTRADA N√ÉO PERMITIDA', 'Este convite j√° foi usado');
        playErrorSound();
        setTimeout(() => {
          if (html5QrCode) html5QrCode.resume();
        }, 2500);
        return;
      }

      if (guest.has_companion && existingCheckins.length === 1) {
        showCompanionConfirmation(guest, cleanCode);
        return;
      }

      if (guest.has_companion && existingCheckins.length === 0) {
        showCompanionEntryConfirmation(guest, cleanCode);
      } else {
        await performCheckin(guest, cleanCode, false, false);
      }
    }

    function showCompanionEntryConfirmation(guest, cleanCode) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8 text-center" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
          <div class="text-6xl mb-4">üë•</div>
          <h2 class="font-bold mb-2 flex items-center justify-center gap-2" style="font-size: 24px; color: ${config.text_color};">
            ${guest.is_vip ? `<span class="px-2 py-1 rounded text-sm font-bold vip-badge" style="color: white;">‚≠ê</span>` : ''}
            ${guest.name}
          </h2>
          <p class="mb-6 opacity-70" style="font-size: 16px; color: ${config.text_color};">
            Este convidado tem direito a acompanhante.<br>Entrou com acompanhante?
          </p>
          <div class="flex gap-3">
            <button 
              onclick="confirmCompanionEntry('${cleanCode}', false)"
              class="flex-1 py-4 rounded-xl font-bold"
              style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 18px;"
            >
              N√ÉO<br><span style="font-size: 12px; opacity: 0.7;">(S√≥ o convidado)</span>
            </button>
            <button 
              onclick="confirmCompanionEntry('${cleanCode}', true)"
              class="flex-1 py-4 rounded-xl font-bold"
              style="background: linear-gradient(135deg, ${config.success_color} 0%, #059669 100%); color: white; font-size: 18px;"
            >
              SIM<br><span style="font-size: 12px; opacity: 0.9;">(Convidado + Acompanhante)</span>
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function showCompanionConfirmation(guest, cleanCode) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8 text-center" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
          <div class="text-6xl mb-4">üë§</div>
          <h2 class="font-bold mb-2" style="font-size: 24px; color: ${config.text_color};">
            Acompanhante de ${guest.name}
          </h2>
          <p class="mb-6 opacity-70" style="font-size: 16px; color: ${config.text_color};">
            O convidado principal j√° entrou.<br>Esta √© a entrada do acompanhante?
          </p>
          <div class="flex gap-3">
            <button 
              onclick="cancelCompanionEntry()"
              class="flex-1 py-4 rounded-xl font-bold"
              style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 18px;"
            >
              Cancelar
            </button>
            <button 
              onclick="confirmCompanionEntry('${cleanCode}', true, true)"
              class="flex-1 py-4 rounded-xl font-bold"
              style="background: linear-gradient(135deg, ${config.success_color} 0%, #059669 100%); color: white; font-size: 18px;"
            >
              SIM, Confirmar
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function confirmCompanionEntry(cleanCode, withCompanion, isCompanionOnly = false) {
      const modalEl = document.querySelector('.modal-overlay');
      if (modalEl) modalEl.remove();
      
      const clientGuests = guests.filter(g => g.client_id === currentUser.id);
      const guest = clientGuests.find(g => g.qr_code === cleanCode);
      
      await performCheckin(guest, cleanCode, withCompanion, isCompanionOnly);
    }

    function cancelCompanionEntry() {
      const modalEl = document.querySelector('.modal-overlay');
      if (modalEl) modalEl.remove();
      setTimeout(() => {
        if (html5QrCode) html5QrCode.resume();
      }, 500);
    }

    async function performCheckin(guest, cleanCode, withCompanion, isCompanionOnly) {
      const checkinData = {
        id: generateId('checkin'),
        client_id: currentUser.id,
        guest_id: guest.id,
        guest_qr: cleanCode,
        guest_name: guest.name,
        with_companion: withCompanion,
        is_companion_only: isCompanionOnly,
        status: 'confirmed',
        checked_in_at: new Date().toISOString(),
        synced: isOnline
      };

      let success = false;

      if (isOnline) {
        const result = await createCheckin(checkinData);
        success = result.success;
        
        if (!success) {
          isOnline = false;
          offlineQueue.push(checkinData);
          saveOfflineQueue();
          success = true;
        }
      } else {
        offlineQueue.push(checkinData);
        saveOfflineQueue();
        success = true;
      }

      if (success) {
        let displayMessage = '';
        if (isCompanionOnly) {
          displayMessage = 'Acompanhante de ' + guest.name;
        } else if (withCompanion) {
          displayMessage = guest.name + ' e Acompanhante';
        } else {
          displayMessage = guest.name;
        }
        
        if (guest.is_vip) {
          displayMessage = '‚≠ê VIP - ' + displayMessage;
        }
        
        showSuccessAnimation('ENTRADA APROVADA', displayMessage, !isOnline);
        playSuccessSound();
        vibrateDevice();
        
        setTimeout(() => {
          if (html5QrCode) html5QrCode.resume();
        }, 3000);
      } else {
        showErrorAnimation('ENTRADA N√ÉO PERMITIDA', 'Erro do sistema');
        playErrorSound();
        setTimeout(() => {
          if (html5QrCode) html5QrCode.resume();
        }, 2500);
      }
    }

    function showSuccessAnimation(title, guestName, isOffline = false) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.zIndex = '10000';
      
      overlay.innerHTML = `
        <div class="text-center animate-slide-in">
          <div class="text-8xl mb-6">‚úÖ</div>
          <div class="font-bold mb-3" style="font-size: 32px; color: ${config.success_color}; text-shadow: 0 2px 10px rgba(16, 185, 129, 0.5);">
            ${title}
          </div>
          <div class="font-bold mb-2" style="font-size: 28px; color: white;">
            ${guestName}
          </div>
          ${isOffline ? `
            <div class="font-semibold" style="font-size: 14px; color: #f59e0b;">
              [OFFLINE - Ser√° sincronizado]
            </div>
          ` : ''}
          <div id="confetti-container"></div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      const container = overlay.querySelector('#confetti-container');
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.textContent = ['üéâ', 'üéä', '   ', '‚≠ê', 'üåü'][Math.floor(Math.random() * 5)];
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.fontSize = (Math.random() * 20 + 20) + 'px';
        confetti.style.animationDelay = (Math.random() * 0.5) + 's';
        container.appendChild(confetti);
      }
      
      setTimeout(() => {
        overlay.remove();
      }, 3000);
    }

    function showErrorAnimation(title, message) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.zIndex = '10000';
      
      overlay.innerHTML = `
        <div class="text-center animate-slide-in">
          <div class="text-8xl mb-6">‚ùå</div>
          <div class="font-bold mb-3" style="font-size: 32px; color: ${config.error_color}; text-shadow: 0 2px 10px rgba(239, 68, 68, 0.5);">
            ${title}
          </div>
          <div class="font-semibold" style="font-size: 20px; color: white; opacity: 0.9;">
            ${message}
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      setTimeout(() => {
        overlay.remove();
      }, 2500);
    }

    function playSuccessSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (e) {
        console.log('Audio not supported');
      }
    }

    function playErrorSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 200;
        oscillator.type = 'sawtooth';
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      } catch (e) {
        console.log('Audio not supported');
      }
    }

    function vibrateDevice() {
      if ('vibrate' in navigator) {
        navigator.vibrate(200);
      }
    }

    // =============== ADMIN MODAL FUNCTIONS ===============

    async function showAddClientModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'add-client-modal';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto;">
          <h2 class="font-bold mb-6" style="font-size: 28px; color: ${config.text_color};">
            ‚ûï Novo Cliente
          </h2>
          <form onsubmit="submitNewClient(event); return false;">
            <div class="mb-4">
              <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                Nome do Cliente
              </label>
              <input 
                type="text" 
                name="client_name" 
                required 
                class="w-full px-4 py-3 rounded-xl outline-none"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
                placeholder="Digite o nome do cliente"
              >
            </div>
            
            <div class="mb-4">
              <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                Tipo de Controle
              </label>
              <select 
                name="control_type" 
                id="control-type-select"
                onchange="toggleControlType(this.value)"
                class="w-full px-4 py-3 rounded-xl outline-none"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
              >
                <option value="expiry">Token com Validade</option>
                <option value="event">Data do Evento</option>
              </select>
            </div>

            <div id="expiry-fields">
              <div class="mb-4">
                <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                  Validade do Token (dias)
                </label>
                <input 
                  type="number" 
                  name="expiry_days" 
                  min="1"
                  value="30"
                  class="w-full px-4 py-3 rounded-xl outline-none"
                  style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
                >
              </div>
            </div>

            <div id="event-fields" style="display: none;">
              <div class="mb-4">
                <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                  Data e Hora do Evento
                </label>
                <input 
                  type="datetime-local" 
                  name="event_datetime"
                  class="w-full px-4 py-3 rounded-xl outline-none"
                  style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
                >
              </div>
            </div>

            <div class="mb-4">
              <label class="flex items-center">
                <input type="checkbox" name="is_vip" class="mr-2">
                <span style="font-size: 14px; color: ${config.text_color};">
                  ‚≠ê Marcar como Cliente VIP
                </span>
              </label>
            </div>

            <div class="mb-4">
              <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                üìã Lista de Convidados (1 por linha)
              </label>
              <div class="mb-2 p-3 rounded-lg" style="background-color: ${config.background_color};">
                <p class="mb-1" style="font-size: 12px; color: ${config.text_color};">
                  <strong>Como funciona:</strong>
                </p>
                <ul class="list-disc list-inside" style="font-size: 11px; color: ${config.text_color}; opacity: 0.8;">
                  <li>O sistema ignora c√≥digos no in√≠cio</li>
                  <li>Detecta automaticamente nomes com " e " (acompanhante)</li>
                  <li>Exemplo: "1, Jo√£o Silva e Esposa" ‚Üí Jo√£o tem acompanhante</li>
                  <li><strong>Voc√™ pode fazer upload de M√öLTIPLOS arquivos de uma vez!</strong></li>
                </ul>
              </div>
              
              <div class="mb-3">
                <input 
                  type="file" 
                  id="guest-list-file"
                  accept=".txt"
                  multiple
                  class="hidden"
                  onchange="handleGuestListFile(event)"
                >
                <button 
                  type="button"
                  onclick="document.getElementById('guest-list-file').click()"
                  class="w-full py-3 rounded-xl font-semibold mb-2"
                  style="background-color: ${config.primary_color}; color: white; font-size: 14px;"
                >
                  üì§ Fazer Upload de Arquivo(s) .txt
                </button>
                <p class="text-center opacity-70 mb-2" style="font-size: 12px; color: ${config.text_color};">
                  ou cole a lista abaixo:
                </p>
              </div>
              
              <textarea 
                name="guest_list" 
                id="guest-list-textarea"
                rows="8"
                class="w-full px-4 py-3 rounded-xl outline-none font-mono"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 13px;"
                placeholder="1, Edvandro Borges e Esposa&#10;2, Helena Fernandes e Acompanhante&#10;3, Hamilton e Mila&#10;4, J√©ssica Leonarda&#10;..."
              ></textarea>
              <p class="mt-2 opacity-70" style="font-size: 12px; color: ${config.text_color};">
                üí° Voc√™ pode adicionar mais convidados depois
              </p>
            </div>

            <div class="flex gap-3">
              <button 
                type="button"
                onclick="closeModal('add-client-modal')"
                class="flex-1 py-3 rounded-xl font-semibold"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
              >
                Cancelar
              </button>
              <button 
                type="submit"
                class="flex-1 py-3 rounded-xl font-semibold"
                style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); color: white; font-size: 16px;"
              >
                Criar Cliente
              </button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function toggleControlType(type) {
      const expiryFields = document.getElementById('expiry-fields');
      const eventFields = document.getElementById('event-fields');
      
      if (type === 'expiry') {
        expiryFields.style.display = 'block';
        eventFields.style.display = 'none';
        document.querySelector('[name="expiry_days"]').required = true;
        document.querySelector('[name="event_datetime"]').required = false;
      } else {
        expiryFields.style.display = 'none';
        eventFields.style.display = 'block';
        document.querySelector('[name="expiry_days"]').required = false;
        document.querySelector('[name="event_datetime"]').required = true;
      }
    }

    async function submitNewClient(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const clientName = formData.get('client_name');
      const controlType = formData.get('control_type');
      const isVIP = formData.get('is_vip') === 'on';
      const guestListRaw = formData.get('guest_list');
      
      const clientData = {
        id: generateId('client'),
        client_name: clientName,
        token: generateToken(),
        is_vip: isVIP,
        deleted: false,
        deleted_at: null,
        created_at: new Date().toISOString()
      };

      if (controlType === 'expiry') {
        const expiryDays = parseInt(formData.get('expiry_days'));
        clientData.expiry = (Date.now() + (expiryDays * 24 * 60 * 60 * 1000)).toString();
        clientData.event_date = null;
      } else {
        const eventDatetime = formData.get('event_datetime');
        const eventDate = new Date(eventDatetime);
        clientData.event_date = eventDate.getTime().toString();
        clientData.expiry = eventDate.getTime().toString();
      }
      
      const resultClient = await createClient(clientData);
      
      if (!resultClient.success) {
        showToast('‚ùå Erro ao criar cliente', 'error');
        return;
      }

      // Processar lista de convidados
      if (guestListRaw && guestListRaw.trim()) {
        const parsedGuests = parseGuestList(guestListRaw);
        
        if (parsedGuests.length > 0) {
          const guestsToCreate = parsedGuests.map(pg => ({
            id: generateId('guest'),
            client_id: clientData.id,
            name: pg.name,
            qr_code: generateId('QR'),
            has_companion: pg.has_companion,
            is_vip: false,
            deleted: false,
            deleted_at: null,
            created_at: new Date().toISOString()
          }));
          
          const resultGuests = await createMultipleGuests(guestsToCreate);
          
          if (resultGuests.success) {
            showToast(`‚úÖ Cliente criado com ${resultGuests.count} convidados!`, 'success');
          } else {
            showToast('‚ö†Ô∏è Cliente criado, mas houve erro ao adicionar convidados', 'warning');
          }
        } else {
          showToast('‚úÖ Cliente criado com sucesso!', 'success');
        }
      } else {
        showToast('‚úÖ Cliente criado com sucesso!', 'success');
      }
      
      closeModal('add-client-modal');
      await renderAdminDashboard();
    }

    async function showClientDetails(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (!client) return;
      
      const clientGuests = guests.filter(g => g.client_id === clientId);
      const clientCheckins = checkins.filter(c => c.client_id === clientId);
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'client-details-modal';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto;">
          <h2 class="font-bold mb-6 flex items-center gap-2" style="font-size: 28px; color: ${config.text_color};">
            üìã ${client.client_name}
            ${client.is_vip ? `<span class="px-3 py-1 rounded-full text-sm font-bold vip-badge" style="color: white;">‚≠ê VIP</span>` : ''}
          </h2>
          
          <div class="mb-6 space-y-3">
            <p style="font-size: 14px; color: ${config.text_color};">
              <strong>Token:</strong> <span class="font-mono" style="color: ${config.primary_color};">${client.token}</span>
            </p>
            <p style="font-size: 14px; color: ${config.text_color};">
              <strong>Total Convidados:</strong> ${clientGuests.length} ${clientGuests.filter(g => g.is_vip).length > 0 ? `(${clientGuests.filter(g => g.is_vip).length} VIP)` : ''}
            </p>
            <p style="font-size: 14px; color: ${config.text_color};">
              <strong>Total Check-ins:</strong> ${clientCheckins.length}
            </p>
            
            <div class="grid grid-cols-2 gap-3">
              <button onclick="showAddGuestModal('${clientId}')" class="py-3 rounded-xl font-semibold" style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); color: white; font-size: 16px;">
                ‚ûï Adicionar Convidado
              </button>
              <button onclick="showUploadGuestListModal('${clientId}')" class="py-3 rounded-xl font-semibold" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 16px;">
                üì§ Fazer Upload de Lista
              </button>
            </div>
          </div>
          
          <h3 class="font-bold mb-3" style="font-size: 20px; color: ${config.text_color};">
            Lista de Convidados
          </h3>
          
          <div class="space-y-2 mb-6">
            ${clientGuests.length === 0 ? `
              <p class="text-center opacity-70 py-4" style="font-size: 14px; color: ${config.text_color};">
                Nenhum convidado cadastrado
              </p>
            ` : clientGuests.map(guest => {
              const guestCheckins = clientCheckins.filter(c => c.guest_qr === guest.qr_code);
              const hasCheckedIn = guestCheckins.length > 0;
              
              return `
                <div class="p-3 rounded-lg" style="background-color: ${config.background_color};">
                  <div class="flex items-center justify-between">
                    <div class="flex-1">
                      <p class="font-bold flex items-center gap-2" style="font-size: 14px; color: ${config.text_color};">
                        ${guest.is_vip ? `<span class="px-2 py-1 rounded text-xs font-bold vip-badge" style="color: white;">‚≠ê</span>` : ''}
                        ${guest.name}
                        ${guest.has_companion ? `<span class="opacity-70 text-xs">üë•</span>` : ''}
                      </p>
                      <p class="opacity-70 font-mono text-xs" style="color: ${config.text_color};">
                        ${guest.qr_code}
                      </p>
                    </div>
                    <div class="flex gap-2">
                      ${hasCheckedIn ? `
                        <span class="px-3 py-1 rounded-lg text-xs font-semibold" style="background-color: rgba(16, 185, 129, 0.2); color: ${config.success_color};">
                          ‚úì Entrou
                        </span>
                      ` : ''}
                      <button onclick="toggleGuestVIP('${guest.id}')" class="px-3 py-1 rounded-lg text-xs font-semibold" style="background-color: ${guest.is_vip ? 'rgba(251, 191, 36, 0.3)' : 'rgba(148, 163, 184, 0.2)'}; color: ${guest.is_vip ? config.vip_color : config.text_color};">
                        ${guest.is_vip ? '‚≠ê' : '‚òÜ'}
                      </button>
                      <button onclick="showDeleteGuestConfirmation('${guest.id}')" class="px-3 py-1 rounded-lg text-xs font-semibold" style="background-color: rgba(239, 68, 68, 0.2); color: #ef4444;">
                        üóëÔ∏è
                      </button>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          
          <button 
            onclick="closeModal('client-details-modal')"
            class="w-full py-3 rounded-xl font-semibold"
            style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
          >
            Fechar
          </button>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function showAddGuestModal(clientId) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'add-guest-modal';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
          <h2 class="font-bold mb-6" style="font-size: 28px; color: ${config.text_color};">
            ‚ûï Novo Convidado
          </h2>
          <form onsubmit="submitNewGuest(event, '${clientId}'); return false;">
            <div class="mb-4">
              <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                Nome do Convidado
              </label>
              <input 
                type="text" 
                name="guest_name" 
                required 
                class="w-full px-4 py-3 rounded-xl outline-none"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
                placeholder="Digite o nome do convidado"
              >
            </div>
            <div class="mb-4">
              <label class="flex items-center">
                <input type="checkbox" name="has_companion" class="mr-2">
                <span style="font-size: 14px; color: ${config.text_color};">
                  üë• Este convidado tem direito a acompanhante
                </span>
              </label>
            </div>
            <div class="mb-6">
              <label class="flex items-center">
                <input type="checkbox" name="is_vip" class="mr-2">
                <span style="font-size: 14px; color: ${config.text_color};">
                  ‚≠ê Marcar como Convidado VIP
                </span>
              </label>
            </div>
            <div class="flex gap-3">
              <button 
                type="button"
                onclick="closeModal('add-guest-modal')"
                class="flex-1 py-3 rounded-xl font-semibold"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
              >
                Cancelar
              </button>
              <button 
                type="submit"
                class="flex-1 py-3 rounded-xl font-semibold"
                style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); color: white; font-size: 16px;"
              >
                Adicionar
              </button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function submitNewGuest(event, clientId) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const guestName = formData.get('guest_name');
      const hasCompanion = formData.get('has_companion') === 'on';
      const isVIP = formData.get('is_vip') === 'on';
      
      const guestData = {
        id: generateId('guest'),
        client_id: clientId,
        name: guestName,
        qr_code: generateId('QR'),
        has_companion: hasCompanion,
        is_vip: isVIP,
        deleted: false,
        deleted_at: null,
        created_at: new Date().toISOString()
      };
      
      const result = await createGuest(guestData);
      
      if (result.success) {
        showToast('‚úÖ Convidado adicionado com sucesso!', 'success');
        closeModal('add-guest-modal');
        closeModal('client-details-modal');
        await showClientDetails(clientId);
      } else {
        showToast('‚ùå Erro ao adicionar convidado', 'error');
      }
    }

    function showUploadGuestListModal(clientId) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'upload-guest-list-modal';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto;">
          <h2 class="font-bold mb-6" style="font-size: 28px; color: ${config.text_color};">
            üì§ Upload de Lista de Convidados
          </h2>
          
          <form onsubmit="submitUploadGuestList(event, '${clientId}'); return false;">
            <div class="mb-4">
              <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                üìã Lista de Convidados (1 por linha)
              </label>
              <div class="mb-2 p-3 rounded-lg" style="background-color: ${config.background_color};">
                <p class="mb-1" style="font-size: 12px; color: ${config.text_color};">
                  <strong>Como funciona:</strong>
                </p>
                <ul class="list-disc list-inside" style="font-size: 11px; color: ${config.text_color}; opacity: 0.8;">
                  <li>O sistema ignora c√≥digos no in√≠cio</li>
                  <li>Detecta automaticamente nomes com " e " (acompanhante)</li>
                  <li>Exemplo: "1, Jo√£o Silva e Esposa" ‚Üí Jo√£o tem acompanhante</li>
                  <li><strong>Se detectar lista duplicada, perguntar√° se deseja substituir</strong></li>
                </ul>
              </div>
              
              <div class="mb-3">
                <input 
                  type="file" 
                  id="upload-guest-list-file"
                  accept=".txt"
                  multiple
                  class="hidden"
                  onchange="handleUploadGuestListFile(event)"
                >
                <button 
                  type="button"
                  onclick="document.getElementById('upload-guest-list-file').click()"
                  class="w-full py-3 rounded-xl font-semibold mb-2"
                  style="background-color: ${config.primary_color}; color: white; font-size: 14px;"
                >
                  üì§ Fazer Upload de Arquivo(s) .txt
                </button>
                <p class="text-center opacity-70 mb-2" style="font-size: 12px; color: ${config.text_color};">
                  ou cole a lista abaixo:
                </p>
              </div>
              
              <textarea 
                name="guest_list" 
                id="upload-guest-list-textarea"
                rows="8"
                required
                class="w-full px-4 py-3 rounded-xl outline-none font-mono"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 13px;"
                placeholder="1, Edvandro Borges e Esposa&#10;2, Helena Fernandes e Acompanhante&#10;3, Hamilton e Mila&#10;4, J√©ssica Leonarda&#10;..."
              ></textarea>
            </div>

            <div class="flex gap-3">
              <button 
                type="button"
                onclick="closeModal('upload-guest-list-modal')"
                class="flex-1 py-3 rounded-xl font-semibold"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
              >
                Cancelar
              </button>
              <button 
                type="submit"
                class="flex-1 py-3 rounded-xl font-semibold"
                style="background: linear-gradient(135deg, ${config.success_color} 0%, #059669 100%); color: white; font-size: 16px;"
              >
                Processar Lista
              </button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function handleUploadGuestListFile(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;
      
      // Verificar se todos os arquivos s√£o .txt
      const invalidFiles = Array.from(files).filter(file => !file.name.endsWith('.txt'));
      if (invalidFiles.length > 0) {
        showToast('‚ùå Por favor, selecione apenas arquivos .txt', 'error');
        event.target.value = '';
        return;
      }
      
      const textarea = document.getElementById('upload-guest-list-textarea');
      if (!textarea) return;
      
      let combinedContent = '';
      let filesProcessed = 0;
      let totalLines = 0;
      
      // Processar cada arquivo
      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const content = e.target.result;
          
          // Adicionar separador visual entre arquivos (se houver mais de 1)
          if (files.length > 1 && index > 0 && combinedContent.length > 0) {
            combinedContent += '\n';
          }
          
          combinedContent += content;
          
          const lineCount = content.split('\n').filter(line => line.trim().length > 0).length;
          totalLines += lineCount;
          
          filesProcessed++;
          
          // Quando todos os arquivos forem processados
          if (filesProcessed === files.length) {
            textarea.value = combinedContent;
            
            if (files.length === 1) {
              showToast(`‚úÖ Arquivo carregado! ${totalLines} linhas detectadas`, 'success');
            } else {
              showToast(`‚úÖ ${files.length} arquivos carregados! Total: ${totalLines} linhas`, 'success');
            }
          }
        };
        
        reader.onerror = function() {
          showToast(`‚ùå Erro ao ler o arquivo: ${file.name}`, 'error');
          filesProcessed++;
        };
        
        reader.readAsText(file);
      });
      
      event.target.value = '';
    }

    async function submitUploadGuestList(event, clientId) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const guestListRaw = formData.get('guest_list');
      
      if (!guestListRaw || !guestListRaw.trim()) {
        showToast('‚ùå Lista vazia!', 'error');
        return;
      }
      
      const parsedGuests = parseGuestList(guestListRaw);
      
      if (parsedGuests.length === 0) {
        showToast('‚ùå Nenhum convidado v√°lido encontrado!', 'error');
        return;
      }
      
      // Verificar se h√° convidados duplicados comparando os nomes
      const clientGuests = guests.filter(g => g.client_id === clientId);
      const newGuestNames = parsedGuests.map(pg => pg.name.toLowerCase().trim());
      const existingGuestNames = clientGuests.map(g => g.name.toLowerCase().trim());
      
      // Verificar quantos nomes j√° existem
      const duplicatesCount = newGuestNames.filter(name => existingGuestNames.includes(name)).length;
      
      // Se mais de 50% dos nomes j√° existem, considerar como lista duplicada
      const isDuplicateList = duplicatesCount > (newGuestNames.length * 0.5);
      
      if (isDuplicateList && clientGuests.length > 0) {
        showDuplicateListConfirmation(clientId, parsedGuests, duplicatesCount);
      } else {
        await processGuestListUpload(clientId, parsedGuests, false);
      }
    }

    function showDuplicateListConfirmation(clientId, parsedGuests, duplicatesCount) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'duplicate-list-confirmation';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8 text-center" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
          <div class="text-6xl mb-4">‚ö†Ô∏è</div>
          <h2 class="font-bold mb-4" style="font-size: 24px; color: ${config.text_color};">
            Lista Duplicada Detectada!
          </h2>
          <p class="mb-6 opacity-70" style="font-size: 16px; color: ${config.text_color};">
            Detectamos <strong>${duplicatesCount} convidados</strong> que j√° existem neste cliente.<br><br>
            O que voc√™ deseja fazer?
          </p>
          <div class="space-y-3">
            <button 
              onclick="confirmReplaceGuestList('${clientId}', ${JSON.stringify(parsedGuests).replace(/"/g, '&quot;')})"
              class="w-full py-3 rounded-xl font-semibold"
              style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; font-size: 16px;"
            >
              üîÑ Substituir Lista Antiga
            </button>
            <button 
              onclick="confirmAddToGuestList('${clientId}', ${JSON.stringify(parsedGuests).replace(/"/g, '&quot;')})"
              class="w-full py-3 rounded-xl font-semibold"
              style="background: linear-gradient(135deg, ${config.success_color} 0%, #059669 100%); color: white; font-size: 16px;"
            >
              ‚ûï Adicionar √† Lista Existente<br>
              <span style="font-size: 12px; opacity: 0.9;">(Ignora duplicados)</span>
            </button>
            <button 
              onclick="closeModal('duplicate-list-confirmation')"
              class="w-full py-3 rounded-xl font-semibold"
              style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
            >
              Cancelar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function confirmReplaceGuestList(clientId, parsedGuestsJson) {
      const parsedGuests = JSON.parse(parsedGuestsJson);
      await processGuestListUpload(clientId, parsedGuests, true);
    }

    async function confirmAddToGuestList(clientId, parsedGuestsJson) {
      const parsedGuests = JSON.parse(parsedGuestsJson);
      await processGuestListUpload(clientId, parsedGuests, false);
    }

    async function processGuestListUpload(clientId, parsedGuests, shouldReplace) {
      closeModal('duplicate-list-confirmation');
      
      // Se for substituir, deletar todos os convidados existentes (sem check-in)
      if (shouldReplace) {
        const clientGuests = guests.filter(g => g.client_id === clientId);
        const clientCheckins = checkins.filter(c => c.client_id === clientId);
        const guestsWithCheckin = clientCheckins.map(c => c.guest_qr);
        
        const guestsToDelete = clientGuests.filter(g => !guestsWithCheckin.includes(g.qr_code));
        
        if (guestsToDelete.length > 0) {
          showToast(`üîÑ Removendo ${guestsToDelete.length} convidados antigos...`, 'info');
          
          for (const guest of guestsToDelete) {
            await deleteGuest(guest.id);
          }
          
          await loadGuests();
        }
      }
      
      // Filtrar convidados que j√° existem
      const clientGuests = guests.filter(g => g.client_id === clientId);
      const existingNames = clientGuests.map(g => g.name.toLowerCase().trim());
      
      const guestsToCreate = parsedGuests
        .filter(pg => !existingNames.includes(pg.name.toLowerCase().trim()))
        .map(pg => ({
          id: generateId('guest'),
          client_id: clientId,
          name: pg.name,
          qr_code: generateId('QR'),
          has_companion: pg.has_companion,
          is_vip: false,
          deleted: false,
          deleted_at: null,
          created_at: new Date().toISOString()
        }));
      
      if (guestsToCreate.length === 0) {
        showToast('‚ö†Ô∏è Todos os convidados j√° existem!', 'warning');
        closeModal('upload-guest-list-modal');
        closeModal('client-details-modal');
        await showClientDetails(clientId);
        return;
      }
      
      const result = await createMultipleGuests(guestsToCreate);
      
      if (result.success) {
        const skippedCount = parsedGuests.length - guestsToCreate.length;
        let message = `‚úÖ ${result.count} convidados adicionados!`;
        if (skippedCount > 0) {
          message += ` (${skippedCount} duplicados ignorados)`;
        }
        showToast(message, 'success');
        closeModal('upload-guest-list-modal');
        closeModal('client-details-modal');
        await showClientDetails(clientId);
      } else {
        showToast('‚ùå Erro ao adicionar convidados', 'error');
      }
    }

    async function toggleClientVIP(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (!client) return;
      
      const result = await updateClient(clientId, { is_vip: !client.is_vip });
      
      if (result.success) {
        showToast(client.is_vip ? '‚úÖ Cliente removido do VIP' : '‚≠ê Cliente marcado como VIP', 'success');
        await renderAdminDashboard();
      } else {
        showToast('‚ùå Erro ao atualizar status VIP', 'error');
      }
    }

    async function toggleGuestVIP(guestId) {
      const guest = guests.find(g => g.id === guestId);
      if (!guest) return;
      
      const result = await updateGuest(guestId, { is_vip: !guest.is_vip });
      
      if (result.success) {
        showToast(guest.is_vip ? '‚úÖ Convidado removido do VIP' : '‚≠ê Convidado marcado como VIP', 'success');
        closeModal('client-details-modal');
        await showClientDetails(guest.client_id);
      } else {
        showToast('‚ùå Erro ao atualizar status VIP', 'error');
      }
    }

    function showExtendTokenModal(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (!client) return;
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'extend-token-modal';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
          <h2 class="font-bold mb-6" style="font-size: 28px; color: ${config.text_color};">
            ‚è∞ Estender ${client.event_date ? 'Data do Evento' : 'Validade do Token'}
          </h2>
          
          ${client.event_date ? `
            <form onsubmit="submitExtendEvent(event, '${clientId}'); return false;">
              <div class="mb-6">
                <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                  Nova Data e Hora do Evento
                </label>
                <input 
                  type="datetime-local" 
                  name="new_event_datetime"
                  required
                  class="w-full px-4 py-3 rounded-xl outline-none"
                  style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
                >
              </div>
              <div class="flex gap-3">
                <button 
                  type="button"
                  onclick="closeModal('extend-token-modal')"
                  class="flex-1 py-3 rounded-xl font-semibold"
                  style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
                >
                  Cancelar
                </button>
                <button 
                  type="submit"
                  class="flex-1 py-3 rounded-xl font-semibold"
                  style="background: linear-gradient(135deg, ${config.success_color} 0%, #059669 100%); color: white; font-size: 16px;"
                >
                  Atualizar Data
                </button>
              </div>
            </form>
          ` : `
            <form onsubmit="submitExtendToken(event, '${clientId}'); return false;">
              <div class="mb-6">
                <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                  Estender por quantos dias?
                </label>
                <div class="grid grid-cols-3 gap-3 mb-4">
                  <button type="button" onclick="setExtendDays(7)" class="py-3 rounded-xl font-semibold transition-all" style="background-color: ${config.background_color}; color: ${config.text_color};">
                    7 dias
                  </button>
                  <button type="button" onclick="setExtendDays(15)" class="py-3 rounded-xl font-semibold transition-all" style="background-color: ${config.background_color}; color: ${config.text_color};">
                    15 dias
                  </button>
                  <button type="button" onclick="setExtendDays(30)" class="py-3 rounded-xl font-semibold transition-all" style="background-color: ${config.background_color}; color: ${config.text_color};">
                    30 dias
                  </button>
                </div>
                <input 
                  type="number" 
                  name="extend_days" 
                  id="extend-days-input"
                  required 
                  min="1"
                  value="30"
                  class="w-full px-4 py-3 rounded-xl outline-none"
                  style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
                  placeholder="Ou digite o n√∫mero de dias"
                >
              </div>
              <div class="flex gap-3">
                <button 
                  type="button"
                  onclick="closeModal('extend-token-modal')"
                  class="flex-1 py-3 rounded-xl font-semibold"
                  style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
                >
                  Cancelar
                </button>
                <button 
                  type="submit"
                  class="flex-1 py-3 rounded-xl font-semibold"
                  style="background: linear-gradient(135deg, ${config.success_color} 0%, #059669 100%); color: white; font-size: 16px;"
                >
                  Estender Token
                </button>
              </div>
            </form>
          `}
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function setExtendDays(days) {
      const input = document.getElementById('extend-days-input');
      if (input) {
        input.value = days;
      }
    }

    async function submitExtendToken(event, clientId) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const extendDays = parseInt(formData.get('extend_days'));
      
      const newExpiry = (Date.now() + (extendDays * 24 * 60 * 60 * 1000)).toString();
      
      const result = await updateClient(clientId, { expiry: newExpiry });
      
      if (result.success) {
        showToast(`‚úÖ Token estendido por ${extendDays} dias!`, 'success');
        closeModal('extend-token-modal');
        await renderAdminDashboard();
      } else {
        showToast('‚ùå Erro ao estender token', 'error');
      }
    }

    async function submitExtendEvent(event, clientId) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const newEventDatetime = formData.get('new_event_datetime');
      const newEventDate = new Date(newEventDatetime);
      
      const result = await updateClient(clientId, { 
        event_date: newEventDate.getTime().toString(),
        expiry: newEventDate.getTime().toString()
      });
      
      if (result.success) {
        showToast(`‚úÖ Data do evento atualizada!`, 'success');
        closeModal('extend-token-modal');
        await renderAdminDashboard();
      } else {
        showToast('‚ùå Erro ao atualizar data do evento', 'error');
      }
    }

    function showClearCheckinsConfirmation(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (!client) return;
      
      const clientCheckins = checkins.filter(c => c.client_id === clientId);
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'clear-checkins-modal';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8 text-center" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
          <div class="text-6xl mb-4">‚ö†Ô∏è</div>
          <h2 class="font-bold mb-4" style="font-size: 24px; color: ${config.text_color};">
            Limpar Check-ins de ${client.client_name}
          </h2>
          <p class="mb-6 opacity-70" style="font-size: 16px; color: ${config.text_color};">
            Tem certeza que deseja desfazer todos os ${clientCheckins.length} check-ins deste cliente?<br>
            <strong>Esta a√ß√£o n√£o pode ser desfeita!</strong>
          </p>
          <div class="flex gap-3">
            <button 
              onclick="closeModal('clear-checkins-modal')"
              class="flex-1 py-3 rounded-xl font-semibold"
              style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
            >
              Cancelar
            </button>
            <button 
              onclick="confirmClearCheckins('${clientId}')"
              class="flex-1 py-3 rounded-xl font-semibold"
              style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-size: 16px;"
            >
              Sim, Limpar Tudo
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function confirmClearCheckins(clientId) {
      const result = await deleteAllClientCheckins(clientId);
      
      if (result.success) {
        showToast('‚úÖ Todos os check-ins foram removidos!', 'success');
        closeModal('clear-checkins-modal');
        await renderAdminDashboard();
      } else {
        showToast('‚ùå Erro ao limpar check-ins', 'error');
      }
    }

    function showDeleteClientConfirmation(clientId) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'delete-client-modal';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8 text-center" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
          <div class="text-6xl mb-4">‚ö†Ô∏è</div>
          <h2 class="font-bold mb-4" style="font-size: 24px; color: ${config.text_color};">
            Confirmar Exclus√£o
          </h2>
          <p class="mb-6 opacity-70" style="font-size: 16px; color: ${config.text_color};">
            Tem certeza que deseja deletar este cliente?<br>Esta a√ß√£o pode ser desfeita pela lixeira.
          </p>
          <div class="flex gap-3">
            <button 
              onclick="closeModal('delete-client-modal')"
              class="flex-1 py-3 rounded-xl font-semibold"
              style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
            >
              Cancelar
            </button>
            <button 
              onclick="confirmDeleteClient('${clientId}')"
              class="flex-1 py-3 rounded-xl font-semibold"
              style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; font-size: 16px;"
            >
              Deletar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function confirmDeleteClient(clientId) {
      const result = await deleteClient(clientId);
      
      if (result.success) {
        showToast('‚úÖ Cliente deletado com sucesso!', 'success');
        closeModal('delete-client-modal');
        await renderAdminDashboard();
      } else {
        showToast('‚ùå Erro ao deletar cliente', 'error');
      }
    }

    function showDeleteGuestConfirmation(guestId) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'delete-guest-modal';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8 text-center" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
          <div class="text-6xl mb-4">‚ö†Ô∏è</div>
          <h2 class="font-bold mb-4" style="font-size: 24px; color: ${config.text_color};">
            Confirmar Exclus√£o
          </h2>
          <p class="mb-6 opacity-70" style="font-size: 16px; color: ${config.text_color};">
            Tem certeza que deseja deletar este convidado?
          </p>
          <div class="flex gap-3">
            <button 
              onclick="closeModal('delete-guest-modal')"
              class="flex-1 py-3 rounded-xl font-semibold"
              style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
            >
              Cancelar
            </button>
            <button 
              onclick="confirmDeleteGuest('${guestId}')"
              class="flex-1 py-3 rounded-xl font-semibold"
              style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; font-size: 16px;"
            >
              Deletar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function confirmDeleteGuest(guestId) {
      const guest = guests.find(g => g.id === guestId);
      const result = await deleteGuest(guestId);
      
      if (result.success) {
        showToast('‚úÖ Convidado deletado com sucesso!', 'success');
        closeModal('delete-guest-modal');
        closeModal('client-details-modal');
        if (guest) {
          await showClientDetails(guest.client_id);
        }
      } else {
        showToast('‚ùå Erro ao deletar convidado', 'error');
      }
    }

    async function showTrashModal() {
      const deletedClients = await loadDeletedClients();
      const deletedGuests = await loadDeletedGuests();
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'trash-modal';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto;">
          <h2 class="font-bold mb-6" style="font-size: 28px; color: ${config.text_color};">
            üóëÔ∏è Lixeira
          </h2>
          
          ${deletedClients.length === 0 && deletedGuests.length === 0 ? `
            <p class="text-center opacity-70 py-8" style="font-size: 16px; color: ${config.text_color};">
              A lixeira est√° vazia
            </p>
          ` : ''}
          
          ${deletedClients.length > 0 ? `
            <h3 class="font-bold mb-3" style="font-size: 20px; color: ${config.text_color};">
              Clientes Deletados
            </h3>
            <div class="space-y-2 mb-6">
              ${deletedClients.map(client => `
                <div class="p-3 rounded-lg flex items-center justify-between" style="background-color: ${config.background_color};">
                  <div>
                    <p class="font-bold flex items-center gap-2" style="font-size: 14px; color: ${config.text_color};">
                      ${client.is_vip ? '‚≠ê ' : ''}${client.client_name}
                    </p>
                    <p class="opacity-70 text-xs" style="color: ${config.text_color};">
                      Deletado em: ${new Date(client.deleted_at).toLocaleString('pt-BR')}
                    </p>
                  </div>
                  <button onclick="restoreClientFromTrash('${client.id}')" class="px-3 py-2 rounded-lg font-semibold text-sm" style="background: linear-gradient(135deg, ${config.success_color} 0%, #059669 100%); color: white;">
                    ‚Ü©Ô∏è Restaurar
                  </button>
                </div>
              `).join('')}
            </div>
          ` : ''}
          
          ${deletedGuests.length > 0 ? `
            <h3 class="font-bold mb-3" style="font-size: 20px; color: ${config.text_color};">
              Convidados Deletados
            </h3>
            <div class="space-y-2 mb-6">
              ${deletedGuests.map(guest => {
                const client = clients.find(c => c.id === guest.client_id);
                return `
                  <div class="p-3 rounded-lg flex items-center justify-between" style="background-color: ${config.background_color};">
                    <div>
                      <p class="font-bold flex items-center gap-2" style="font-size: 14px; color: ${config.text_color};">
                        ${guest.is_vip ? '‚≠ê ' : ''}${guest.name}
                      </p>
                      <p class="opacity-70 text-xs" style="color: ${config.text_color};">
                        Cliente: ${client ? client.client_name : 'N/A'} ‚Ä¢ Deletado em: ${new Date(guest.deleted_at).toLocaleString('pt-BR')}
                      </p>
                    </div>
                    <button onclick="restoreGuestFromTrash('${guest.id}')" class="px-3 py-2 rounded-lg font-semibold text-sm" style="background: linear-gradient(135deg, ${config.success_color} 0%, #059669 100%); color: white;">
                      ‚Ü©Ô∏è Restaurar
                    </button>
                  </div>
                `;
              }).join('')}
            </div>
          ` : ''}
          
          <button 
            onclick="closeModal('trash-modal')"
            class="w-full py-3 rounded-xl font-semibold"
            style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
          >
            Fechar
          </button>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function restoreClientFromTrash(clientId) {
      const result = await restoreClient(clientId);
      
      if (result.success) {
        showToast('‚úÖ Cliente restaurado com sucesso!', 'success');
        closeModal('trash-modal');
        await renderAdminDashboard();
      } else {
        showToast('‚ùå Erro ao restaurar cliente', 'error');
      }
    }

    async function restoreGuestFromTrash(guestId) {
      const result = await restoreGuest(guestId);
      
      if (result.success) {
        showToast('‚úÖ Convidado restaurado com sucesso!', 'success');
        await showTrashModal();
      } else {
        showToast('‚ùå Erro ao restaurar convidado', 'error');
      }
    }

    async function undoCheckin(checkinId) {
      const result = await deleteCheckin(checkinId);
      
      if (result.success) {
        showToast('‚úÖ Check-in desfeito com sucesso!', 'success');
        await renderAdminDashboard();
      } else {
        showToast('‚ùå Erro ao desfazer check-in', 'error');
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.remove();
      }
    }

    async function switchClientTab(tab) {
      if (html5QrCode && currentTab === 'scanner') {
        try {
          await html5QrCode.stop();
          html5QrCode = null;
        } catch (e) {
          console.log('Scanner j√° parado');
        }
      }
      
      currentTab = tab;
      await renderClientDashboard();
    }

    // =============== GLOBAL FUNCTIONS ===============

    window.switchLoginType = switchLoginType;
    window.loginAdmin = loginAdmin;
    window.loginClient = loginClient;
    window.logout = logout;
    window.switchClientTab = switchClientTab;
    window.confirmCompanionEntry = confirmCompanionEntry;
    window.cancelCompanionEntry = cancelCompanionEntry;
    window.filterGuests = filterGuests;
    window.searchGuests = searchGuests;
    window.exportClientPDF = exportClientPDF;
    window.showAddClientModal = showAddClientModal;
    window.toggleControlType = toggleControlType;
    window.submitNewClient = submitNewClient;
    window.showClientDetails = showClientDetails;
    window.showAddGuestModal = showAddGuestModal;
    window.submitNewGuest = submitNewGuest;
    window.toggleClientVIP = toggleClientVIP;
    window.toggleGuestVIP = toggleGuestVIP;
    window.showExtendTokenModal = showExtendTokenModal;
    window.setExtendDays = setExtendDays;
    window.submitExtendToken = submitExtendToken;
    window.submitExtendEvent = submitExtendEvent;
    window.showClearCheckinsConfirmation = showClearCheckinsConfirmation;
    window.confirmClearCheckins = confirmClearCheckins;
    window.showDeleteClientConfirmation = showDeleteClientConfirmation;
    window.confirmDeleteClient = confirmDeleteClient;
    window.showDeleteGuestConfirmation = showDeleteGuestConfirmation;
    window.confirmDeleteGuest = confirmDeleteGuest;
    window.showTrashModal = showTrashModal;
    window.restoreClientFromTrash = restoreClientFromTrash;
    window.restoreGuestFromTrash = restoreGuestFromTrash;
    window.undoCheckin = undoCheckin;
    window.closeModal = closeModal;
    window.handleGuestListFile = handleGuestListFile;
    window.showUploadGuestListModal = showUploadGuestListModal;
    window.handleUploadGuestListFile = handleUploadGuestListFile;
    window.submitUploadGuestList = submitUploadGuestList;
    window.confirmReplaceGuestList = confirmReplaceGuestList;
    window.confirmAddToGuestList = confirmAddToGuestList;

    // =============== VALIDA√á√ÉO PERI√ìDICA E ATUALIZA√á√ÉO EM TEMPO REAL ===============
    
    setInterval(async () => {
      if (currentUser && isOnline) {
        if (currentUser.type === 'client') {
          try {
            await loadClients();
            const client = clients.find(c => c.id === currentUser.id);
            
            if (!client || client.deleted || parseInt(client.expiry) < Date.now()) {
              clearSession('client');
              currentUser = null;
              currentView = 'login';
              
              if (html5QrCode) {
                html5QrCode.stop().catch(() => {});
                html5QrCode = null;
              }
              
              showToast('‚ùå Sess√£o encerrada - Token expirado ou desativado', 'error');
              renderLogin();
            } else {
              await loadGuests();
              await loadCheckins();
              
              if (currentView === 'client-dashboard' && currentTab === 'home') {
                updateGuestsList();
              }
            }
          } catch (error) {
            console.log('Erro ao validar sess√£o');
          }
        } else if (currentUser.type === 'admin') {
          try {
            await loadAllData();
            if (currentView === 'admin-dashboard') {
              await renderAdminDashboard();
            }
          } catch (error) {
            console.log('Erro ao atualizar dados do admin');
          }
        }
      }
    }, 10000);

    // =============== INIT ===============

    async function init() {
      loadOfflineQueue();
      await loadAllData();
      
      const hasSession = await checkExistingSession();
      if (!hasSession) {
        renderLogin();
      }
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9acae17697e7c13d',t:'MTc2NTUxNzk2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>