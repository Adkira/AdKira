<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AdKira Check-In</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }

    .vip-badge {
      background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 50%, #fbbf24 100%);
      background-size: 200% auto;
      animation: shimmer 3s linear infinite;
    }
    
    .animate-slide-in {
      animation: slideIn 0.4s ease-out;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 14px;
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
      max-width: 90%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9000;
      padding: 16px;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-content {
      animation: slideIn 0.3s ease-out;
      max-width: 600px;
      width: 100%;
      max-height: 90%;
      overflow-y: auto;
    }

    #qr-reader {
      width: 100% !important;
      border: none !important;
    }

    #qr-reader__scan_region {
      border: 3px solid #007f9f !important;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full" style="background-color: #0a1929;">
  <div id="app" class="h-full w-full overflow-auto"></div>
  <script>
    const SUPABASE_URL = 'https://sekkrboqttxpathyxcun.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNla2tyYm9xdHR4cGF0aHl4Y3VuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNjY0OTYsImV4cCI6MjA3OTc0MjQ5Nn0.JqrLUWHs3-jyUNT-0s2DwiyeDjK0uv6uIh0ip1qPWBA';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const config = {
      primary_color: "#007f9f",
      background_color: "#0a1929",
      card_color: "#132f4c",
      text_color: "#ffffff",
      success_color: "#10b981",
      error_color: "#ef4444",
      vip_color: "#fbbf24",
      app_title: "AdKira Check-In"
    };

    let clients = [];
    let guests = [];
    let checkins = [];
    let currentView = 'login';
    let currentUser = null;
    let currentTab = 'home';
    let html5QrCode = null;
    let currentSearchQuery = '';

    // =============== HELPER FUNCTIONS ===============
    
    function generateId(prefix) {
      return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    }

    function generateToken() {
      return 'TKN-' + Math.random().toString(36).substr(2, 9).toUpperCase();
    }

    function saveSession(type, data) {
      localStorage.setItem(`adkira_${type}_session`, JSON.stringify(data));
    }

    function loadSession(type) {
      const data = localStorage.getItem(`adkira_${type}_session`);
      return data ? JSON.parse(data) : null;
    }

    function clearSession(type) {
      localStorage.removeItem(`adkira_${type}_session`);
    }

    function showToast(message, type = 'success') {
      const existingToast = document.querySelector('.toast');
      if (existingToast) existingToast.remove();

      const colors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
      };

      const toast = document.createElement('div');
      toast.className = 'toast text-white font-semibold';
      toast.style.backgroundColor = colors[type] || colors.info;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 4000);
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.remove();
    }

    function parseGuestList(rawText) {
      if (!rawText?.trim()) return [];
      
      const lines = rawText.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0)
        .filter(line => !line.startsWith('#'))
        .filter(line => !line.includes('#validade'))
        .filter(line => line.length > 2);
      
      return lines.map((line, index) => {
        let cleanName = line;
        if (/^[a-z0-9]+,/.test(line)) {
          cleanName = line.split(',').slice(1).join(',').trim();
        }
        
        if (cleanName.includes('#')) {
          return null;
        }
        
        return {
          originalLine: line,
          name: cleanName,
          has_companion: cleanName.toLowerCase().includes(' e '),
          lineNumber: index + 1
        };
      }).filter(guest => guest !== null);
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.name.toLowerCase().endsWith('.txt')) {
        showToast('‚ùå Por favor, selecione um arquivo TXT', 'error');
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        const textarea = document.getElementById('guest-list-textarea');
        if (textarea) {
          textarea.value = content;
          const lineCount = content.split('\n').filter(line => line.trim().length > 0).length;
          showToast(`‚úÖ ${lineCount} convidados carregados!`, 'success');
        }
      };
      
      reader.onerror = function() {
        showToast('‚ùå Erro ao ler arquivo', 'error');
      };
      
      reader.readAsText(file);
    }

    // =============== SUPABASE FUNCTIONS ===============

    async function loadClients() {
      const { data, error } = await supabase
        .from('clients')
        .select('*')
        .eq('deleted', false)
        .order('created_at', { ascending: false });
      
      if (!error && data) clients = data;
    }

    async function loadGuests() {
      const { data, error } = await supabase
        .from('guests')
        .select('*')
        .eq('deleted', false)
        .order('created_at', { ascending: false });
      
      if (!error && data) guests = data;
    }

    async function loadCheckins() {
      const { data, error } = await supabase
        .from('checkins')
        .select('*')
        .order('checked_in_at', { ascending: false });
      
      if (!error && data) checkins = data;
    }

    async function loadAllData() {
      await Promise.all([loadClients(), loadGuests(), loadCheckins()]);
    }

    async function validateAdminCredentials(username, password) {
      const { data, error } = await supabase
        .from('admin_credentials')
        .select('*')
        .eq('username', username)
        .eq('password', password)
        .eq('active', true)
        .single();
      return !error && data;
    }

    async function createClient(clientData) {
      const { data, error } = await supabase.from('clients').insert([clientData]).select();
      if (!error) await loadClients();
      return { success: !error, data };
    }

    async function updateClient(clientId, updates) {
      const { data, error } = await supabase.from('clients').update(updates).eq('id', clientId).select();
      if (!error) await loadClients();
      return { success: !error };
    }

    async function deleteClient(clientId) {
      const { error } = await supabase
        .from('clients')
        .update({ deleted: true, deleted_at: new Date().toISOString() })
        .eq('id', clientId);
      
      await supabase
        .from('guests')
        .update({ deleted: true, deleted_at: new Date().toISOString() })
        .eq('client_id', clientId);
      
      await supabase
        .from('checkins')
        .delete()
        .eq('client_id', clientId);
      
      if (!error) await loadAllData();
      return { success: !error };
    }

    async function createGuest(guestData) {
      const { data, error } = await supabase.from('guests').insert([guestData]).select();
      if (!error) await loadGuests();
      return { success: !error };
    }

    async function createMultipleGuests(guestsArray) {
      if (guestsArray.length === 0) return { success: true, count: 0 };
      
      const { data, error } = await supabase.from('guests').insert(guestsArray).select();
      if (!error) await loadGuests();
      return { success: !error, count: data?.length || 0 };
    }

    async function updateGuest(guestId, updates) {
      const { error } = await supabase.from('guests').update(updates).eq('id', guestId);
      if (!error) await loadGuests();
      return { success: !error };
    }

    async function deleteGuest(guestId) {
      const { error } = await supabase
        .from('guests')
        .update({ deleted: true, deleted_at: new Date().toISOString() })
        .eq('id', guestId);
      if (!error) await loadGuests();
      return { success: !error };
    }

    async function createCheckin(checkinData) {
      const { data, error } = await supabase.from('checkins').insert([checkinData]).select();
      if (!error) await loadCheckins();
      return { success: !error };
    }

    async function deleteAllClientCheckins(clientId) {
      const { error } = await supabase.from('checkins').delete().eq('client_id', clientId);
      if (!error) {
        await loadCheckins();
        await createAuditLog('clear_all_checkins', { client_id: clientId });
      }
      return { success: !error };
    }

    async function deleteCheckin(checkinId) {
      const { error } = await supabase.from('checkins').delete().eq('id', checkinId);
      if (!error) {
        await loadCheckins();
        await createAuditLog('delete_single_checkin', { checkin_id: checkinId });
      }
      return { success: !error };
    }

    async function createAuditLog(action, metadata = {}) {
      try {
        await supabase.from('audit_logs').insert([{
          id: generateId('audit'),
          action,
          user_type: currentUser?.type || 'unknown',
          user_id: currentUser?.id || 'unknown',
          metadata: JSON.stringify(metadata),
          ip_address: 'client-side',
          created_at: new Date().toISOString()
        }]);
      } catch (error) {
        console.log('Audit log n√£o criado (tabela pode n√£o existir)');
      }
    }

    // =============== PDF EXPORT ===============

    async function exportClientPDF(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (!client) return;

      const clientGuests = guests.filter(g => g.client_id === clientId);
      const clientCheckins = checkins.filter(c => c.client_id === clientId);

      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        // CABE√áALHO
        doc.setFillColor(0, 127, 159);
        doc.rect(0, 0, pageWidth, 45, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.setFont(undefined, 'bold');
        doc.text('RELAT√ìRIO DE CHECK-IN', pageWidth / 2, 20, { align: 'center' });
        
        doc.setFontSize(11);
        doc.setFont(undefined, 'normal');
        doc.text('Sistema AdKira', pageWidth / 2, 28, { align: 'center' });
        
        doc.setFontSize(9);
        doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, pageWidth / 2, 36, { align: 'center' });

        let yPos = 55;
        
        // INFO DO CLIENTE
        doc.setFillColor(245, 247, 250);
        doc.roundedRect(15, yPos, pageWidth - 30, 35, 3, 3, 'F');
        
        doc.setTextColor(10, 25, 41);
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text(client.client_name, 20, yPos + 10);
        
        if (client.is_vip) {
          doc.setFillColor(251, 191, 36);
          doc.roundedRect(20 + doc.getTextWidth(client.client_name) + 5, yPos + 3, 22, 8, 2, 2, 'F');
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(8);
          doc.text('‚≠ê VIP', 31 + doc.getTextWidth(client.client_name), yPos + 9, { align: 'center' });
        }
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(100, 100, 100);
        doc.text(`Token: ${client.token}`, 20, yPos + 20);
        doc.text(`Validade: ${new Date(parseInt(client.expiry)).toLocaleString('pt-BR')}`, 20, yPos + 28);

        yPos = 100;
        
        // ESTAT√çSTICAS
        const uniqueCheckins = clientCheckins.filter(c => !c.is_companion_only).length;
        const vipGuests = clientGuests.filter(g => g.is_vip).length;
        const attendanceRate = clientGuests.length > 0 ? ((uniqueCheckins / clientGuests.length) * 100).toFixed(1) : 0;

        const cardWidth = (pageWidth - 50) / 4;
        const cardHeight = 28;
        const cardSpacing = 5;

        doc.setFillColor(0, 127, 159);
        doc.roundedRect(15, yPos, cardWidth, cardHeight, 2, 2, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(9);
        doc.text('CONVIDADOS', 15 + cardWidth/2, yPos + 11, { align: 'center' });
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text(clientGuests.length.toString(), 15 + cardWidth/2, yPos + 24, { align: 'center' });

        doc.setFillColor(16, 185, 129);
        doc.roundedRect(15 + cardWidth + cardSpacing, yPos, cardWidth, cardHeight, 2, 2, 'F');
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('CHECK-INS', 15 + cardWidth + cardSpacing + cardWidth/2, yPos + 11, { align: 'center' });
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text(uniqueCheckins.toString(), 15 + cardWidth + cardSpacing + cardWidth/2, yPos + 24, { align: 'center' });

        doc.setFillColor(251, 191, 36);
        doc.roundedRect(15 + (cardWidth + cardSpacing) * 2, yPos, cardWidth, cardHeight, 2, 2, 'F');
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('VIP', 15 + (cardWidth + cardSpacing) * 2 + cardWidth/2, yPos + 11, { align: 'center' });
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text(vipGuests.toString(), 15 + (cardWidth + cardSpacing) * 2 + cardWidth/2, yPos + 24, { align: 'center' });

        doc.setFillColor(99, 102, 241);
        doc.roundedRect(15 + (cardWidth + cardSpacing) * 3, yPos, cardWidth, cardHeight, 2, 2, 'F');
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('PRESEN√áA', 15 + (cardWidth + cardSpacing) * 3 + cardWidth/2, yPos + 11, { align: 'center' });
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text(`${attendanceRate}%`, 15 + (cardWidth + cardSpacing) * 3 + cardWidth/2, yPos + 24, { align: 'center' });

        yPos = 140;
        
        // TABELA CHECK-INS REALIZADOS
        doc.setTextColor(10, 25, 41);
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('‚úÖ Check-ins Realizados', 15, yPos);
        
        yPos += 8;
        
        doc.setFillColor(0, 127, 159);
        doc.rect(15, yPos, pageWidth - 30, 10, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.text('#', 20, yPos + 7);
        doc.text('CONVIDADO', 35, yPos + 7);
        doc.text('DATA E HORA', pageWidth - 65, yPos + 7);
        
        yPos += 10;
        
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        
        if (clientCheckins.length === 0) {
          doc.setTextColor(148, 163, 184);
          doc.text('Nenhum check-in realizado', pageWidth / 2, yPos + 15, { align: 'center' });
        } else {
          const sortedCheckins = [...clientCheckins].sort((a, b) => 
            new Date(b.checked_in_at) - new Date(a.checked_in_at)
          );
          
          sortedCheckins.forEach((checkin, index) => {
            if (yPos > pageHeight - 30) {
              doc.addPage();
              yPos = 20;
            }
            
            if (index % 2 === 0) {
              doc.setFillColor(249, 250, 251);
              doc.rect(15, yPos, pageWidth - 30, 12, 'F');
            }
            
            doc.setTextColor(10, 25, 41);
            doc.text((index + 1).toString(), 20, yPos + 8);
            
            let guestName = checkin.guest_name;
            const guest = guests.find(g => g.qr_code === checkin.guest_qr);
            
            if (guest && guest.is_vip) guestName = `‚≠ê ${guestName}`;
            if (checkin.is_companion_only) guestName = `üë§ Acompanhante`;
            else if (checkin.with_companion) guestName = `${guestName} üë•`;
            
            const maxNameWidth = pageWidth - 100;
            if (doc.getTextWidth(guestName) > maxNameWidth) {
              while (doc.getTextWidth(guestName + '...') > maxNameWidth && guestName.length > 0) {
                guestName = guestName.slice(0, -1);
              }
              guestName += '...';
            }
            
            doc.text(guestName, 35, yPos + 8);
            
            const checkinTime = new Date(checkin.checked_in_at).toLocaleString('pt-BR', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            doc.text(checkinTime, pageWidth - 25, yPos + 8, { align: 'right' });
            
            yPos += 12;
          });
        }

        // TABELA DE CONVIDADOS PENDENTES
        yPos += 10;
        
        if (yPos > pageHeight - 50) {
          doc.addPage();
          yPos = 20;
        }
        
        const pendingGuests = clientGuests.filter(guest => 
          !clientCheckins.some(c => c.guest_qr === guest.qr_code && !c.is_companion_only)
        );
        
        doc.setTextColor(10, 25, 41);
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text(`‚è≥ Convidados Pendentes (${pendingGuests.length})`, 15, yPos);
        
        yPos += 8;
        
        doc.setFillColor(251, 191, 36);
        doc.rect(15, yPos, pageWidth - 30, 10, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.text('#', 20, yPos + 7);
        doc.text('CONVIDADO', 35, yPos + 7);
        doc.text('STATUS', pageWidth - 40, yPos + 7);
        
        yPos += 10;
        
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        
        if (pendingGuests.length === 0) {
          doc.setTextColor(148, 163, 184);
          doc.text('Todos os convidados fizeram check-in! üéâ', pageWidth / 2, yPos + 15, { align: 'center' });
        } else {
          pendingGuests.forEach((guest, index) => {
            if (yPos > pageHeight - 30) {
              doc.addPage();
              yPos = 20;
            }
            
            if (index % 2 === 0) {
              doc.setFillColor(249, 250, 251);
              doc.rect(15, yPos, pageWidth - 30, 12, 'F');
            }
            
            doc.setTextColor(10, 25, 41);
            doc.text((index + 1).toString(), 20, yPos + 8);
            
            let guestName = guest.name;
            if (guest.is_vip) guestName = `‚≠ê ${guestName}`;
            if (guest.has_companion) guestName = `${guestName} üë•`;
            
            const maxNameWidth = pageWidth - 100;
            if (doc.getTextWidth(guestName) > maxNameWidth) {
              while (doc.getTextWidth(guestName + '...') > maxNameWidth && guestName.length > 0) {
                guestName = guestName.slice(0, -1);
              }
              guestName += '...';
            }
            
            doc.text(guestName, 35, yPos + 8);
            
            doc.setTextColor(251, 146, 60);
            doc.text('Pendente', pageWidth - 40, yPos + 8);
            
            yPos += 12;
          });
        }

        const footerY = pageHeight - 15;
        doc.setDrawColor(0, 127, 159);
        doc.setLineWidth(0.5);
        doc.line(15, footerY - 5, pageWidth - 15, footerY - 5);
        
        doc.setTextColor(148, 163, 184);
        doc.setFontSize(8);
        doc.text(`Created By AdKira ${new Date().getFullYear()} üíô`, pageWidth / 2, footerY, { align: 'center' });

        const fileName = `Relatorio_${client.client_name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`;
        doc.save(fileName);
        showToast('‚úÖ PDF gerado com sucesso!', 'success');
      } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showToast('‚ùå Erro ao gerar PDF', 'error');
      }
    }

    // =============== SESSION CHECK ===============

    async function checkExistingSession() {
      const adminSession = loadSession('admin');
      if (adminSession?.username) {
        // Verificar tempo de sess√£o (24 horas)
        const sessionAge = Date.now() - (adminSession.timestamp || 0);
        if (sessionAge > 24 * 60 * 60 * 1000) {
          clearSession('admin');
          showToast('‚ö†Ô∏è Sess√£o expirada. Fa√ßa login novamente.', 'warning');
          return false;
        }
        
        currentUser = { type: 'admin', id: 'admin', name: 'Administrador' };
        currentView = 'admin-dashboard';
        await loadAllData();
        await renderAdminDashboard();
        return true;
      }

      const clientSession = loadSession('client');
      if (clientSession) {
        await loadClients();
        const client = clients.find(c => c.id === clientSession.clientId);
        
        // Verificar validade do token
        if (!client || client.deleted || parseInt(client.expiry) < Date.now()) {
          clearSession('client');
          showToast('‚ö†Ô∏è Sess√£o inv√°lida ou expirada', 'warning');
          return false;
        }
        
        // Verificar se o token n√£o foi alterado
        if (clientSession.token !== client.token) {
          clearSession('client');
          showToast('‚ö†Ô∏è Token alterado. Fa√ßa login novamente.', 'warning');
          return false;
        }

        currentUser = { type: 'client', id: client.id, name: client.client_name };
        currentView = 'client-dashboard';
        await loadAllData();
        await renderClientDashboard();
        return true;
      }

      return false;
    }

    // =============== LOGIN ===============

    function renderLogin() {
      document.getElementById('app').innerHTML = `
        <div class="min-h-full flex flex-col items-center justify-center p-4" style="background: linear-gradient(135deg, ${config.background_color} 0%, ${config.card_color} 100%);">
          <div class="w-full max-w-md animate-slide-in">
            <div class="text-center mb-8">
              <div class="w-24 h-24 mx-auto mb-6 rounded-3xl flex items-center justify-center" style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); box-shadow: 0 20px 60px rgba(0, 127, 159, 0.4);">
                <svg class="w-12 h-12" style="color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h1 class="font-bold mb-2" style="font-size: 40px; color: ${config.text_color};">
                ${config.app_title}
              </h1>
              <p class="opacity-70" style="font-size: 18px; color: ${config.text_color};">
                Sistema Profissional de Check-In
              </p>
            </div>

            <div class="rounded-3xl p-8 backdrop-blur-lg" style="background-color: ${config.card_color}cc; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
              <div class="flex gap-2 mb-6">
                <button onclick="switchLoginType('client')" id="client-tab" class="flex-1 py-3 rounded-xl font-semibold transition-all" style="background-color: ${config.primary_color}; color: white;">
                  Cliente
                </button>
                <button onclick="switchLoginType('admin')" id="admin-tab" class="flex-1 py-3 rounded-xl font-semibold transition-all" style="background-color: ${config.background_color}; color: ${config.text_color};">
                  Administrador
                </button>
              </div>

              <div id="login-form-container"></div>
            </div>

            <div class="text-center mt-6">
              <p class="opacity-40" style="font-size: 12px; color: ${config.text_color};">
                Created By AdKira ${new Date().getFullYear()}
              </p>
            </div>
          </div>
        </div>
      `;

      switchLoginType('client');
    }

    function switchLoginType(type) {
      document.getElementById('admin-tab').style.backgroundColor = type === 'admin' ? config.primary_color : config.background_color;
      document.getElementById('client-tab').style.backgroundColor = type === 'client' ? config.primary_color : config.background_color;

      const container = document.getElementById('login-form-container');
      
      if (type === 'admin') {
        container.innerHTML = `
          <form onsubmit="loginAdmin(event); return false;">
            <div class="mb-4">
              <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                Nome de Usu√°rio
              </label>
              <input 
                type="text" 
                name="username" 
                required 
                autocomplete="off"
                class="w-full px-4 py-3 rounded-xl outline-none"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
                placeholder="Digite o usu√°rio"
              >
            </div>
            <div class="mb-6">
              <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                Senha
              </label>
              <input 
                type="password" 
                name="password" 
                required 
                autocomplete="off"
                class="w-full px-4 py-3 rounded-xl outline-none"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
                placeholder="Digite a senha"
              >
            </div>
            <button 
              type="submit" 
              class="w-full py-4 rounded-xl font-bold"
              style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); color: white; font-size: 18px;"
            >
              Entrar como Admin
            </button>
          </form>
        `;
      } else {
        container.innerHTML = `
          <form onsubmit="loginClient(event); return false;">
            <div class="mb-6">
              <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                Token de Acesso
              </label>
              <input 
                type="text" 
                name="token" 
                required 
                autocomplete="off"
                class="w-full px-4 py-3 rounded-xl outline-none font-mono"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
              >
            </div>
            <button 
              type="submit" 
              class="w-full py-4 rounded-xl font-bold"
              style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); color: white; font-size: 18px;"
            >
              Entrar como Cliente
            </button>
          </form>
        `;
      }
    }

    // Rate limiting para login
    let loginAttempts = 0;
    let lastLoginAttempt = 0;

    async function loginAdmin(event) {
      event.preventDefault();
      
      // Rate limiting: m√°ximo 5 tentativas por minuto
      const now = Date.now();
      if (now - lastLoginAttempt < 60000) {
        loginAttempts++;
        if (loginAttempts > 5) {
          showToast('‚ö†Ô∏è Muitas tentativas. Aguarde 1 minuto.', 'warning');
          return;
        }
      } else {
        loginAttempts = 1;
      }
      lastLoginAttempt = now;
      
      const formData = new FormData(event.target);
      const username = formData.get('username')?.trim();
      const password = formData.get('password')?.trim();

      // Valida√ß√£o de input
      if (!username || !password || username.length < 3 || password.length < 4) {
        showToast('‚ùå Credenciais inv√°lidas!', 'error');
        return;
      }

      if (await validateAdminCredentials(username, password)) {
        loginAttempts = 0; // Reset ap√≥s sucesso
        currentUser = { type: 'admin', id: 'admin', name: 'Administrador' };
        saveSession('admin', { loggedIn: true, username, timestamp: Date.now() });
        currentView = 'admin-dashboard';
        showToast('‚úÖ Login realizado com sucesso!', 'success');
        
        // Log de auditoria
        await createAuditLog('admin_login', { username });
        
        await loadAllData();
        await renderAdminDashboard();
      } else {
        showToast('‚ùå Usu√°rio ou senha incorretos!', 'error');
      }
    }

    async function loginClient(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const token = formData.get('token')?.trim().toUpperCase();

      // Valida√ß√£o b√°sica do formato do token
      if (!token || token.length < 5 || !token.startsWith('TKN-')) {
        showToast('‚ùå Formato de token inv√°lido!', 'error');
        return;
      }

      await loadClients();
      const client = clients.find(c => c.token === token);

      if (!client) {
        showToast('‚ùå Token n√£o encontrado!', 'error');
        await createAuditLog('failed_client_login', { token: token.substring(0, 8) + '***' });
        return;
      }

      if (client.deleted) {
        showToast('‚ùå Token desativado!', 'error');
        await createAuditLog('login_deleted_client', { client_id: client.id });
        return;
      }

      if (parseInt(client.expiry) < Date.now()) {
        showToast('‚ùå Token expirado!', 'error');
        await createAuditLog('login_expired_client', { client_id: client.id });
        return;
      }

      currentUser = { type: 'client', id: client.id, name: client.client_name };
      saveSession('client', { clientId: client.id, token, expiry: client.expiry, timestamp: Date.now() });
      currentView = 'client-dashboard';
      showToast('‚úÖ Bem-vindo, ' + client.client_name + '!', 'success');
      await createAuditLog('client_login', { client_id: client.id });
      await loadAllData();
      await renderClientDashboard();
    }

    function logout() {
      clearSession('admin');
      clearSession('client');
      currentUser = null;
      currentView = 'login';
      if (html5QrCode) {
        html5QrCode.stop().catch(() => {});
        html5QrCode = null;
      }
      showToast('‚úÖ Logout realizado!', 'info');
      renderLogin();
    }

    // =============== ADMIN DASHBOARD ===============

    async function renderAdminDashboard() {
      const activeClients = clients.filter(c => parseInt(c.expiry) > Date.now());

      document.getElementById('app').innerHTML = `
        <div class="min-h-full flex flex-col" style="background-color: ${config.background_color};">
          <div class="p-4" style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%);">
            <div class="flex items-center justify-between">
              <div>
                <h1 class="font-bold mb-1" style="font-size: 28px; color: white;">
                  ${config.app_title}
                </h1>
                <p style="font-size: 14px; color: rgba(255,255,255,0.8);">
                  Painel do Administrador
                </p>
              </div>
              <button onclick="logout()" class="px-4 py-2 rounded-lg font-semibold" style="background-color: rgba(255,255,255,0.2); color: white;">
                Sair
              </button>
            </div>
          </div>

          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-6xl mx-auto">
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="p-6 rounded-2xl" style="background-color: ${config.card_color};">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">Total Clientes</p>
                  <p class="font-bold" style="font-size: 40px; color: ${config.primary_color};">${clients.length}</p>
                </div>
                <div class="p-6 rounded-2xl" style="background-color: ${config.card_color};">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">Clientes Ativos</p>
                  <p class="font-bold" style="font-size: 40px; color: ${config.success_color};">${activeClients.length}</p>
                </div>
                <div class="p-6 rounded-2xl" style="background-color: ${config.card_color};">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">Total Convidados</p>
                  <p class="font-bold" style="font-size: 40px; color: ${config.text_color};">${guests.length}</p>
                </div>
                <div class="p-6 rounded-2xl" style="background-color: ${config.card_color};">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">Total Check-ins</p>
                  <p class="font-bold" style="font-size: 40px; color: ${config.success_color};">${checkins.length}</p>
                </div>
              </div>

              <div class="mb-6 grid grid-cols-2 gap-4">
                <button onclick="showAddClientModal()" class="p-6 rounded-2xl font-bold" style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); color: white; font-size: 18px;">
                  ‚ûï Novo Cliente
                </button>
                <button onclick="showTrashModal()" class="p-6 rounded-2xl font-bold" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; font-size: 18px;">
                  üóëÔ∏è Lixeira
                </button>
              </div>

              <h2 class="font-bold mb-4" style="font-size: 28px; color: ${config.text_color};">
                Lista de Clientes
              </h2>
              
              <div class="space-y-3">
                ${clients.length === 0 ? `
                  <div class="p-8 rounded-2xl text-center" style="background-color: ${config.card_color};">
                    <p class="opacity-70" style="color: ${config.text_color};">Nenhum cliente cadastrado</p>
                  </div>
                ` : clients.map(client => {
                  const isExpired = parseInt(client.expiry) < Date.now();
                  const clientGuests = guests.filter(g => g.client_id === client.id);
                  const clientCheckins = checkins.filter(c => c.client_id === client.id);

                  return `
                    <div class="p-6 rounded-2xl" style="background-color: ${config.card_color};">
                      <div class="flex items-start justify-between">
                        <div class="flex-1">
                          <h3 class="font-bold mb-2 flex items-center gap-2" style="font-size: 20px; color: ${config.text_color};">
                            ${client.client_name}
                            ${client.is_vip ? `<span class="px-3 py-1 rounded-full text-xs font-bold vip-badge" style="color: white;">‚≠ê VIP</span>` : ''}
                            ${isExpired ? `<span class="px-3 py-1 rounded-full text-xs" style="background-color: rgba(239, 68, 68, 0.2); color: #ef4444;">‚è∞ Expirado</span>` : ''}
                          </h3>
                          <p class="opacity-70 mb-3" style="font-size: 14px; color: ${config.text_color};">
                            üé´ Token: <span class="font-mono font-bold" style="color: ${config.primary_color};">${client.token}</span>
                          </p>
                          <div class="flex gap-4">
                            <span class="px-3 py-1 rounded-lg text-sm" style="background-color: rgba(59, 130, 246, 0.2); color: #3b82f6;">
                              üë• ${clientGuests.length} convidados
                            </span>
                            <span class="px-3 py-1 rounded-lg text-sm" style="background-color: rgba(16, 185, 129, 0.2); color: ${config.success_color};">
                              ‚úì ${clientCheckins.length} check-ins
                            </span>
                          </div>
                        </div>
                        <div class="flex flex-col gap-2 ml-4">
                          <button onclick="showClientDetails('${client.id}')" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap" style="background-color: ${config.primary_color}; color: white;">
                            üìã Detalhes
                          </button>
                          <button onclick="exportClientPDF('${client.id}')" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap" style="background-color: #3b82f6; color: white;">
                            üìÑ PDF
                          </button>
                          <button onclick="toggleClientVIP('${client.id}')" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap" style="background-color: ${client.is_vip ? 'rgba(251, 191, 36, 0.3)' : 'rgba(148, 163, 184, 0.2)'}; color: ${client.is_vip ? config.vip_color : config.text_color};">
                            ${client.is_vip ? '‚≠ê Remover VIP' : '‚≠ê VIP'}
                          </button>
                          ${clientCheckins.length > 0 ? `
                            <button onclick="clearCheckins('${client.id}')" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap" style="background-color: rgba(251, 191, 36, 0.2); color: #f59e0b;">
                              üîÑ Limpar
                            </button>
                          ` : ''}
                          <button onclick="deleteClientConfirm('${client.id}')" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap" style="background-color: rgba(239, 68, 68, 0.2); color: #ef4444;">
                            üóëÔ∏è
                          </button>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // =============== CLIENT DASHBOARD ===============

    async function renderClientDashboard() {
      const client = clients.find(c => c.id === currentUser.id);
      
      if (!client || client.deleted || parseInt(client.expiry) < Date.now()) {
        showToast('‚ùå Sess√£o inv√°lida', 'error');
        logout();
        return;
      }
      
      if (currentTab === 'home') {
        await renderClientHome();
      } else if (currentTab === 'scanner') {
        await renderClientScanner();
      }
    }

    async function renderClientHome() {
      const client = clients.find(c => c.id === currentUser.id);
      const clientGuests = guests.filter(g => g.client_id === currentUser.id);
      const clientCheckins = checkins.filter(c => c.client_id === currentUser.id);
      const uniqueCheckins = clientCheckins.filter(c => !c.is_companion_only).length;

      document.getElementById('app').innerHTML = `
        <div class="min-h-full flex flex-col" style="background-color: ${config.background_color};">
          <div class="p-4" style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%);">
            <div class="flex items-center justify-between">
              <div>
                <h1 class="font-bold mb-1" style="font-size: 28px; color: white;">
                  ${config.app_title}
                  ${client.is_vip ? `<span class="px-2 py-1 rounded text-sm vip-badge ml-2">‚≠ê</span>` : ''}
                </h1>
                <p style="font-size: 14px; color: white;">${currentUser.name}</p>
              </div>
              <button onclick="logout()" class="px-4 py-2 rounded-lg font-semibold" style="background-color: rgba(255,255,255,0.2); color: white;">
                Sair
              </button>
            </div>
          </div>

          <div class="flex border-b" style="background-color: ${config.card_color};">
            <button onclick="switchClientTab('home')" class="flex-1 py-4 font-semibold" style="color: ${config.primary_color}; border-bottom: 3px solid ${config.primary_color};">
              üè† In√≠cio
            </button>
            <button onclick="switchClientTab('scanner')" class="flex-1 py-4 font-semibold" style="color: ${config.text_color};">
              üì∑ Scanner
            </button>
          </div>

          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-4xl mx-auto">
              <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-6 rounded-2xl text-center" style="background-color: ${config.card_color};">
                  <p class="opacity-70 mb-2" style="color: ${config.text_color};">Convidados</p>
                  <p class="font-bold" style="font-size: 32px; color: ${config.primary_color};">${clientGuests.length}</p>
                </div>
                <div class="p-6 rounded-2xl text-center" style="background-color: ${config.card_color};">
                  <p class="opacity-70 mb-2" style="color: ${config.text_color};">Check-ins</p>
                  <p class="font-bold" style="font-size: 32px; color: ${config.success_color};">${uniqueCheckins}</p>
                </div>
              </div>

              <h2 class="font-bold mb-4" style="font-size: 24px; color: ${config.text_color};">Lista de Convidados</h2>

              <input 
                type="text" 
                id="guest-search"
                placeholder="üîç Pesquisar..."
                class="w-full px-4 py-3 rounded-xl outline-none mb-4"
                style="background-color: ${config.card_color}; color: ${config.text_color};"
                oninput="searchGuests(this.value)"
              >

              <div id="guests-list" class="space-y-3">
                ${renderGuestsList(clientGuests, clientCheckins)}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderGuestsList(filteredGuests, clientCheckins) {
      if (filteredGuests.length === 0) {
        return `<div class="p-8 rounded-2xl text-center" style="background-color: ${config.card_color};">
          <p class="opacity-70" style="color: ${config.text_color};">Nenhum convidado encontrado</p>
        </div>`;
      }

      return filteredGuests.map(guest => {
        const mainCheckin = clientCheckins.find(c => c.guest_qr === guest.qr_code && !c.is_companion_only);
        let displayName = guest.name.includes(',') ? guest.name.split(',').pop().trim() : guest.name;

        return `
          <div class="p-4 rounded-xl" style="background-color: ${config.card_color};">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-bold flex items-center gap-2" style="font-size: 18px; color: ${config.text_color};">
                  ${guest.is_vip ? `<span class="vip-badge px-2 py-1 rounded text-xs">‚≠ê</span>` : ''}
                  ${displayName}
                  ${guest.has_companion ? `<span class="opacity-70">üë•</span>` : ''}
                </h3>
                ${mainCheckin ? `
                  <p class="text-sm" style="color: ${config.success_color};">
                    ‚úÖ ${new Date(mainCheckin.checked_in_at).toLocaleString('pt-BR')}
                  </p>
                ` : ''}
              </div>
              ${mainCheckin ? `
                <span class="px-4 py-2 rounded-lg font-bold" style="background-color: rgba(16, 185, 129, 0.2); color: ${config.success_color};">‚úì</span>
              ` : `
                <span class="px-4 py-2 rounded-lg opacity-50" style="background-color: ${config.background_color}; color: ${config.text_color};">Pendente</span>
              `}
            </div>
          </div>
        `;
      }).join('');
    }

    function searchGuests(query) {
      currentSearchQuery = query.toLowerCase();
      updateGuestsList();
    }

    function updateGuestsList() {
      const clientGuests = guests.filter(g => g.client_id === currentUser.id);
      const clientCheckins = checkins.filter(c => c.client_id === currentUser.id);
      
      let filteredGuests = clientGuests;
      if (currentSearchQuery) {
        filteredGuests = filteredGuests.filter(g => 
          g.name.toLowerCase().includes(currentSearchQuery)
        );
      }
      
      const guestsList = document.getElementById('guests-list');
      if (guestsList) {
        guestsList.innerHTML = renderGuestsList(filteredGuests, clientCheckins);
      }
    }

    function switchClientTab(tab) {
      currentTab = tab;
      renderClientDashboard();
    }

    // =============== SCANNER ===============

    async function renderClientScanner() {
      document.getElementById('app').innerHTML = `
        <div class="h-full flex flex-col" style="background-color: ${config.background_color};">
          <div class="p-3 flex items-center justify-between" style="background-color: ${config.card_color};">
            <button onclick="switchClientTab('home')" class="px-3 py-2 rounded-lg" style="background-color: ${config.primary_color}; color: white;">
              ‚Üê Voltar
            </button>
            <h1 class="font-bold" style="font-size: 20px; color: ${config.text_color};">Scanner QR Code</h1>
            <button onclick="logout()" class="px-3 py-2 rounded-lg" style="background-color: rgba(239, 68, 68, 0.2); color: #ef4444;">
              Sair
            </button>
          </div>

          <div class="flex-1" style="background-color: #000;">
            <div id="qr-reader" class="h-full"></div>
          </div>

          <div class="p-4 text-center" style="background-color: ${config.card_color};">
            <p class="opacity-70" style="color: ${config.text_color};">üì∑ Aponte para o QR Code</p>
          </div>
        </div>
      `;

      setTimeout(startQrScanner, 100);
    }

    function startQrScanner() {
      if (html5QrCode) {
        html5QrCode.stop().catch(() => {});
      }

      html5QrCode = new Html5Qrcode("qr-reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (decodedText) => processQrCode(decodedText)
      ).catch(err => showToast('‚ùå Erro ao acessar c√¢mera', 'error'));
    }

    async function processQrCode(qrCode) {
      if (!qrCode || !html5QrCode) return;
      html5QrCode.pause(true);

      const clientGuests = guests.filter(g => g.client_id === currentUser.id);
      const guest = clientGuests.find(g => g.qr_code === qrCode.trim());

      if (!guest) {
        showErrorAnimation('ENTRADA N√ÉO PERMITIDA', 'Convidado n√£o autorizado');
        setTimeout(() => { if (html5QrCode) html5QrCode.resume(); }, 2500);
        return;
      }

      const clientCheckins = checkins.filter(c => c.client_id === currentUser.id);
      const existingCheckins = clientCheckins.filter(c => c.guest_qr === qrCode.trim());

      if (existingCheckins.length > 0 && (!guest.has_companion || existingCheckins.length >= 2)) {
        showErrorAnimation('ENTRADA N√ÉO PERMITIDA', 'Convite j√° usado');
        setTimeout(() => { if (html5QrCode) html5QrCode.resume(); }, 2500);
        return;
      }

      if (guest.has_companion && existingCheckins.length === 0) {
        showCompanionChoice(guest, qrCode.trim());
      } else {
        await performCheckin(guest, qrCode.trim(), false, existingCheckins.length === 1);
      }
    }

    function showCompanionChoice(guest, qrCode) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'companion-modal';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8 text-center" style="background-color: ${config.card_color};">
          <div class="text-6xl mb-4">üë•</div>
          <h2 class="font-bold mb-4" style="font-size: 24px; color: ${config.text_color};">
            ${guest.name}
          </h2>
          <p class="mb-6 opacity-70" style="color: ${config.text_color};">Entrou com acompanhante?</p>
          <div class="flex gap-3">
            <button onclick="confirmCheckin('${qrCode}', false)" class="flex-1 py-4 rounded-xl font-bold" style="background-color: ${config.background_color}; color: ${config.text_color};">
              N√ÉO
            </button>
            <button onclick="confirmCheckin('${qrCode}', true)" class="flex-1 py-4 rounded-xl font-bold" style="background-color: ${config.success_color}; color: white;">
              SIM
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function confirmCheckin(qrCode, withCompanion) {
      closeModal('companion-modal');
      const clientGuests = guests.filter(g => g.client_id === currentUser.id);
      const guest = clientGuests.find(g => g.qr_code === qrCode);
      await performCheckin(guest, qrCode, withCompanion, false);
    }

    async function performCheckin(guest, qrCode, withCompanion, isCompanionOnly) {
      const checkinData = {
        id: generateId('checkin'),
        client_id: currentUser.id,
        guest_id: guest.id,
        guest_qr: qrCode,
        guest_name: guest.name,
        with_companion: withCompanion,
        is_companion_only: isCompanionOnly,
        status: 'confirmed',
        checked_in_at: new Date().toISOString()
      };

      const result = await createCheckin(checkinData);

      if (result.success) {
        let message = guest.name;
        if (isCompanionOnly) message = 'Acompanhante de ' + message;
        if (withCompanion) message += ' + Acompanhante';
        if (guest.is_vip) message = '‚≠ê VIP - ' + message;
        
        showSuccessAnimation('ENTRADA APROVADA', message);
        setTimeout(() => { if (html5QrCode) html5QrCode.resume(); }, 3000);
      } else {
        showErrorAnimation('ERRO', 'Tente novamente');
        setTimeout(() => { if (html5QrCode) html5QrCode.resume(); }, 2500);
      }
    }

    function showSuccessAnimation(title, message) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.zIndex = '10000';
      
      overlay.innerHTML = `
        <div class="text-center animate-slide-in">
          <div class="text-8xl mb-6">‚úÖ</div>
          <div class="font-bold mb-3" style="font-size: 32px; color: ${config.success_color};">
            ${title}
          </div>
          <div class="font-bold" style="font-size: 28px; color: white;">
            ${message}
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      setTimeout(() => overlay.remove(), 3000);
    }

    function showErrorAnimation(title, message) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.zIndex = '10000';
      
      overlay.innerHTML = `
        <div class="text-center animate-slide-in">
          <div class="text-8xl mb-6">‚ùå</div>
          <div class="font-bold mb-3" style="font-size: 32px; color: ${config.error_color};">
            ${title}
          </div>
          <div class="font-semibold" style="font-size: 20px; color: white;">
            ${message}
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      setTimeout(() => overlay.remove(), 2500);
    }

    // =============== ADMIN MODALS ===============

    async function showTrashModal() {
      const deletedClients = await supabase
        .from('clients')
        .select('*')
        .eq('deleted', true)
        .order('deleted_at', { ascending: false });
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'trash-modal';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8" style="background-color: ${config.card_color};">
          <h2 class="font-bold mb-6" style="font-size: 28px; color: ${config.text_color};">üóëÔ∏è Lixeira</h2>
          
          <div class="space-y-3 mb-6 max-h-96 overflow-auto">
            ${!deletedClients.data || deletedClients.data.length === 0 ? `
              <p class="text-center opacity-70 py-8" style="color: ${config.text_color};">Lixeira vazia</p>
            ` : deletedClients.data.map(client => `
              <div class="p-4 rounded-xl" style="background-color: ${config.background_color};">
                <div class="flex items-center justify-between">
                  <div>
                    <h3 class="font-bold" style="font-size: 18px; color: ${config.text_color};">
                      ${client.client_name}
                      ${client.is_vip ? `<span class="px-2 py-1 rounded text-xs vip-badge ml-2">‚≠ê</span>` : ''}
                    </h3>
                    <p class="text-sm opacity-70" style="color: ${config.text_color};">
                      Deletado em: ${new Date(client.deleted_at).toLocaleString('pt-BR')}
                    </p>
                  </div>
                  <div class="flex gap-2">
                    <button onclick="restoreClient('${client.id}')" class="px-4 py-2 rounded-lg font-semibold" style="background-color: ${config.success_color}; color: white;">
                      ‚Ü©Ô∏è Restaurar
                    </button>
                    <button onclick="permanentDeleteClient('${client.id}')" class="px-4 py-2 rounded-lg font-semibold" style="background-color: ${config.error_color}; color: white;">
                      üóëÔ∏è Deletar
                    </button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
          
          <div class="flex gap-3">
            ${deletedClients.data && deletedClients.data.length > 0 ? `
              <button onclick="deleteAllFromTrash()" class="flex-1 py-3 rounded-xl font-semibold" style="background-color: ${config.error_color}; color: white;">
                üóëÔ∏è Deletar Todos (${deletedClients.data.length})
              </button>
            ` : ''}
            <button onclick="closeModal('trash-modal')" class="flex-1 py-3 rounded-xl font-semibold" style="background-color: ${config.background_color}; color: ${config.text_color};">
              Fechar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function restoreClient(clientId) {
      const { error } = await supabase
        .from('clients')
        .update({ deleted: false, deleted_at: null })
        .eq('id', clientId);
      
      if (!error) {
        await supabase
          .from('guests')
          .update({ deleted: false, deleted_at: null })
          .eq('client_id', clientId);
        
        await loadAllData();
        showToast('‚úÖ Cliente restaurado!', 'success');
        closeModal('trash-modal');
        await renderAdminDashboard();
      } else {
        showToast('‚ùå Erro ao restaurar cliente', 'error');
      }
    }

    async function permanentDeleteClient(clientId) {
      if (!confirm('‚ö†Ô∏è DELETAR PERMANENTEMENTE?\n\nEsta a√ß√£o n√£o pode ser desfeita!')) return;
      
      await supabase.from('checkins').delete().eq('client_id', clientId);
      await supabase.from('guests').delete().eq('client_id', clientId);
      await supabase.from('clients').delete().eq('id', clientId);
      
      await loadAllData();
      showToast('‚úÖ Cliente deletado permanentemente!', 'success');
      closeModal('trash-modal');
      await renderAdminDashboard();
    }

    async function deleteAllFromTrash() {
      const deletedClients = await supabase
        .from('clients')
        .select('*')
        .eq('deleted', true);
      
      if (!deletedClients.data || deletedClients.data.length === 0) return;
      
      if (!confirm(`‚ö†Ô∏è DELETAR TODOS OS ${deletedClients.data.length} CLIENTES DA LIXEIRA?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) return;
      
      for (const client of deletedClients.data) {
        await supabase.from('checkins').delete().eq('client_id', client.id);
        await supabase.from('guests').delete().eq('client_id', client.id);
        await supabase.from('clients').delete().eq('id', client.id);
      }
      
      await loadAllData();
      showToast(`‚úÖ ${deletedClients.data.length} clientes deletados permanentemente!`, 'success');
      closeModal('trash-modal');
      await renderAdminDashboard();
    }

    function showAddClientModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'add-client-modal';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8" style="background-color: ${config.card_color};">
          <h2 class="font-bold mb-6" style="font-size: 28px; color: ${config.text_color};">‚ûï Novo Cliente</h2>
          <form onsubmit="submitNewClient(event); return false;">
            <div class="mb-4">
              <label class="block mb-2 font-semibold" style="color: ${config.text_color};">Nome do Cliente</label>
              <input type="text" name="client_name" required class="w-full px-4 py-3 rounded-xl outline-none" style="background-color: ${config.background_color}; color: ${config.text_color};" placeholder="Digite o nome do cliente">
            </div>
            <div class="mb-4">
              <label class="block mb-2 font-semibold" style="color: ${config.text_color};">‚è∞ Validade do Token</label>
              <select name="expiry_days" required class="w-full px-4 py-3 rounded-xl outline-none" style="background-color: ${config.background_color}; color: ${config.text_color};">
                <option value="1">1 dia</option>
                <option value="2">2 dias</option>
                <option value="3">3 dias</option>
                <option value="7">1 semana</option>
                <option value="14">2 semanas</option>
                <option value="30" selected>1 m√™s</option>
                <option value="60">2 meses</option>
                <option value="90">3 meses</option>
                <option value="180">6 meses</option>
                <option value="365">1 ano</option>
              </select>
            </div>
            <div class="mb-4">
              <label class="flex items-center cursor-pointer">
                <input type="checkbox" name="is_vip" class="mr-2 w-5 h-5">
                <span style="color: ${config.text_color};">‚≠ê Cliente VIP</span>
              </label>
            </div>
            <div class="mb-6">
              <label class="block mb-2 font-semibold" style="color: ${config.text_color};">üìã Lista de Convidados</label>
              <label class="w-full py-3 px-4 rounded-xl font-semibold cursor-pointer flex items-center justify-center gap-2" style="background-color: ${config.primary_color}; color: white;">
                üìÅ Carregar arquivo TXT
                <input type="file" id="guest-file-upload" accept=".txt" onchange="handleFileUpload(event)" class="hidden">
              </label>
              <p class="text-xs opacity-50 mt-2 text-center" style="color: ${config.text_color};">üí° Use "e Acompanhante" ou "e 1" para permitir acompanhantes</p>
              <textarea id="guest-list-textarea" name="guest_list" rows="1" class="hidden"></textarea>
            </div>
            <div class="flex gap-3">
              <button type="button" onclick="closeModal('add-client-modal')" class="flex-1 py-3 rounded-xl font-semibold" style="background-color: ${config.background_color}; color: ${config.text_color};">
                Cancelar
              </button>
              <button type="submit" class="flex-1 py-3 rounded-xl font-semibold" style="background-color: ${config.primary_color}; color: white;">
                Criar
              </button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function submitNewClient(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const expiryDays = parseInt(formData.get('expiry_days'));
      
      const clientData = {
        id: generateId('client'),
        client_name: formData.get('client_name'),
        token: generateToken(),
        is_vip: formData.get('is_vip') === 'on',
        expiry: (Date.now() + (expiryDays * 24 * 60 * 60 * 1000)).toString(),
        deleted: false,
        created_at: new Date().toISOString()
      };
      
      const result = await createClient(clientData);
      
      if (!result.success) {
        showToast('‚ùå Erro ao criar cliente', 'error');
        return;
      }

      const guestListRaw = formData.get('guest_list');
      if (guestListRaw?.trim()) {
        const parsedGuests = parseGuestList(guestListRaw);
        
        if (parsedGuests.length > 0) {
          const guestsToCreate = parsedGuests.map(pg => ({
            id: generateId('guest'),
            client_id: clientData.id,
            name: pg.name,
            qr_code: generateId('QR'),
            has_companion: pg.has_companion,
            is_vip: false,
            deleted: false,
            created_at: new Date().toISOString()
          }));
          
          await createMultipleGuests(guestsToCreate);
        }
      }
      
      showToast('‚úÖ Cliente criado com sucesso!', 'success');
      closeModal('add-client-modal');
      await renderAdminDashboard();
    }

    function showClientDetails(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (!client) return;
      
      const clientGuests = guests.filter(g => g.client_id === clientId);
      const clientCheckins = checkins.filter(c => c.client_id === clientId);
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'client-details-modal';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8" style="background-color: ${config.card_color};">
          <div class="flex items-center justify-between mb-6">
            <h2 class="font-bold" style="font-size: 28px; color: ${config.text_color};">
              üìã ${client.client_name}
            </h2>
            ${clientCheckins.length > 0 ? `
              <button onclick="showCheckinsManagement('${clientId}')" class="px-4 py-2 rounded-xl font-semibold" style="background-color: rgba(251, 191, 36, 0.2); color: #f59e0b;">
                üîÑ Gerir Check-ins
              </button>
            ` : ''}
          </div>
          
          <div class="mb-6">
            <p class="mb-2" style="color: ${config.text_color};">
              <strong>Token:</strong> <span style="color: ${config.primary_color};">${client.token}</span>
            </p>
            <p class="mb-2" style="color: ${config.text_color};">
              <strong>Convidados:</strong> ${clientGuests.length}
            </p>
            <p style="color: ${config.text_color};">
              <strong>Check-ins:</strong> ${clientCheckins.length}
            </p>
          </div>

          <div class="flex gap-2 mb-4">
            <label class="flex-1 py-3 px-4 rounded-xl font-semibold cursor-pointer flex items-center justify-center gap-2" style="background-color: ${config.primary_color}; color: white;">
              üìÅ Adicionar Convidados
              <input type="file" id="add-guests-file-upload" accept=".txt" onchange="handleAddGuestsFile(event, '${clientId}')" class="hidden">
            </label>
            ${clientGuests.length > 0 ? `
              <button onclick="deleteAllGuestsConfirm('${clientId}')" class="py-3 px-4 rounded-xl font-semibold whitespace-nowrap" style="background-color: rgba(239, 68, 68, 0.2); color: #ef4444;">
                üóëÔ∏è Todos
              </button>
            ` : ''}
          </div>
          <p class="text-xs opacity-50 mb-4 text-center" style="color: ${config.text_color};">üí° Novos convidados ser√£o adicionados sem duplicar</p>
          
          <h3 class="font-bold mb-3" style="font-size: 20px; color: ${config.text_color};">Convidados</h3>
          
          <div class="space-y-2 mb-6 max-h-96 overflow-auto">
            ${clientGuests.length === 0 ? `
              <p class="text-center opacity-70 py-4" style="color: ${config.text_color};">Nenhum convidado</p>
            ` : clientGuests.map(guest => {
              const hasCheckedIn = clientCheckins.some(c => c.guest_qr === guest.qr_code);
              return `
                <div class="p-3 rounded-lg flex items-center justify-between" style="background-color: ${config.background_color};">
                  <div>
                    <p class="font-bold" style="color: ${config.text_color};">
                      ${guest.is_vip ? '‚≠ê ' : ''}${guest.name}${guest.has_companion ? ' üë•' : ''}
                    </p>
                  </div>
                  <div class="flex gap-2">
                    ${hasCheckedIn ? `<span class="px-2 py-1 rounded text-xs" style="background-color: rgba(16, 185, 129, 0.2); color: ${config.success_color};">‚úì</span>` : ''}
                    <button onclick="toggleGuestVIP('${guest.id}')" class="px-2 py-1 rounded text-xs" style="background-color: ${guest.is_vip ? 'rgba(251, 191, 36, 0.3)' : 'rgba(148, 163, 184, 0.2)'}; color: ${guest.is_vip ? config.vip_color : config.text_color};">
                      ${guest.is_vip ? '‚≠ê' : '‚òÖ'}
                    </button>
                    <button onclick="deleteGuestConfirm('${guest.id}')" class="px-2 py-1 rounded text-xs" style="background-color: rgba(239, 68, 68, 0.2); color: #ef4444;">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          
          <button onclick="closeModal('client-details-modal')" class="w-full py-3 rounded-xl font-semibold" style="background-color: ${config.background_color}; color: ${config.text_color};">
            Fechar
          </button>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function handleAddGuestsFile(event, clientId) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.name.toLowerCase().endsWith('.txt')) {
        showToast('‚ùå Por favor, selecione um arquivo TXT', 'error');
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = async function(e) {
        const content = e.target.result;
        const parsedGuests = parseGuestList(content);
        
        if (parsedGuests.length === 0) {
          showToast('‚ùå Nenhum convidado encontrado no arquivo', 'error');
          event.target.value = '';
          return;
        }

        const clientGuests = guests.filter(g => g.client_id === clientId);
        const existingNames = new Set(clientGuests.map(g => g.name.toLowerCase().trim()));
        
        const newGuests = parsedGuests.filter(pg => 
          !existingNames.has(pg.name.toLowerCase().trim())
        );

        if (newGuests.length === 0) {
          showToast('‚ö†Ô∏è Todos os convidados j√° existem', 'warning');
          event.target.value = '';
          return;
        }

        const guestsToCreate = newGuests.map(pg => ({
          id: generateId('guest'),
          client_id: clientId,
          name: pg.name,
          qr_code: generateId('QR'),
          has_companion: pg.has_companion,
          is_vip: false,
          deleted: false,
          created_at: new Date().toISOString()
        }));

        const result = await createMultipleGuests(guestsToCreate);
        
        if (result.success) {
          showToast(`‚úÖ ${newGuests.length} convidados adicionados!`, 'success');
          closeModal('client-details-modal');
          showClientDetails(clientId);
        } else {
          showToast('‚ùå Erro ao adicionar convidados', 'error');
        }
        
        event.target.value = '';
      };
      
      reader.onerror = function() {
        showToast('‚ùå Erro ao ler arquivo', 'error');
        event.target.value = '';
      };
      
      reader.readAsText(file);
    }

    async function toggleClientVIP(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (!client) return;
      
      await updateClient(clientId, { is_vip: !client.is_vip });
      showToast(client.is_vip ? '‚úÖ VIP removido' : '‚≠ê VIP ativado', 'success');
      await renderAdminDashboard();
    }

    async function toggleGuestVIP(guestId) {
      const guest = guests.find(g => g.id === guestId);
      if (!guest) return;
      
      await updateGuest(guestId, { is_vip: !guest.is_vip });
      showToast(guest.is_vip ? '‚úÖ VIP removido' : '‚≠ê VIP ativado', 'success');
      closeModal('client-details-modal');
      showClientDetails(guest.client_id);
    }

    async function clearCheckins(clientId) {
      if (!confirm('Limpar todos os check-ins deste cliente?')) return;
      await deleteAllClientCheckins(clientId);
      showToast('‚úÖ Check-ins limpos!', 'success');
      await renderAdminDashboard();
    }

    async function deleteClientConfirm(clientId) {
      if (!confirm('Deletar este cliente?')) return;
      await deleteClient(clientId);
      showToast('‚úÖ Cliente deletado!', 'success');
      await renderAdminDashboard();
    }

    async function deleteGuestConfirm(guestId) {
      const guest = guests.find(g => g.id === guestId);
      if (!guest || !confirm('Deletar este convidado?')) return;
      await deleteGuest(guestId);
      showToast('‚úÖ Convidado deletado!', 'success');
      closeModal('client-details-modal');
      showClientDetails(guest.client_id);
    }

    async function deleteAllGuestsConfirm(clientId) {
      const clientGuests = guests.filter(g => g.client_id === clientId);
      if (clientGuests.length === 0) return;
      
      if (!confirm(`üóëÔ∏è Deletar TODOS os ${clientGuests.length} convidados?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) return;
      
      const { error } = await supabase
        .from('guests')
        .update({ deleted: true, deleted_at: new Date().toISOString() })
        .eq('client_id', clientId);
      
      if (!error) {
        await loadGuests();
        await createAuditLog('delete_all_guests', { client_id: clientId, count: clientGuests.length });
        showToast(`‚úÖ ${clientGuests.length} convidados deletados!`, 'success');
        closeModal('client-details-modal');
        showClientDetails(clientId);
      } else {
        showToast('‚ùå Erro ao deletar convidados', 'error');
      }
    }

    function showCheckinsManagement(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (!client) return;
      
      const clientCheckins = checkins.filter(c => c.client_id === clientId);
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'checkins-management-modal';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8" style="background-color: ${config.card_color};">
          <h2 class="font-bold mb-6" style="font-size: 28px; color: ${config.text_color};">
            üîÑ Gest√£o de Check-ins - ${client.client_name}
          </h2>
          
          <div class="mb-4 p-4 rounded-xl" style="background-color: rgba(251, 191, 36, 0.1);">
            <p class="text-sm" style="color: ${config.text_color};">
              ‚ö†Ô∏è <strong>Aten√ß√£o:</strong> Desfazer check-ins permite que o convidado escaneie novamente.
            </p>
          </div>

          <div class="space-y-2 mb-6 max-h-96 overflow-auto">
            ${clientCheckins.length === 0 ? `
              <p class="text-center opacity-70 py-8" style="color: ${config.text_color};">Nenhum check-in realizado</p>
            ` : clientCheckins.sort((a, b) => new Date(b.checked_in_at) - new Date(a.checked_in_at)).map(checkin => {
              const guest = guests.find(g => g.qr_code === checkin.guest_qr);
              return `
                <div class="p-4 rounded-xl flex items-center justify-between" style="background-color: ${config.background_color};">
                  <div class="flex-1">
                    <h3 class="font-bold mb-1" style="font-size: 16px; color: ${config.text_color};">
                      ${guest?.is_vip ? '‚≠ê ' : ''}${checkin.guest_name}
                      ${checkin.is_companion_only ? ' <span class="text-xs opacity-70">(Acompanhante)</span>' : ''}
                      ${checkin.with_companion ? ' üë•' : ''}
                    </h3>
                    <p class="text-sm opacity-70" style="color: ${config.text_color};">
                      ${new Date(checkin.checked_in_at).toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                      })}
                    </p>
                  </div>
                  <button onclick="undoCheckin('${checkin.id}', '${clientId}')" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap" style="background-color: rgba(239, 68, 68, 0.2); color: #ef4444;">
                    ‚Ü©Ô∏è Desfazer
                  </button>
                </div>
              `;
            }).join('')}
          </div>
          
          <div class="flex gap-3">
            ${clientCheckins.length > 0 ? `
              <button onclick="clearAllCheckinsConfirm('${clientId}')" class="flex-1 py-3 rounded-xl font-semibold" style="background-color: ${config.error_color}; color: white;">
                üóëÔ∏è Limpar Todos (${clientCheckins.length})
              </button>
            ` : ''}
            <button onclick="closeModal('checkins-management-modal'); showClientDetails('${clientId}');" class="flex-1 py-3 rounded-xl font-semibold" style="background-color: ${config.background_color}; color: ${config.text_color};">
              Voltar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function undoCheckin(checkinId, clientId) {
      if (!confirm('Desfazer este check-in?\n\nO convidado poder√° escanear novamente.')) return;
      
      const result = await deleteCheckin(checkinId);
      
      if (result.success) {
        showToast('‚úÖ Check-in desfeito!', 'success');
        closeModal('checkins-management-modal');
        showCheckinsManagement(clientId);
      } else {
        showToast('‚ùå Erro ao desfazer check-in', 'error');
      }
    }

    async function clearAllCheckinsConfirm(clientId) {
      const clientCheckins = checkins.filter(c => c.client_id === clientId);
      if (!confirm(`üóëÔ∏è Limpar TODOS os ${clientCheckins.length} check-ins?\n\nTodos os convidados poder√£o escanear novamente!`)) return;
      
      const result = await deleteAllClientCheckins(clientId);
      
      if (result.success) {
        showToast('‚úÖ Todos os check-ins foram limpos!', 'success');
        closeModal('checkins-management-modal');
        await renderAdminDashboard();
      } else {
        showToast('‚ùå Erro ao limpar check-ins', 'error');
      }
    }

    // =============== REALTIME SUBSCRIPTIONS ===============

    let clientsSubscription = null;
    let guestsSubscription = null;
    let checkinsSubscription = null;

    function setupRealtimeSubscriptions() {
      clientsSubscription = supabase
        .channel('clients-changes')
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'clients' },
          async (payload) => {
            await loadClients();
            if (currentView === 'admin-dashboard') {
              await renderAdminDashboard();
            }
          }
        )
        .subscribe();

      guestsSubscription = supabase
        .channel('guests-changes')
        .on('postgres_changes',
          { event: '*', schema: 'public', table: 'guests' },
          async (payload) => {
            await loadGuests();
            if (currentView === 'admin-dashboard') {
              await renderAdminDashboard();
            } else if (currentView === 'client-dashboard' && currentTab === 'home') {
              updateGuestsList();
            }
          }
        )
        .subscribe();

      checkinsSubscription = supabase
        .channel('checkins-changes')
        .on('postgres_changes',
          { event: '*', schema: 'public', table: 'checkins' },
          async (payload) => {
            await loadCheckins();
            if (currentView === 'admin-dashboard') {
              await renderAdminDashboard();
            } else if (currentView === 'client-dashboard' && currentTab === 'home') {
              updateGuestsList();
            }
          }
        )
        .subscribe();
    }

    // =============== INIT ===============

    renderLogin();
    checkExistingSession();
    setupRealtimeSubscriptions();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9acd3dfc76e5c13d',t:'MTc2NTU0MjcyMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>