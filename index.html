<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AdKira Check-In</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes fall {
      to {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }
    
    .animate-slide-in {
      animation: slideIn 0.4s ease-out;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 14px;
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
      max-width: 90%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9000;
      padding: 16px;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-content {
      animation: slideIn 0.3s ease-out;
      max-width: 600px;
      width: 100%;
      max-height: 90%;
      overflow-y: auto;
    }

    #qr-reader {
      width: 100% !important;
      border: none !important;
    }

    #qr-reader__scan_region {
      border: 3px solid #007f9f !important;
    }

    .tab-button {
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }

    .tab-button.active {
      border-bottom-color: #007f9f;
    }

    .confetti {
      position: fixed;
      animation: fall 3s linear;
    }

    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full" style="background-color: #0a1929;">
  <div id="app" class="h-full w-full overflow-auto">
   <div class="flex items-center justify-center h-full">
    <div class="loading-spinner"></div>
   </div>
  </div>
  <script>
    const SUPABASE_URL = 'https://sekkrboqttxpathyxcun.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNla2tyYm9xdHR4cGF0aHl4Y3VuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNjY0OTYsImV4cCI6MjA3OTc0MjQ5Nn0.JqrLUWHs3-jyUNT-0s2DwiyeDjK0uv6uIh0ip1qPWBA';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const config = {
      primary_color: "#007f9f",
      background_color: "#0a1929",
      card_color: "#132f4c",
      text_color: "#ffffff",
      success_color: "#10b981",
      app_title: "AdKira Check-In"
    };

    let clients = [];
    let guests = [];
    let checkins = [];
    let currentView = 'login';
    let currentUser = null;
    let currentTab = 'home';
    let html5QrCode = null;
    let offlineQueue = [];
    let isOnline = navigator.onLine;

    const STORAGE_KEYS = {
      ADMIN_SESSION: 'adkira_admin_session',
      CLIENT_SESSION: 'adkira_client_session',
      OFFLINE_QUEUE: 'adkira_offline_queue'
    };

    // =============== SUPABASE FUNCTIONS ===============

    async function loadClients() {
      try {
        const { data, error } = await supabase
          .from('clients')
          .select('*')
          .eq('deleted', false)
          .order('created_at', { ascending: false });

        if (error) throw error;
        clients = data || [];
        return true;
      } catch (error) {
        console.error('Erro ao carregar clientes:', error);
        return false;
      }
    }

    async function loadGuests() {
      try {
        const { data, error } = await supabase
          .from('guests')
          .select('*')
          .eq('deleted', false)
          .order('created_at', { ascending: false });

        if (error) throw error;
        guests = data || [];
        return true;
      } catch (error) {
        console.error('Erro ao carregar convidados:', error);
        return false;
      }
    }

    async function loadCheckins() {
      try {
        const { data, error } = await supabase
          .from('checkins')
          .select('*')
          .order('checked_in_at', { ascending: false });

        if (error) throw error;
        checkins = data || [];
        return true;
      } catch (error) {
        console.error('Erro ao carregar check-ins:', error);
        return false;
      }
    }

    async function loadAllData() {
      const results = await Promise.all([
        loadClients(),
        loadGuests(),
        loadCheckins()
      ]);
      return results.every(r => r === true);
    }

    async function validateAdminCredentials(username, password) {
      try {
        const { data, error } = await supabase
          .from('admin_credentials')
          .select('*')
          .eq('username', username)
          .eq('password', password)
          .eq('active', true)
          .single();

        if (error || !data) return false;
        return true;
      } catch (error) {
        console.error('Erro ao validar admin:', error);
        return false;
      }
    }

    async function createClient(clientData) {
      try {
        const { data, error } = await supabase
          .from('clients')
          .insert([clientData])
          .select();

        if (error) throw error;
        await loadClients();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao criar cliente:', error);
        return { success: false, error };
      }
    }

    async function updateClient(clientId, updates) {
      try {
        const { data, error } = await supabase
          .from('clients')
          .update(updates)
          .eq('id', clientId)
          .select();

        if (error) throw error;
        await loadClients();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao atualizar cliente:', error);
        return { success: false, error };
      }
    }

    async function deleteClient(clientId) {
      try {
        const { data, error } = await supabase
          .from('clients')
          .update({ deleted: true, deleted_at: new Date().toISOString() })
          .eq('id', clientId)
          .select();

        if (error) throw error;
        await loadClients();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao deletar cliente:', error);
        return { success: false, error };
      }
    }

    async function restoreClient(clientId) {
      try {
        const { data, error } = await supabase
          .from('clients')
          .update({ deleted: false, deleted_at: null })
          .eq('id', clientId)
          .select();

        if (error) throw error;
        await loadClients();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao restaurar cliente:', error);
        return { success: false, error };
      }
    }

    async function loadDeletedClients() {
      try {
        const { data, error } = await supabase
          .from('clients')
          .select('*')
          .eq('deleted', true)
          .order('deleted_at', { ascending: false });

        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Erro ao carregar clientes deletados:', error);
        return [];
      }
    }

    async function createGuest(guestData) {
      try {
        const { data, error } = await supabase
          .from('guests')
          .insert([guestData])
          .select();

        if (error) throw error;
        await loadGuests();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao criar convidado:', error);
        return { success: false, error };
      }
    }

    async function deleteGuest(guestId) {
      try {
        const { data, error } = await supabase
          .from('guests')
          .update({ deleted: true, deleted_at: new Date().toISOString() })
          .eq('id', guestId)
          .select();

        if (error) throw error;
        await loadGuests();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao deletar convidado:', error);
        return { success: false, error };
      }
    }

    async function restoreGuest(guestId) {
      try {
        const { data, error } = await supabase
          .from('guests')
          .update({ deleted: false, deleted_at: null })
          .eq('id', guestId)
          .select();

        if (error) throw error;
        await loadGuests();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao restaurar convidado:', error);
        return { success: false, error };
      }
    }

    async function loadDeletedGuests() {
      try {
        const { data, error } = await supabase
          .from('guests')
          .select('*')
          .eq('deleted', true)
          .order('deleted_at', { ascending: false });

        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Erro ao carregar convidados deletados:', error);
        return [];
      }
    }

    async function createCheckin(checkinData) {
      try {
        const { data, error } = await supabase
          .from('checkins')
          .insert([checkinData])
          .select();

        if (error) throw error;
        await loadCheckins();
        return { success: true, data };
      } catch (error) {
        console.error('Erro ao criar check-in:', error);
        return { success: false, error };
      }
    }

    async function deleteCheckin(checkinId) {
      try {
        const { error } = await supabase
          .from('checkins')
          .delete()
          .eq('id', checkinId);

        if (error) throw error;
        await loadCheckins();
        return { success: true };
      } catch (error) {
        console.error('Erro ao deletar check-in:', error);
        return { success: false, error };
      }
    }

    // =============== OFFLINE QUEUE ===============

    function loadOfflineQueue() {
      const saved = localStorage.getItem(STORAGE_KEYS.OFFLINE_QUEUE);
      if (saved) {
        offlineQueue = JSON.parse(saved);
      }
    }

    function saveOfflineQueue() {
      localStorage.setItem(STORAGE_KEYS.OFFLINE_QUEUE, JSON.stringify(offlineQueue));
    }

    async function syncOfflineQueue() {
      if (offlineQueue.length === 0) return;
      
      showToast('üîÑ Sincronizando ' + offlineQueue.length + ' check-ins offline...', 'info');
      
      const successfulSyncs = [];
      
      for (const checkinData of offlineQueue) {
        const result = await createCheckin(checkinData);
        if (result.success) {
          successfulSyncs.push(checkinData.id);
        }
      }
      
      offlineQueue = offlineQueue.filter(item => !successfulSyncs.includes(item.id));
      saveOfflineQueue();
      
      if (offlineQueue.length === 0) {
        showToast('‚úÖ Todos os check-ins foram sincronizados!', 'success');
      } else {
        showToast('‚ö†Ô∏è ' + offlineQueue.length + ' check-ins ainda pendentes', 'warning');
      }
    }

    window.addEventListener('online', () => {
      isOnline = true;
      showToast('üåê Conex√£o restaurada!', 'success');
      syncOfflineQueue();
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      showToast('üì¥ Modo offline ativado', 'warning');
    });

    // =============== UI HELPERS ===============

    function showToast(message, type = 'success') {
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }

      const colors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
      };

      const toast = document.createElement('div');
      toast.className = 'toast text-white font-semibold';
      toast.style.backgroundColor = colors[type] || colors.info;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 4000);
    }

    function generateId(prefix) {
      return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    }

    function generateToken() {
      return 'TKN-' + Math.random().toString(36).substr(2, 9).toUpperCase();
    }

    function saveSession(type, data) {
      const key = type === 'admin' ? STORAGE_KEYS.ADMIN_SESSION : STORAGE_KEYS.CLIENT_SESSION;
      localStorage.setItem(key, JSON.stringify(data));
    }

    function loadSession(type) {
      const key = type === 'admin' ? STORAGE_KEYS.ADMIN_SESSION : STORAGE_KEYS.CLIENT_SESSION;
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : null;
    }

    function clearSession(type) {
      const key = type === 'admin' ? STORAGE_KEYS.ADMIN_SESSION : STORAGE_KEYS.CLIENT_SESSION;
      localStorage.removeItem(key);
    }

    function clearAllSessions() {
      clearSession('admin');
      clearSession('client');
    }

    async function checkExistingSession() {
      const adminSession = loadSession('admin');
      if (adminSession) {
        if (adminSession.username) {
          try {
            const { data, error } = await supabase
              .from('admin_credentials')
              .select('active')
              .eq('username', adminSession.username)
              .single();
            
            if (error || !data || !data.active) {
              clearSession('admin');
              showToast('‚ö†Ô∏è Sess√£o administrativa inv√°lida. Fa√ßa login novamente.', 'warning');
              return false;
            }
          } catch (e) {
            console.log('Erro ao validar admin (modo offline)');
          }
        }
        
        currentUser = { type: 'admin', id: 'admin', name: 'Administrador' };
        currentView = 'admin-dashboard';
        await renderAdminDashboard();
        return true;
      }

      const clientSession = loadSession('client');
      if (clientSession) {
        await loadClients();
        
        const client = clients.find(c => c.id === clientSession.clientId);
        
        if (!client) {
          clearSession('client');
          showToast('‚ö†Ô∏è Sess√£o inv√°lida. Fa√ßa login novamente.', 'warning');
          return false;
        }
        
        if (client.deleted) {
          clearSession('client');
          showToast('‚ùå Token desativado pelo administrador.', 'error');
          return false;
        }
        
        if (parseInt(client.expiry) < Date.now()) {
          clearSession('client');
          showToast('‚ùå Token expirado. Entre em contato com o administrador.', 'error');
          return false;
        }
        
        if (clientSession.token !== client.token) {
          clearSession('client');
          showToast('‚ùå Token alterado. Fa√ßa login novamente.', 'warning');
          return false;
        }

        currentUser = { type: 'client', id: client.id, name: client.client_name };
        currentView = 'client-dashboard';
        await renderClientDashboard();
        return true;
      }

      return false;
    }

    // =============== LOGIN ===============

    function renderLogin() {
      document.getElementById('app').innerHTML = `
        <div class="min-h-full flex flex-col items-center justify-center p-4" style="background: linear-gradient(135deg, ${config.background_color} 0%, ${config.card_color} 100%);">
          <div class="w-full max-w-md animate-slide-in">
            <div class="text-center mb-8">
              <div class="w-24 h-24 mx-auto mb-6 rounded-3xl flex items-center justify-center" style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); box-shadow: 0 20px 60px rgba(0, 127, 159, 0.4);">
                <svg class="w-12 h-12" style="color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h1 class="font-bold mb-2" style="font-size: 40px; color: ${config.text_color};">
                ${config.app_title}
              </h1>
              <p class="opacity-70" style="font-size: 18px; color: ${config.text_color};">
                Sistema Profissional de Check-In
              </p>
            </div>

            <div class="rounded-3xl p-8 backdrop-blur-lg" style="background-color: ${config.card_color}cc; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
              <div class="flex gap-2 mb-6">
                <button onclick="switchLoginType('client')" id="client-tab" class="flex-1 py-3 rounded-xl font-semibold transition-all" style="background-color: ${config.primary_color}; color: white;">
                  Cliente
                </button>
                <button onclick="switchLoginType('admin')" id="admin-tab" class="flex-1 py-3 rounded-xl font-semibold transition-all" style="background-color: ${config.background_color}; color: ${config.text_color};">
                  Administrador
                </button>
              </div>

              <div id="login-form-container"></div>
            </div>

            <div class="text-center mt-6">
              <p class="opacity-40" style="font-size: 12px; color: ${config.text_color};">
                Created By AdKira 2025
              </p>
            </div>
          </div>
        </div>
      `;

      switchLoginType('client');
    }

    function switchLoginType(type) {
      document.getElementById('admin-tab').style.backgroundColor = type === 'admin' ? config.primary_color : config.background_color;
      document.getElementById('client-tab').style.backgroundColor = type === 'client' ? config.primary_color : config.background_color;

      const container = document.getElementById('login-form-container');
      
      if (type === 'admin') {
        container.innerHTML = `
          <form onsubmit="loginAdmin(event); return false;">
            <div class="mb-4">
              <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                Nome de Usu√°rio
              </label>
              <input 
                type="text" 
                name="username" 
                required 
                class="w-full px-4 py-3 rounded-xl outline-none transition-all"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px; border: 2px solid transparent;"
                placeholder="Digite o usu√°rio"
              >
            </div>
            <div class="mb-6">
              <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                Senha do Administrador
              </label>
              <input 
                type="password" 
                name="password" 
                required 
                class="w-full px-4 py-3 rounded-xl outline-none transition-all"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px; border: 2px solid transparent;"
                placeholder="Digite a senha"
              >
            </div>
            <button 
              type="submit" 
              class="w-full py-4 rounded-xl font-bold transition-all transform active:scale-95"
              style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); color: white; font-size: 18px; box-shadow: 0 10px 30px rgba(0, 127, 159, 0.3);"
            >
              Entrar como Admin
            </button>
          </form>
        `;
      } else {
        container.innerHTML = `
          <form onsubmit="loginClient(event); return false;">
            <div class="mb-6">
              <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                Token de Acesso
              </label>
              <input 
                type="text" 
                name="token" 
                required 
                class="w-full px-4 py-3 rounded-xl outline-none transition-all font-mono"
                style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px; border: 2px solid transparent;"
                placeholder="TKN-XXXXXXXXX"
              >
            </div>
            <button 
              type="submit" 
              class="w-full py-4 rounded-xl font-bold transition-all transform active:scale-95"
              style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); color: white; font-size: 18px; box-shadow: 0 10px 30px rgba(0, 127, 159, 0.3);"
            >
              Entrar como Cliente
            </button>
          </form>
        `;
      }
    }

    async function loginAdmin(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const username = formData.get('username');
      const password = formData.get('password');

      const isValid = await validateAdminCredentials(username, password);

      if (isValid) {
        currentUser = { type: 'admin', id: 'admin', name: 'Administrador' };
        saveSession('admin', { loggedIn: true, username: username });
        currentView = 'admin-dashboard';
        currentTab = 'home';
        showToast('Login realizado com sucesso!', 'success');
        await renderAdminDashboard();
      } else {
        showToast('Usu√°rio ou senha incorretos!', 'error');
      }
    }

    async function loginClient(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const token = formData.get('token').trim();

      await loadClients();
      
      const client = clients.find(c => c.token === token);

      if (!client) {
        showToast('‚ùå Token inv√°lido!', 'error');
        clearSession('client');
        return;
      }

      if (client.deleted) {
        showToast('‚ùå Token desativado! Entre em contato com o administrador.', 'error');
        clearSession('client');
        return;
      }

      if (parseInt(client.expiry) < Date.now()) {
        showToast('‚ùå Token expirado! Entre em contato com o administrador.', 'error');
        clearSession('client');
        return;
      }

      currentUser = { type: 'client', id: client.id, name: client.client_name };
      saveSession('client', { clientId: client.id, token: token, expiry: client.expiry });
      currentView = 'client-dashboard';
      currentTab = 'home';
      showToast('‚úÖ Bem-vindo, ' + client.client_name + '!', 'success');
      await renderClientDashboard();
    }

    function logout() {
      clearAllSessions();
      currentUser = null;
      currentView = 'login';
      currentTab = 'home';
      if (html5QrCode) {
        html5QrCode.stop().catch(() => {});
        html5QrCode = null;
      }
      showToast('Logout realizado com sucesso!', 'info');
      renderLogin();
    }

    // =============== ADMIN DASHBOARD ===============

    async function renderAdminDashboard() {
      const activeClients = clients.filter(c => parseInt(c.expiry) > Date.now());
      const totalGuests = guests.length;
      const totalCheckins = checkins.length;

      document.getElementById('app').innerHTML = `
        <div class="min-h-full flex flex-col" style="background-color: ${config.background_color};">
          <div class="p-4" style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <div class="flex items-center justify-between">
              <div>
                <h1 class="font-bold mb-1" style="font-size: 28px; color: white;">
                  ${config.app_title}
                </h1>
                <p style="font-size: 14px; color: rgba(255,255,255,0.8);">
                  Painel do Administrador
                </p>
              </div>
              <button onclick="logout()" class="px-4 py-2 rounded-lg font-semibold transition-all" style="background-color: rgba(255,255,255,0.2); color: white; font-size: 14px;">
                Sair
              </button>
            </div>
          </div>

          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-6xl mx-auto">
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="p-6 rounded-2xl" style="background: linear-gradient(135deg, ${config.card_color} 0%, ${config.background_color} 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">
                    Total Clientes
                  </p>
                  <p class="font-bold" style="font-size: 40px; color: ${config.primary_color};">
                    ${clients.length}
                  </p>
                </div>
                <div class="p-6 rounded-2xl" style="background: linear-gradient(135deg, ${config.card_color} 0%, ${config.background_color} 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">
                    Clientes Ativos
                  </p>
                  <p class="font-bold" style="font-size: 40px; color: ${config.success_color};">
                    ${activeClients.length}
                  </p>
                </div>
                <div class="p-6 rounded-2xl" style="background: linear-gradient(135deg, ${config.card_color} 0%, ${config.background_color} 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">
                    Total Convidados
                  </p>
                  <p class="font-bold" style="font-size: 40px; color: ${config.text_color};">
                    ${totalGuests}
                  </p>
                </div>
                <div class="p-6 rounded-2xl" style="background: linear-gradient(135deg, ${config.card_color} 0%, ${config.background_color} 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">
                    Total Check-ins
                  </p>
                  <p class="font-bold" style="font-size: 40px; color: ${config.success_color};">
                    ${totalCheckins}
                  </p>
                </div>
              </div>

              <div class="mb-6 p-6 rounded-2xl" style="background-color: ${config.card_color}; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                <h2 class="font-bold mb-4" style="font-size: 20px; color: ${config.text_color};">
                  üìã Check-ins Recentes (√∫ltimos 10)
                </h2>
                <div class="space-y-2">
                  ${checkins
                    .slice(0, 10)
                    .map(checkin => {
                      const client = clients.find(c => c.id === checkin.client_id);
                      return `
                        <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: ${config.background_color};">
                          <div class="flex-1">
                            <p class="font-bold" style="font-size: 14px; color: ${config.text_color};">
                              ${checkin.guest_name}
                            </p>
                            <p class="opacity-70" style="font-size: 12px; color: ${config.text_color};">
                              ${client ? client.client_name : 'Cliente'} ‚Ä¢ ${new Date(checkin.checked_in_at).toLocaleString('pt-BR')}
                            </p>
                          </div>
                          <button 
                            onclick="undoCheckin('${checkin.id}')"
                            class="px-3 py-2 rounded-lg font-semibold transition-all"
                            style="background-color: rgba(239, 68, 68, 0.2); color: #ef4444; font-size: 12px;"
                          >
                            ‚Ü©Ô∏è Desfazer
                          </button>
                        </div>
                      `;
                    }).join('') || `
                      <p class="text-center opacity-70 py-4" style="font-size: 14px; color: ${config.text_color};">
                        Nenhum check-in realizado ainda
                      </p>
                    `}
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="showAddClientModal()" class="p-6 rounded-2xl font-bold transition-all transform hover:scale-[1.02] active:scale-95 flex items-center justify-center" style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); color: white; font-size: 18px; box-shadow: 0 10px 40px rgba(0, 127, 159, 0.3);">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                  Novo Cliente
                </button>
                <button onclick="showTrashModal()" class="p-6 rounded-2xl font-bold transition-all transform hover:scale-[1.02] active:scale-95 flex items-center justify-center" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; font-size: 18px; box-shadow: 0 10px 40px rgba(239, 68, 68, 0.3);">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                  üóëÔ∏è Lixeira
                </button>
              </div>

              <h2 class="font-bold mb-4" style="font-size: 28px; color: ${config.text_color};">
                Lista de Clientes
              </h2>
              
              <div class="space-y-3 mb-6">
                ${clients.length === 0 ? `
                  <div class="p-8 rounded-2xl text-center" style="background-color: ${config.card_color};">
                    <p class="opacity-70" style="font-size: 16px; color: ${config.text_color};">
                      Nenhum cliente cadastrado ainda
                    </p>
                  </div>
                ` : clients.map(client => {
                  const isExpired = parseInt(client.expiry) < Date.now();
                  const timeRemaining = parseInt(client.expiry) - Date.now();
                  const hoursRemaining = Math.floor(timeRemaining / (1000 * 60 * 60));
                  const daysRemaining = Math.floor(hoursRemaining / 24);
                  const clientGuests = guests.filter(g => g.client_id === client.id);
                  const clientCheckins = checkins.filter(c => c.client_id === client.id);

                  return `
                    <div class="p-6 rounded-2xl" style="background-color: ${config.card_color}; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                      <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                          <h3 class="font-bold mb-2 flex items-center" style="font-size: 20px; color: ${config.text_color};">
                            ${client.client_name}
                            ${isExpired ? `
                              <span class="ml-3 px-3 py-1 rounded-full text-xs" style="background-color: rgba(239, 68, 68, 0.2); color: #ef4444;">
                                üîí Expirado
                              </span>
                            ` : `
                              <span class="ml-3 px-3 py-1 rounded-full text-xs" style="background-color: rgba(16, 185, 129, 0.2); color: ${config.success_color};">
                                ‚úì Ativo
                              </span>
                            `}
                          </h3>
                          <div class="flex flex-wrap gap-4 mb-3">
                            <p class="opacity-70" style="font-size: 14px; color: ${config.text_color};">
                              üé´ Token: <span class="font-mono font-bold" style="color: ${config.primary_color};">${client.token}</span>
                            </p>
                          </div>
                          <p class="opacity-70 mb-3" style="font-size: 14px; color: ${config.text_color};">
                            ‚è∞ ${isExpired ? 'Expirou em' : 'Expira em'}: ${new Date(parseInt(client.expiry)).toLocaleString('pt-BR')}
                            ${!isExpired ? `<span style="color: ${config.primary_color}; font-weight: 600;"> (${daysRemaining}d ${hoursRemaining % 24}h restantes)</span>` : ''}
                          </p>
                          <div class="flex gap-4">
                            <span class="px-3 py-1 rounded-lg text-sm font-semibold" style="background-color: rgba(59, 130, 246, 0.2); color: #3b82f6;">
                              üë• ${clientGuests.length} convidados
                            </span>
                            <span class="px-3 py-1 rounded-lg text-sm font-semibold" style="background-color: rgba(16, 185, 129, 0.2); color: ${config.success_color};">
                              ‚úì ${clientCheckins.length} check-ins
                            </span>
                          </div>
                        </div>
                        <div class="flex gap-2 ml-4">
                          <button onclick="extendClientToken('${client.id}')" class="px-4 py-2 rounded-lg font-semibold transition-all" style="background-color: ${config.primary_color}; color: white; font-size: 14px;">
                            ‚è∞ Estender
                          </button>
                          <button onclick="showDeleteClientConfirmation('${client.id}')" class="px-4 py-2 rounded-lg font-semibold transition-all" style="background-color: rgba(239, 68, 68, 0.2); color: #ef4444; font-size: 14px;">
                            üóëÔ∏è Deletar
                          </button>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>

          <div class="text-center py-6" style="background-color: ${config.card_color};">
            <p class="opacity-40" style="font-size: 12px; color: ${config.text_color};">
              Created By AdKira 2025
            </p>
          </div>
        </div>
      `;
    }

    // =============== CLIENT DASHBOARD ===============

    async function renderClientDashboard() {
      await loadClients();
      const client = clients.find(c => c.id === currentUser.id);
      
      if (!client || client.deleted || parseInt(client.expiry) < Date.now()) {
        clearSession('client');
        currentUser = null;
        currentView = 'login';
        showToast('‚ùå Sess√£o expirada ou desativada. Fa√ßa login novamente.', 'error');
        renderLogin();
        return;
      }
      
      if (currentTab === 'home') {
        await renderClientHome();
      } else if (currentTab === 'scanner') {
        await renderClientScanner();
      }
    }

    async function renderClientHome() {
      const client = clients.find(c => c.id === currentUser.id);
      if (!client) {
        logout();
        return;
      }

      const clientGuests = guests.filter(g => g.client_id === currentUser.id);
      const clientCheckins = checkins.filter(c => c.client_id === currentUser.id);

      const timeRemaining = parseInt(client.expiry) - Date.now();
      const hoursRemaining = Math.floor(timeRemaining / (1000 * 60 * 60));
      const daysRemaining = Math.floor(hoursRemaining / 24);

      const uniqueCheckins = clientCheckins.filter(c => !c.is_companion_only).length;

      document.getElementById('app').innerHTML = `
        <div class="min-h-full flex flex-col" style="background-color: ${config.background_color};">
          <div class="p-4" style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h1 class="font-bold mb-1" style="font-size: 28px; color: white;">
                  ${config.app_title}
                </h1>
                <p style="font-size: 14px; color: rgba(255,255,255,0.9);">
                  ${currentUser.name}
                </p>
              </div>
              <button onclick="logout()" class="px-4 py-2 rounded-lg font-semibold transition-all" style="background-color: rgba(255,255,255,0.2); color: white; font-size: 14px;">
                Sair
              </button>
            </div>
            <div class="px-3 py-2 rounded-lg" style="background-color: rgba(255,255,255,0.15);">
              <p style="font-size: 14px; color: white;">
                ‚è∞ Token expira em: <span class="font-bold">${daysRemaining}d ${hoursRemaining % 24}h</span>
              </p>
            </div>
          </div>

          <div class="flex border-b" style="background-color: ${config.card_color}; border-color: ${config.background_color};">
            <button onclick="switchClientTab('home')" class="tab-button flex-1 py-4 font-semibold active" style="color: ${config.text_color}; font-size: 14px;">
              üè† In√≠cio
            </button>
            <button onclick="switchClientTab('scanner')" class="tab-button flex-1 py-4 font-semibold" style="color: ${config.text_color}; font-size: 14px;">
              üì∑ Scanner
            </button>
          </div>

          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-4xl mx-auto">
              <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-6 rounded-2xl text-center" style="background: linear-gradient(135deg, ${config.card_color} 0%, ${config.background_color} 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">
                    Convidados
                  </p>
                  <p class="font-bold" style="font-size: 32px; color: ${config.primary_color};">
                    ${clientGuests.length}
                  </p>
                </div>
                <div class="p-6 rounded-2xl text-center" style="background: linear-gradient(135deg, ${config.card_color} 0%, ${config.background_color} 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                  <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">
                    Check-ins
                  </p>
                  <p class="font-bold" style="font-size: 32px; color: ${config.success_color};">
                    ${uniqueCheckins}
                  </p>
                </div>
              </div>

              <h2 class="font-bold mb-4" style="font-size: 24px; color: ${config.text_color};">
                Lista de Convidados
              </h2>

              <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                <button onclick="filterGuests('all')" id="filter-all" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap transition-all" style="background-color: ${config.primary_color}; color: white; font-size: 14px;">
                  Todos (${clientGuests.length})
                </button>
                <button onclick="filterGuests('checked-in')" id="filter-checked-in" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap transition-all" style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 14px;">
                  Entraram (${uniqueCheckins})
                </button>
                <button onclick="filterGuests('pending')" id="filter-pending" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap transition-all" style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 14px;">
                  Pendentes (${clientGuests.length - uniqueCheckins})
                </button>
                <button onclick="filterGuests('companion')" id="filter-companion" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap transition-all" style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 14px;">
                  Com Acompanhante (${clientGuests.filter(g => g.has_companion).length})
                </button>
              </div>
              
              <div id="guests-list" class="space-y-3 mb-6">
                ${renderGuestsList(clientGuests, clientCheckins, 'all')}
              </div>
            </div>
          </div>

          <div class="text-center py-6" style="background-color: ${config.card_color};">
            <p class="opacity-40" style="font-size: 12px; color: ${config.text_color};">
              Created By AdKira 2025
            </p>
          </div>
        </div>
      `;
    }

    function renderGuestsList(clientGuests, clientCheckins, filter) {
      let filteredGuests = clientGuests;
      
      if (filter === 'checked-in') {
        filteredGuests = clientGuests.filter(g => clientCheckins.some(c => c.guest_qr === g.qr_code && !c.is_companion_only));
      } else if (filter === 'pending') {
        filteredGuests = clientGuests.filter(g => !clientCheckins.some(c => c.guest_qr === g.qr_code && !c.is_companion_only));
      } else if (filter === 'companion') {
        filteredGuests = clientGuests.filter(g => g.has_companion);
      }

      if (filteredGuests.length === 0) {
        return `
          <div class="p-8 rounded-2xl text-center" style="background-color: ${config.card_color};">
            <p class="opacity-70" style="font-size: 16px; color: ${config.text_color};">
              Nenhum convidado nesta categoria
            </p>
          </div>
        `;
      }

      return filteredGuests.map(guest => {
        const guestCheckins = clientCheckins.filter(c => c.guest_qr === guest.qr_code);
        const hasCheckedIn = guestCheckins.length > 0;
        const mainCheckin = guestCheckins.find(c => !c.is_companion_only);
        const companionCheckin = guestCheckins.find(c => c.is_companion_only);

        return `
          <div class="p-4 rounded-xl" style="background-color: ${config.card_color}; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <h3 class="font-bold mb-1" style="font-size: 18px; color: ${config.text_color};">
                  ${guest.name} ${guest.has_companion ? 'üë•' : ''}
                </h3>
                <p class="opacity-70 mb-2" style="font-size: 14px; color: ${config.text_color};">
                  üé´ C√≥digo: ${guest.qr_code}
                </p>
                ${mainCheckin ? `
                  <p class="font-semibold mb-1" style="font-size: 12px; color: ${config.success_color};">
                    ‚úÖ Check-in: ${new Date(mainCheckin.checked_in_at).toLocaleString('pt-BR')}
                    ${mainCheckin.with_companion ? ' (Com acompanhante)' : guest.has_companion ? ' (Sem acompanhante)' : ''}
                  </p>
                ` : ''}
                ${companionCheckin ? `
                  <p class="font-semibold" style="font-size: 12px; color: ${config.success_color};">
                    ‚úÖ Acompanhante: ${new Date(companionCheckin.checked_in_at).toLocaleString('pt-BR')}
                  </p>
                ` : ''}
              </div>
              ${hasCheckedIn ? `
                <span class="px-4 py-2 rounded-lg font-bold" style="background-color: rgba(16, 185, 129, 0.2); color: ${config.success_color};">
                  ‚úì
                </span>
              ` : `
                <span class="px-4 py-2 rounded-lg font-semibold opacity-50" style="background-color: ${config.background_color}; color: ${config.text_color};">
                  Pendente
                </span>
              `}
            </div>
          </div>
        `;
      }).join('');
    }

    async function filterGuests(filterType) {
      const clientGuests = guests.filter(g => g.client_id === currentUser.id);
      const clientCheckins = checkins.filter(c => c.client_id === currentUser.id);
      
      document.querySelectorAll('[id^="filter-"]').forEach(btn => {
        btn.style.backgroundColor = config.background_color;
        btn.style.color = config.text_color;
      });
      
      const activeBtn = document.getElementById('filter-' + filterType);
      if (activeBtn) {
        activeBtn.style.backgroundColor = config.primary_color;
        activeBtn.style.color = 'white';
      }
      
      const guestsList = document.getElementById('guests-list');
      if (guestsList) {
        guestsList.innerHTML = renderGuestsList(clientGuests, clientCheckins, filterType);
      }
    }

    // =============== SCANNER ===============

    async function renderClientScanner() {
      document.getElementById('app').innerHTML = `
        <div class="h-full flex flex-col" style="background-color: ${config.background_color};">
          <div class="p-3 flex items-center justify-between" style="background-color: ${config.card_color};">
            <button onclick="switchClientTab('home')" class="px-3 py-2 rounded-lg font-semibold" style="background-color: ${config.primary_color}; color: white; font-size: 14px;">
              ‚Üê Voltar
            </button>
            <h1 class="font-bold" style="font-size: 20px; color: ${config.text_color};">
              Scanner QR Code
            </h1>
            <button onclick="logout()" class="px-3 py-2 rounded-lg font-semibold" style="background-color: rgba(239, 68, 68, 0.2); color: #ef4444; font-size: 14px;">
              Sair
            </button>
          </div>

          <div class="flex-1 flex flex-col" style="background-color: #000;">
            <div id="qr-reader" class="flex-1"></div>
            
            <div class="p-4 space-y-3" style="background-color: ${config.card_color};">
              <p class="text-center opacity-70" style="font-size: 14px; color: ${config.text_color};">
                üì∑ Aponte a c√¢mera para o QR Code do convidado
              </p>
              <button onclick="showManualSearchModal()" class="w-full py-3 rounded-xl font-semibold transition-all" style="background-color: ${config.primary_color}; color: white; font-size: 16px;">
                üîç Busca Manual
              </button>
              <p class="text-center opacity-40" style="font-size: 11px; color: ${config.text_color};">
                Created By AdKira 2025
              </p>
            </div>
          </div>
        </div>
      `;

      setTimeout(() => {
        startQrScanner();
      }, 100);
    }

    function startQrScanner() {
      if (html5QrCode) {
        html5QrCode.stop().catch(() => {});
      }

      html5QrCode = new Html5Qrcode("qr-reader");

      html5QrCode.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: { width: 250, height: 250 }
        },
        (decodedText, decodedResult) => {
          processQrCode(decodedText);
        }
      ).catch(err => {
        showToast('Erro ao acessar c√¢mera', 'error');
        console.error(err);
      });
    }

    function showManualSearchModal() {
      const clientGuests = guests.filter(g => g.client_id === currentUser.id);
      const clientCheckins = checkins.filter(c => c.client_id === currentUser.id);

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
      };

      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-6" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-height: 80%; overflow-y: auto;">
          <h2 class="font-bold mb-4" style="font-size: 24px; color: ${config.text_color};">
            üîç Busca Manual de Convidado
          </h2>
          <input 
            type="text" 
            id="manual-search-input"
            placeholder="Digite o nome ou c√≥digo..."
            class="w-full px-4 py-3 rounded-xl outline-none mb-4"
            style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
            oninput="filterManualSearch(this.value)"
          >
          <div id="manual-search-results" class="space-y-2 max-h-96 overflow-y-auto">
            ${clientGuests.map(guest => {
              const hasCheckedIn = clientCheckins.some(c => c.guest_qr === guest.qr_code && !c.is_companion_only);
              return `
                <button 
                  onclick="selectGuestManually('${guest.qr_code}')" 
                  class="w-full p-4 rounded-xl text-left transition-all ${hasCheckedIn ? 'opacity-50' : ''}"
                  style="background-color: ${config.background_color}; color: ${config.text_color};"
                  ${hasCheckedIn ? 'disabled' : ''}
                >
                  <div class="font-bold mb-1" style="font-size: 16px;">
                    ${guest.name} ${hasCheckedIn ? '‚úÖ' : ''}
                  </div>
                  <div class="opacity-70" style="font-size: 12px;">
                    C√≥digo: ${guest.qr_code} ${guest.has_companion ? '| üë• Com acompanhante' : ''}
                  </div>
                </button>
              `;
            }).join('')}
          </div>
          <button 
            onclick="this.closest('.modal-overlay').remove()"
            class="w-full mt-4 py-3 rounded-xl font-semibold"
            style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
          >
            Cancelar
          </button>
        </div>
      `;

      document.body.appendChild(modal);
      setTimeout(() => {
        document.getElementById('manual-search-input').focus();
      }, 100);
    }

    function filterManualSearch(query) {
      const clientGuests = guests.filter(g => g.client_id === currentUser.id);
      const clientCheckins = checkins.filter(c => c.client_id === currentUser.id);
      
      const filtered = clientGuests.filter(g => 
        g.name.toLowerCase().includes(query.toLowerCase()) ||
        g.qr_code.toLowerCase().includes(query.toLowerCase())
      );

      const resultsDiv = document.getElementById('manual-search-results');
      resultsDiv.innerHTML = filtered.map(guest => {
        const hasCheckedIn = clientCheckins.some(c => c.guest_qr === guest.qr_code && !c.is_companion_only);
        return `
          <button 
            onclick="selectGuestManually('${guest.qr_code}')" 
            class="w-full p-4 rounded-xl text-left transition-all ${hasCheckedIn ? 'opacity-50' : ''}"
            style="background-color: ${config.background_color}; color: ${config.text_color};"
            ${hasCheckedIn ? 'disabled' : ''}
          >
            <div class="font-bold mb-1" style="font-size: 16px;">
              ${guest.name} ${hasCheckedIn ? '‚úÖ' : ''}
            </div>
            <div class="opacity-70" style="font-size: 12px;">
              C√≥digo: ${guest.qr_code} ${guest.has_companion ? '| üë• Com acompanhante' : ''}
            </div>
          </button>
        `;
      }).join('');
    }

    function selectGuestManually(qrCode) {
      document.querySelector('.modal-overlay').remove();
      processQrCode(qrCode);
    }

    async function processQrCode(qrCode) {
      if (!qrCode) return;

      if (html5QrCode) {
        html5QrCode.pause(true);
      }

      await loadClients();
      const client = clients.find(c => c.id === currentUser.id);
      
      if (!client || client.deleted || parseInt(client.expiry) < Date.now()) {
        showToast('‚ùå ACESSO NEGADO - Token expirado ou desativado', 'error');
        playErrorSound();
        setTimeout(() => {
          logout();
        }, 2000);
        return;
      }

      const cleanCode = qrCode.includes(',') ? qrCode.split(',')[0].trim() : qrCode.trim();

      const clientGuests = guests.filter(g => g.client_id === currentUser.id);
      const guest = clientGuests.find(g => g.qr_code === cleanCode);

      if (!guest) {
        showToast('‚ùå ENTRADA NEGADA - Convidado n√£o encontrado', 'error');
        playErrorSound();
        setTimeout(() => {
          if (html5QrCode) html5QrCode.resume();
        }, 2000);
        return;
      }

      const clientCheckins = checkins.filter(c => c.client_id === currentUser.id);
      const existingCheckins = clientCheckins.filter(c => c.guest_qr === cleanCode);

      if (guest.has_companion && existingCheckins.length === 1) {
        showCompanionConfirmation(guest, cleanCode);
        return;
      }

      if (existingCheckins.length > 0 && (!guest.has_companion || existingCheckins.length >= 2)) {
        showToast('‚ùå ENTRADA NEGADA - Check-in j√° realizado', 'error');
        playErrorSound();
        setTimeout(() => {
          if (html5QrCode) html5QrCode.resume();
        }, 2000);
        return;
      }

      if (guest.has_companion && existingCheckins.length === 0) {
        showCompanionEntryConfirmation(guest, cleanCode);
      } else {
        await performCheckin(guest, cleanCode, false, false);
      }
    }

    function showCompanionEntryConfirmation(guest, cleanCode) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8 text-center" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
          <div class="text-6xl mb-4">üë•</div>
          <h2 class="font-bold mb-2" style="font-size: 24px; color: ${config.text_color};">
            ${guest.name}
          </h2>
          <p class="mb-6 opacity-70" style="font-size: 16px; color: ${config.text_color};">
            Este convidado tem direito a acompanhante.<br>Entrou com acompanhante?
          </p>
          <div class="flex gap-3">
            <button 
              onclick="confirmCompanionEntry('${cleanCode}', false)"
              class="flex-1 py-4 rounded-xl font-bold"
              style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 18px;"
            >
              N√ÉO<br><span style="font-size: 12px; opacity: 0.7;">(S√≥ o convidado)</span>
            </button>
            <button 
              onclick="confirmCompanionEntry('${cleanCode}', true)"
              class="flex-1 py-4 rounded-xl font-bold"
              style="background: linear-gradient(135deg, ${config.success_color} 0%, #059669 100%); color: white; font-size: 18px;"
            >
              SIM<br><span style="font-size: 12px; opacity: 0.9;">(Convidado + Acompanhante)</span>
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function showCompanionConfirmation(guest, cleanCode) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8 text-center" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
          <div class="text-6xl mb-4">üë§</div>
          <h2 class="font-bold mb-2" style="font-size: 24px; color: ${config.text_color};">
            Acompanhante de ${guest.name}
          </h2>
          <p class="mb-6 opacity-70" style="font-size: 16px; color: ${config.text_color};">
            O convidado principal j√° entrou.<br>Esta √© a entrada do acompanhante?
          </p>
          <div class="flex gap-3">
            <button 
              onclick="cancelCompanionEntry()"
              class="flex-1 py-4 rounded-xl font-bold"
              style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 18px;"
            >
              Cancelar
            </button>
            <button 
              onclick="confirmCompanionEntry('${cleanCode}', true, true)"
              class="flex-1 py-4 rounded-xl font-bold"
              style="background: linear-gradient(135deg, ${config.success_color} 0%, #059669 100%); color: white; font-size: 18px;"
            >
              SIM, Confirmar
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function confirmCompanionEntry(cleanCode, withCompanion, isCompanionOnly = false) {
      document.querySelector('.modal-overlay').remove();
      
      const clientGuests = guests.filter(g => g.client_id === currentUser.id);
      const guest = clientGuests.find(g => g.qr_code === cleanCode);
      
      await performCheckin(guest, cleanCode, withCompanion, isCompanionOnly);
    }

    function cancelCompanionEntry() {
      document.querySelector('.modal-overlay').remove();
      setTimeout(() => {
        if (html5QrCode) html5QrCode.resume();
      }, 500);
    }

    async function performCheckin(guest, cleanCode, withCompanion, isCompanionOnly) {
      const checkinData = {
        id: generateId('checkin'),
        client_id: currentUser.id,
        guest_id: guest.id,
        guest_qr: cleanCode,
        guest_name: guest.name,
        with_companion: withCompanion,
        is_companion_only: isCompanionOnly,
        status: 'confirmed',
        checked_in_at: new Date().toISOString(),
        synced: isOnline
      };

      let success = false;

      if (isOnline) {
        const result = await createCheckin(checkinData);
        success = result.success;
        
        if (!success) {
          isOnline = false;
          offlineQueue.push(checkinData);
          saveOfflineQueue();
          success = true;
        }
      } else {
        offlineQueue.push(checkinData);
        saveOfflineQueue();
        success = true;
      }

      if (success) {
        let message = '';
        if (isCompanionOnly) {
          message = '‚úÖ ENTRADA APROVADA - Acompanhante de ' + guest.name;
        } else if (withCompanion) {
          message = '‚úÖ ENTRADA APROVADA - ' + guest.name + ' + Acompanhante (2 pessoas)';
        } else {
          message = '‚úÖ ENTRADA APROVADA - ' + guest.name + (guest.has_companion ? ' (1 pessoa)' : '');
        }
        
        if (!isOnline) {
          message += ' [OFFLINE]';
        }
        
        showSuccessAnimation(message);
        playSuccessSound();
        vibrateDevice();
        
        setTimeout(() => {
          if (html5QrCode) html5QrCode.resume();
        }, 3000);
      } else {
        showToast('‚ùå ENTRADA NEGADA - Erro do sistema', 'error');
        playErrorSound();
        setTimeout(() => {
          if (html5QrCode) html5QrCode.resume();
        }, 2000);
      }
    }

    function showSuccessAnimation(message) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.zIndex = '10000';
      
      overlay.innerHTML = `
        <div class="text-center animate-slide-in">
          <div class="text-8xl mb-4">‚úÖ</div>
          <div class="font-bold mb-2" style="font-size: 28px; color: white;">
            ${message.replace('‚úÖ ', '')}
          </div>
          <div id="confetti-container"></div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      const container = overlay.querySelector('#confetti-container');
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.textContent = ['üéâ', 'üéä', '‚ú®', '‚≠ê', 'üåü'][Math.floor(Math.random() * 5)];
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.fontSize = (Math.random() * 20 + 20) + 'px';
        confetti.style.animationDelay = (Math.random() * 0.5) + 's';
        container.appendChild(confetti);
      }
      
      setTimeout(() => {
        overlay.remove();
      }, 3000);
    }

    function playSuccessSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (e) {
        console.log('Audio not supported');
      }
    }

    function playErrorSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 200;
        oscillator.type = 'sawtooth';
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      } catch (e) {
        console.log('Audio not supported');
      }
    }

    function vibrateDevice() {
      if ('vibrate' in navigator) {
        navigator.vibrate(200);
      }
    }

    // =============== ADMIN FUNCTIONS ===============

    function showAddClientModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
      };

      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
          <h2 class="font-bold mb-6" style="font-size: 28px; color: ${config.text_color};">
            ‚ûï Adicionar Novo Cliente
          </h2>
          <form onsubmit="addClient(event); return false;">
            <div class="space-y-4">
              <div>
                <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                  Nome do Cliente
                </label>
                <input 
                  type="text" 
                  name="client_name" 
                  required 
                  class="w-full px-4 py-3 rounded-xl outline-none"
                  style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
                  placeholder="Ex: Jo√£o Silva - Casamento"
                >
              </div>
              <div>
                <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                  Validade (dias)
                </label>
                <input 
                  type="number" 
                  name="validity_days" 
                  required 
                  min="1"
                  max="365"
                  value="7"
                  class="w-full px-4 py-3 rounded-xl outline-none"
                  style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
                >
              </div>
              <div>
                <label class="block mb-2 font-medium" style="font-size: 14px; color: ${config.text_color};">
                  Upload Lista de Convidados (TXT)
                </label>
                <input 
                  type="file" 
                  name="guest_file" 
                  accept=".txt"
                  class="w-full px-4 py-3 rounded-xl outline-none"
                  style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 14px;"
                >
                <p class="mt-2 opacity-70" style="font-size: 12px; color: ${config.text_color};">
                  Formato: CODIGO,Nome do Convidado,Acompanhante (uma linha por convidado)<br>
                  Acompanhante: SIM ou N√ÉO
                </p>
              </div>
              <div class="flex gap-3 pt-4">
                <button 
                  type="button" 
                  onclick="this.closest('.modal-overlay').remove()"
                  class="flex-1 py-3 rounded-xl font-semibold transition-all"
                  style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
                >
                  Cancelar
                </button>
                <button 
                  type="submit" 
                  class="flex-1 py-3 rounded-xl font-semibold transition-all"
                  style="background: linear-gradient(135deg, ${config.primary_color} 0%, #005f7f 100%); color: white; font-size: 16px;"
                >
                  Criar Cliente
                </button>
              </div>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function addClient(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const clientName = formData.get('client_name');
      const validityDays = parseInt(formData.get('validity_days'));
      const guestFile = formData.get('guest_file');

      const token = generateToken();
      const expiry = Date.now() + (validityDays * 24 * 60 * 60 * 1000);

      const clientData = {
        id: generateId('client'),
        client_name: clientName,
        token: token,
        expiry: expiry,
        created_at: new Date().toISOString(),
        deleted: false
      };

      const result = await createClient(clientData);

      if (result.success) {
        showToast('Cliente criado! Token: ' + token, 'success');
        
        if (guestFile && guestFile.size > 0) {
          await processGuestFile(guestFile, clientData.id);
        }

        document.querySelector('.modal-overlay').remove();
        await renderAdminDashboard();
      } else {
        showToast('Erro ao criar cliente', 'error');
      }
    }

    async function processGuestFile(file, clientId) {
      const text = await file.text();
      const lines = text.split('\n').filter(line => line.trim());

      for (const line of lines) {
        const parts = line.split(',').map(p => p.trim());
        if (parts.length >= 2) {
          const hasCompanion = parts.length >= 3 && 
                               (parts[2].toUpperCase() === 'SIM' || 
                                parts[2].toUpperCase() === 'TRUE' || 
                                parts[2] === '1');

          const guestData = {
            id: generateId('guest'),
            client_id: clientId,
            qr_code: parts[0],
            name: parts[1],
            has_companion: hasCompanion,
            created_at: new Date().toISOString(),
            deleted: false
          };

          await createGuest(guestData);
        }
      }

      showToast(lines.length + ' convidados importados!', 'success');
    }

    async function extendClientToken(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (!client) return;

      const currentExpiry = parseInt(client.expiry);
      const newExpiry = currentExpiry + (7 * 24 * 60 * 60 * 1000);

      const result = await updateClient(clientId, { expiry: newExpiry });

      if (result.success) {
        showToast('Token estendido por 7 dias!', 'success');
        await renderAdminDashboard();
      } else {
        showToast('Erro ao estender token', 'error');
      }
    }

    function showDeleteClientConfirmation(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (!client) return;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8 text-center" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
          <div class="text-6xl mb-4">üóëÔ∏è</div>
          <h2 class="font-bold mb-2" style="font-size: 24px; color: ${config.text_color};">
            Mover para Lixeira?
          </h2>
          <p class="mb-6 opacity-70" style="font-size: 16px; color: ${config.text_color};">
            Tem certeza que deseja deletar o cliente:<br>
            <strong>${client.client_name}</strong><br><br>
            O cliente poder√° ser recuperado da lixeira depois.
          </p>
          <div class="flex gap-3">
            <button 
              onclick="this.closest('.modal-overlay').remove()"
              class="flex-1 py-3 rounded-xl font-semibold"
              style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
            >
              Cancelar
            </button>
            <button 
              onclick="confirmDeleteClient('${clientId}')"
              class="flex-1 py-3 rounded-xl font-semibold"
              style="background-color: #ef4444; color: white; font-size: 16px;"
            >
              Sim, Deletar
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function confirmDeleteClient(clientId) {
      const result = await deleteClient(clientId);

      if (result.success) {
        showToast('‚úÖ Cliente movido para lixeira!', 'success');
        document.querySelector('.modal-overlay').remove();
        await renderAdminDashboard();
      } else {
        showToast('‚ùå Erro ao deletar cliente', 'error');
      }
    }

    async function showTrashModal() {
      const deletedClients = await loadDeletedClients();
      const deletedGuests = await loadDeletedGuests();

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
      };

      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-6" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-width: 800px;">
          <div class="flex items-center justify-between mb-6">
            <h2 class="font-bold" style="font-size: 28px; color: ${config.text_color};">
              üóëÔ∏è Lixeira
            </h2>
            <button onclick="this.closest('.modal-overlay').remove()" class="px-4 py-2 rounded-lg" style="background-color: ${config.background_color}; color: ${config.text_color};">
              ‚úï
            </button>
          </div>

          <div class="flex gap-2 mb-4">
            <button onclick="switchTrashTab('clients')" id="trash-tab-clients" class="flex-1 py-3 rounded-xl font-semibold transition-all" style="background-color: ${config.primary_color}; color: white; font-size: 14px;">
              Clientes (${deletedClients.length})
            </button>
            <button onclick="switchTrashTab('guests')" id="trash-tab-guests" class="flex-1 py-3 rounded-xl font-semibold transition-all" style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 14px;">
              Convidados (${deletedGuests.length})
            </button>
          </div>

          <div id="trash-content" class="space-y-3 max-h-96 overflow-y-auto">
            ${renderTrashClients(deletedClients)}
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function renderTrashClients(deletedClients) {
      if (deletedClients.length === 0) {
        return `
          <div class="p-8 text-center rounded-xl" style="background-color: ${config.background_color};">
            <p class="opacity-70" style="font-size: 16px; color: ${config.text_color};">
              Nenhum cliente na lixeira
            </p>
          </div>
        `;
      }

      return deletedClients.map(client => {
        const clientGuests = guests.filter(g => g.client_id === client.id && !g.deleted);
        const clientCheckins = checkins.filter(c => c.client_id === client.id);
        const deletedTime = new Date(client.deleted_at).toLocaleString('pt-BR');

        return `
          <div class="p-4 rounded-xl" style="background-color: ${config.background_color};">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="font-bold mb-1" style="font-size: 18px; color: ${config.text_color};">
                  ${client.client_name}
                </h3>
                <p class="opacity-70 mb-2" style="font-size: 12px; color: ${config.text_color};">
                  üóëÔ∏è Deletado em: ${deletedTime}
                </p>
                <div class="flex gap-2">
                  <span class="px-2 py-1 rounded text-xs" style="background-color: rgba(59, 130, 246, 0.2); color: #3b82f6;">
                    üë• ${clientGuests.length} convidados
                  </span>
                  <span class="px-2 py-1 rounded text-xs" style="background-color: rgba(16, 185, 129, 0.2); color: ${config.success_color};">
                    ‚úì ${clientCheckins.length} check-ins
                  </span>
                </div>
              </div>
              <button 
                onclick="confirmRestoreClient('${client.id}')"
                class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap ml-2"
                style="background-color: ${config.success_color}; color: white; font-size: 14px;"
              >
                ‚Ü©Ô∏è Restaurar
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderTrashGuests(deletedGuests) {
      if (deletedGuests.length === 0) {
        return `
          <div class="p-8 text-center rounded-xl" style="background-color: ${config.background_color};">
            <p class="opacity-70" style="font-size: 16px; color: ${config.text_color};">
              Nenhum convidado na lixeira
            </p>
          </div>
        `;
      }

      return deletedGuests.map(guest => {
        const client = clients.find(c => c.id === guest.client_id);
        const deletedTime = new Date(guest.deleted_at).toLocaleString('pt-BR');

        return `
          <div class="p-4 rounded-xl" style="background-color: ${config.background_color};">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="font-bold mb-1" style="font-size: 18px; color: ${config.text_color};">
                  ${guest.name} ${guest.has_companion ? 'üë•' : ''}
                </h3>
                <p class="opacity-70 mb-1" style="font-size: 12px; color: ${config.text_color};">
                  Cliente: ${client ? client.client_name : 'Desconhecido'}
                </p>
                <p class="opacity-70" style="font-size: 12px; color: ${config.text_color};">
                  üóëÔ∏è Deletado em: ${deletedTime}
                </p>
              </div>
              <button 
                onclick="confirmRestoreGuest('${guest.id}')"
                class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap ml-2"
                style="background-color: ${config.success_color}; color: white; font-size: 14px;"
              >
                ‚Ü©Ô∏è Restaurar
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function switchTrashTab(tab) {
      const clientsTab = document.getElementById('trash-tab-clients');
      const guestsTab = document.getElementById('trash-tab-guests');
      const content = document.getElementById('trash-content');

      if (tab === 'clients') {
        clientsTab.style.backgroundColor = config.primary_color;
        clientsTab.style.color = 'white';
        guestsTab.style.backgroundColor = config.background_color;
        guestsTab.style.color = config.text_color;

        const deletedClients = await loadDeletedClients();
        content.innerHTML = renderTrashClients(deletedClients);
      } else {
        guestsTab.style.backgroundColor = config.primary_color;
        guestsTab.style.color = 'white';
        clientsTab.style.backgroundColor = config.background_color;
        clientsTab.style.color = config.text_color;

        const deletedGuests = await loadDeletedGuests();
        content.innerHTML = renderTrashGuests(deletedGuests);
      }
    }

    async function confirmRestoreClient(clientId) {
      const result = await restoreClient(clientId);

      if (result.success) {
        showToast('‚úÖ Cliente restaurado com sucesso!', 'success');
        await showTrashModal();
        setTimeout(() => renderAdminDashboard(), 500);
      } else {
        showToast('‚ùå Erro ao restaurar cliente', 'error');
      }
    }

    async function confirmRestoreGuest(guestId) {
      const result = await restoreGuest(guestId);

      if (result.success) {
        showToast('‚úÖ Convidado restaurado com sucesso!', 'success');
        await showTrashModal();
      } else {
        showToast('‚ùå Erro ao restaurar convidado', 'error');
      }
    }

    function showUndoConfirmation(checkinId) {
      const checkin = checkins.find(c => c.id === checkinId);
      if (!checkin) return;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      
      modal.innerHTML = `
        <div class="modal-content rounded-3xl p-8 text-center" style="background-color: ${config.card_color}; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
          <div class="text-6xl mb-4">‚ö†Ô∏è</div>
          <h2 class="font-bold mb-2" style="font-size: 24px; color: ${config.text_color};">
            Desfazer Check-in?
          </h2>
          <p class="mb-6 opacity-70" style="font-size: 16px; color: ${config.text_color};">
            Tem certeza que deseja desfazer o check-in de:<br>
            <strong>${checkin.guest_name}</strong>
          </p>
          <div class="flex gap-3">
            <button 
              onclick="this.closest('.modal-overlay').remove()"
              class="flex-1 py-3 rounded-xl font-semibold"
              style="background-color: ${config.background_color}; color: ${config.text_color}; font-size: 16px;"
            >
              Cancelar
            </button>
            <button 
              onclick="confirmUndoCheckin('${checkinId}')"
              class="flex-1 py-3 rounded-xl font-semibold"
              style="background-color: #ef4444; color: white; font-size: 16px;"
            >
              Sim, Desfazer
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function confirmUndoCheckin(checkinId) {
      const result = await deleteCheckin(checkinId);

      if (result.success) {
        showToast('‚úÖ Check-in desfeito com sucesso!', 'success');
        document.querySelector('.modal-overlay').remove();
        await renderAdminDashboard();
      } else {
        showToast('‚ùå Erro ao desfazer check-in', 'error');
      }
    }

    function undoCheckin(checkinId) {
      showUndoConfirmation(checkinId);
    }

    async function switchClientTab(tab) {
      if (html5QrCode && tab !== 'scanner') {
        html5QrCode.stop().catch(() => {});
        html5QrCode = null;
      }

      currentTab = tab;
      await renderClientDashboard();

      setTimeout(() => {
        const tabs = document.querySelectorAll('.tab-button');
        tabs.forEach(t => t.classList.remove('active'));
        
        const activeTab = Array.from(tabs).find(t => {
          if (tab === 'home') return t.textContent.includes('In√≠cio');
          if (tab === 'scanner') return t.textContent.includes('Scanner');
          return false;
        });
        
        if (activeTab) activeTab.classList.add('active');
      }, 50);
    }

    // =============== GLOBAL FUNCTIONS ===============

    window.switchLoginType = switchLoginType;
    window.loginAdmin = loginAdmin;
    window.loginClient = loginClient;
    window.logout = logout;
    window.showAddClientModal = showAddClientModal;
    window.addClient = addClient;
    window.extendClientToken = extendClientToken;
    window.showDeleteClientConfirmation = showDeleteClientConfirmation;
    window.confirmDeleteClient = confirmDeleteClient;
    window.showTrashModal = showTrashModal;
    window.switchTrashTab = switchTrashTab;
    window.confirmRestoreClient = confirmRestoreClient;
    window.confirmRestoreGuest = confirmRestoreGuest;
    window.switchClientTab = switchClientTab;
    window.showManualSearchModal = showManualSearchModal;
    window.filterManualSearch = filterManualSearch;
    window.selectGuestManually = selectGuestManually;
    window.confirmCompanionEntry = confirmCompanionEntry;
    window.cancelCompanionEntry = cancelCompanionEntry;
    window.filterGuests = filterGuests;
    window.undoCheckin = undoCheckin;
    window.confirmUndoCheckin = confirmUndoCheckin;

    // =============== VALIDA√á√ÉO PERI√ìDICA ===============
    
    setInterval(async () => {
      if (currentUser && currentUser.type === 'client' && isOnline) {
        try {
          await loadClients();
          const client = clients.find(c => c.id === currentUser.id);
          
          if (!client || client.deleted || parseInt(client.expiry) < Date.now()) {
            clearSession('client');
            currentUser = null;
            currentView = 'login';
            
            if (html5QrCode) {
              html5QrCode.stop().catch(() => {});
              html5QrCode = null;
            }
            
            showToast('‚ùå Sess√£o encerrada - Token expirado ou desativado', 'error');
            renderLogin();
          }
        } catch (error) {
          console.log('Erro na valida√ß√£o peri√≥dica (modo offline)');
        }
      }
    }, 30000);

    // =============== INITIALIZATION ===============

    async function init() {
      try {
        loadOfflineQueue();
        
        const loaded = await loadAllData();
        
        if (!loaded) {
          showToast('‚ö†Ô∏è Erro ao carregar dados', 'error');
        }
        
        if (offlineQueue.length > 0 && isOnline) {
          setTimeout(() => syncOfflineQueue(), 2000);
        }

        const hasSession = await checkExistingSession();
        
        if (!hasSession) {
          renderLogin();
        }
      } catch (error) {
        console.error('Erro na inicializa√ß√£o:', error);
        showToast('‚ùå Erro ao inicializar aplica√ß√£o', 'error');
        renderLogin();
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ac7be22d159c13d',t:'MTc2NTQ4NTA1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>