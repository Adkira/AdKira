<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Acesso QR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
      color: #1a202c;
    }
    
    * {
      box-sizing: border-box;
    }
    
    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
      min-height: 100%;
    }
    
    .header {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .header h1 {
      margin: 0 0 8px 0;
      font-size: 24px;
      color: #667eea;
      font-weight: 700;
    }
    
    .header p {
      margin: 0;
      color: #718096;
      font-size: 14px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-label {
      font-size: 12px;
      color: #718096;
      margin-bottom: 4px;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #667eea;
    }
    
    .stat-card.inside .stat-value {
      color: #48bb78;
    }
    
    .stat-card.vip .stat-value {
      color: #f6ad55;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .card h2 {
      margin: 0 0 16px 0;
      font-size: 18px;
      color: #2d3748;
      font-weight: 700;
    }
    
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-success {
      background: #48bb78;
      color: white;
    }
    
    .btn-success:hover {
      background: #38a169;
    }
    
    .btn-danger {
      background: #f56565;
      color: white;
    }
    
    .btn-danger:hover {
      background: #e53e3e;
    }
    
    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }
    
    .btn-secondary:hover {
      background: #cbd5e0;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    #qr-reader {
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    
    .hidden {
      display: none !important;
    }
    
    .guest-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .guest-item {
      background: #f7fafc;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 4px solid #cbd5e0;
    }
    
    .guest-item.inside {
      border-left-color: #48bb78;
      background: #f0fff4;
    }
    
    .guest-item.partial {
      border-left-color: #f6ad55;
      background: #fffaf0;
    }
    
    .guest-item.vip {
      border-left-color: #f6ad55;
      background: #fffaf0;
    }
    
    .guest-info {
      flex: 1;
    }
    
    .guest-name {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 4px;
    }
    
    .guest-status {
      font-size: 12px;
      color: #718096;
    }
    
    .guest-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .btn-delete {
      background: #fed7d7;
      color: #c53030;
    }
    
    .btn-delete:hover {
      background: #fc8181;
      color: white;
    }
    
    .btn-vip {
      background: #fef5e7;
      color: #d97706;
    }
    
    .btn-vip:hover {
      background: #fde68a;
      color: #92400e;
    }
    
    .btn-vip-active {
      background: #f59e0b;
      color: white;
    }
    
    .btn-vip-active:hover {
      background: #d97706;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
      text-transform: uppercase;
    }
    
    .badge-vip {
      background: #fef5e7;
      color: #d97706;
    }
    
    .badge-inside {
      background: #d4edda;
      color: #155724;
    }
    
    .badge-partial {
      background: #fff3cd;
      color: #856404;
    }
    
    .badge-outside {
      background: #e2e8f0;
      color: #4a5568;
    }
    
    input[type="file"] {
      display: none;
    }
    
    .file-upload-btn {
      width: 100%;
      padding: 14px;
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      background: #f7fafc;
      cursor: pointer;
      text-align: center;
      color: #4a5568;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .file-upload-btn:hover {
      border-color: #667eea;
      background: #edf2f7;
      color: #667eea;
    }
    
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #48bb78;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #f56565;
    }
    
    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border-left: 4px solid #f6ad55;
    }
    
    .tab-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .tab-btn {
      flex: 1;
      padding: 12px;
      border: none;
      background: #e2e8f0;
      color: #4a5568;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .tab-btn.active {
      background: #667eea;
      color: white;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #718096;
    }
    
    .spinner {
      border: 3px solid #e2e8f0;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #718096;
    }
    
    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .tabs-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px 16px 0 0;
      padding: 12px 12px 0 12px;
      margin: 0 -16px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .tabs {
      display: flex;
      gap: 4px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      margin-bottom: -1px;
    }
    
    .tabs::-webkit-scrollbar {
      display: none;
    }
    
    .tab {
      min-width: 120px;
      padding: 12px 20px;
      background: #e2e8f0;
      border: none;
      border-radius: 12px 12px 0 0;
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
      position: relative;
    }
    
    .tab:hover {
      background: #cbd5e0;
    }
    
    .tab.active {
      background: white;
      color: #667eea;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
    }
    
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: #667eea;
      border-radius: 3px 3px 0 0;
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .content-wrapper {
      background: white;
      margin: 0 -16px;
      padding: 20px 16px;
      border-radius: 0 0 16px 16px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 16px;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }

    .modal h2 {
      margin: 0 0 16px 0;
      font-size: 20px;
      color: #2d3748;
    }

    .modal p {
      margin: 0 0 20px 0;
      color: #718096;
      line-height: 1.5;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container">
   <div class="header">
    <h1 id="event-title">Controle de Acesso QR</h1>
    <p id="welcome-message">Sistema de Gest√£o de Convidados</p>
   </div>
   <div id="alert-container"></div>
   <div class="tabs-container">
    <div class="tabs"><button class="tab active" data-tab="scanner"> <span>üì∑</span> <span>Scanner</span> </button> <button class="tab" data-tab="guests"> <span>üë•</span> <span>Convidados</span> </button> <button class="tab" data-tab="import"> <span>üì§</span> <span>Importar</span> </button> <button class="tab" data-tab="reports"> <span>üìä</span> <span>Relat√≥rios</span> </button>
    </div>
   </div>
   <div class="content-wrapper">
    <div class="tab-content active" id="scanner-content">
     <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #2d3748; font-weight: 700;">üì∑ Scanner QR Code</h2>
     <div id="qr-reader" class="hidden"></div><button class="btn btn-primary" id="start-scan-btn"> <span>üì∑</span> <span>Iniciar Scanner</span> </button> <button class="btn btn-danger hidden" id="stop-scan-btn"> <span>‚èπÔ∏è</span> <span>Parar Scanner</span> </button>
     <div class="tab-buttons" style="margin-top: 16px;"><button class="tab-btn active" id="tab-entry">Entrada</button> <button class="tab-btn" id="tab-exit">Sa√≠da</button>
     </div>
    </div>
    <div class="tab-content" id="guests-content">
     <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #2d3748; font-weight: 700;">üë• Lista de Convidados</h2>
     <div class="stats-grid" style="margin-bottom: 20px;">
      <div class="stat-card">
       <div class="stat-label">
        Total
       </div>
       <div class="stat-value" id="total-guests">
        0
       </div>
      </div>
      <div class="stat-card inside">
       <div class="stat-label">
        Dentro
       </div>
       <div class="stat-value" id="inside-guests">
        0
       </div>
      </div>
      <div class="stat-card vip">
       <div class="stat-label">
        VIP
       </div>
       <div class="stat-value" id="vip-guests">
        0
       </div>
      </div>
      <div class="stat-card">
       <div class="stat-label">
        Entradas
       </div>
       <div class="stat-value" id="total-entries">
        0
       </div>
      </div>
     </div>
     <div class="tab-buttons"><button class="tab-btn active" id="filter-all">Todos</button> <button class="tab-btn" id="filter-inside">Dentro</button> <button class="tab-btn" id="filter-vip">VIP</button>
     </div>
     <div id="guest-list" class="guest-list"></div>
    </div>
    <div class="tab-content" id="import-content">
     <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #2d3748; font-weight: 700;">üì§ Importar Lista</h2><label for="file-upload" class="file-upload-btn"> üìÅ Selecionar arquivo TXT </label> <input type="file" id="file-upload" accept=".txt">
    </div>
    <div class="tab-content" id="reports-content">
     <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #2d3748; font-weight: 700;">üìä Relat√≥rios</h2><button class="btn btn-success" id="download-pdf-btn"> <span>üìÑ</span> <span>Baixar Relat√≥rio PDF</span> </button> <button class="btn btn-secondary" id="export-data-btn"> <span>üíæ</span> <span>Exportar Dados (JSON)</span> </button> <button class="btn btn-secondary" id="reset-all-btn"> <span>üîÑ</span> <span>Resetar Todas as Leituras</span> </button> <button class="btn btn-danger" id="delete-all-btn"> <span>üóëÔ∏è</span> <span>Deletar Toda a Lista</span> </button>
     <div style="background: #fffaf0; border-radius: 12px; padding: 16px; margin-top: 16px; border-left: 4px solid #f6ad55;">
      <p style="margin: 0; font-size: 13px; color: #744210;"><strong>‚ö†Ô∏è Aten√ß√£o:</strong> Os dados s√£o salvos no navegador (localStorage). Se limpar o cache do navegador, os dados ser√£o perdidos.</p>
     </div>
    </div>
   </div>
  </div>
  <script>
    // LocalStorage para persist√™ncia de dados
    const STORAGE_KEY = 'qr_access_control_guests';
    
    let currentGuests = [];
    let html5QrCode = null;
    let scanMode = 'entry';
    let filterMode = 'all';
    let isScanning = false;
    
    // Carregar dados do localStorage
    function loadGuestsFromStorage() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          currentGuests = JSON.parse(stored);
          updateStats();
          renderGuestList();
        }
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        showAlert('Erro ao carregar dados salvos', 'error');
      }
    }
    
    // Salvar dados no localStorage
    function saveGuestsToStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(currentGuests));
      } catch (error) {
        console.error('Erro ao salvar dados:', error);
        showAlert('Erro ao salvar dados', 'error');
      }
    }
    
    // Fun√ß√£o para detectar n√∫mero de pessoas no nome
    function detectNumberOfPeople(name) {
      const nameLower = name.toLowerCase();
      
      // Padr√µes que indicam 2 pessoas
      const twoPersonPatterns = [
        / e espos[ao]$/i,
        / e mulher$/i,
        / e marido$/i,
        / e companheiro/i,
        / e namorad[ao]$/i,
        / e parceiro/i,
        / \+ 1$/,
        / \+1$/,
      ];
      
      // Padr√µes que indicam 3 pessoas
      const threePersonPatterns = [
        / e familia$/i,
        / \+ 2$/,
        / \+2$/,
      ];
      
      // Padr√µes que indicam 4 pessoas
      const fourPersonPatterns = [
        / \+ 3$/,
        / \+3$/,
      ];
      
      // Verificar padr√µes num√©ricos expl√≠citos primeiro (ex: "+5")
      const explicitNumberMatch = name.match(/\+\s*(\d+)$/);
      if (explicitNumberMatch) {
        return parseInt(explicitNumberMatch[1]) + 1;
      }
      
      // Verificar padr√µes de 4 pessoas
      for (const pattern of fourPersonPatterns) {
        if (pattern.test(name)) {
          return 4;
        }
      }
      
      // Verificar padr√µes de 3 pessoas
      for (const pattern of threePersonPatterns) {
        if (pattern.test(name)) {
          return 3;
        }
      }
      
      // Verificar padr√µes de 2 pessoas
      for (const pattern of twoPersonPatterns) {
        if (pattern.test(name)) {
          return 2;
        }
      }
      
      return 1;
    }
    
    // Adicionar convidado
    function addGuest(guestData) {
      currentGuests.push(guestData);
      saveGuestsToStorage();
      updateStats();
      renderGuestList();
    }
    
    // Atualizar convidado
    function updateGuest(guestId, updates) {
      const index = currentGuests.findIndex(g => g.guest_id === guestId);
      if (index !== -1) {
        currentGuests[index] = { ...currentGuests[index], ...updates };
        saveGuestsToStorage();
        updateStats();
        renderGuestList();
      }
    }
    
    // Deletar convidado
    function deleteGuest(guestId) {
      currentGuests = currentGuests.filter(g => g.guest_id !== guestId);
      saveGuestsToStorage();
      updateStats();
      renderGuestList();
    }
    
    // Deletar todos os convidados
    function deleteAllGuests() {
      currentGuests = [];
      saveGuestsToStorage();
      updateStats();
      renderGuestList();
    }
    
    document.getElementById('file-upload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async (event) => {
        const text = event.target.result;
        const lines = text.split('\n').filter(line => line.trim() && !line.startsWith('#'));
        
        showAlert('Importando convidados...', 'warning');
        
        let importCount = 0;
        let skipped = 0;
        
        for (const line of lines) {
          const parts = line.split(',');
          if (parts.length >= 2) {
            const guestId = parts[0].trim().toLowerCase();
            const name = parts.slice(1).join(',').trim();
            
            // Detectar n√∫mero de pessoas baseado no nome
            const totalAllowed = detectNumberOfPeople(name);
            
            // Verificar se j√° existe
            const exists = currentGuests.find(g => g.guest_id === guestId);
            if (exists) {
              skipped++;
              continue;
            }
            
            addGuest({
              guest_id: guestId,
              name: name,
              total_allowed: totalAllowed,
              entries_used: 0,
              is_vip: false,
              current_status: 'outside',
              history: [],
              last_action_time: new Date().toISOString()
            });
            
            importCount++;
          }
        }
        
        let message = `${importCount} convidados importados!`;
        if (skipped > 0) {
          message += ` (${skipped} j√° existentes foram ignorados)`;
        }
        showAlert(message, 'success');
        e.target.value = '';
      };
      
      reader.readAsText(file, 'UTF-8');
    });
    
    document.getElementById('start-scan-btn').addEventListener('click', async () => {
      if (isScanning) return;
      
      const qrReaderDiv = document.getElementById('qr-reader');
      qrReaderDiv.classList.remove('hidden');
      document.getElementById('start-scan-btn').classList.add('hidden');
      document.getElementById('stop-scan-btn').classList.remove('hidden');
      
      html5QrCode = new Html5Qrcode("qr-reader");
      
      try {
        await html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 250, height: 250 } },
          onScanSuccess
        );
        isScanning = true;
      } catch (err) {
        showAlert('Erro ao iniciar c√¢mera. Verifique as permiss√µes.', 'error');
        stopScanning();
      }
    });
    
    document.getElementById('stop-scan-btn').addEventListener('click', () => {
      stopScanning();
    });
    
    function stopScanning() {
      if (html5QrCode && isScanning) {
        html5QrCode.stop().then(() => {
          document.getElementById('qr-reader').classList.add('hidden');
          document.getElementById('start-scan-btn').classList.remove('hidden');
          document.getElementById('stop-scan-btn').classList.add('hidden');
          isScanning = false;
        });
      }
    }
    
    function onScanSuccess(decodedText) {
      const guestId = decodedText.toLowerCase().trim();
      const guest = currentGuests.find(g => g.guest_id === guestId);
      
      if (!guest) {
        showAlert('Convidado n√£o encontrado!', 'error');
        return;
      }
      
      if (scanMode === 'entry') {
        if (guest.entries_used >= guest.total_allowed) {
          showAlert(`${guest.name} j√° utilizou todas as ${guest.total_allowed} entrada(s)!`, 'warning');
          return;
        }
        
        const newEntriesUsed = guest.entries_used + 1;
        const remainingEntries = guest.total_allowed - newEntriesUsed;
        
        const newHistory = [...guest.history, {
          action: 'entry',
          time: new Date().toISOString()
        }];
        
        const newStatus = (newEntriesUsed >= guest.total_allowed) ? 'inside' : 'partial';
        
        updateGuest(guestId, {
          entries_used: newEntriesUsed,
          current_status: newStatus,
          history: newHistory,
          last_action_time: new Date().toISOString()
        });
        
        if (remainingEntries > 0) {
          showAlert(`‚úÖ ${guest.name} - ENTRADA registrada! Falta(m) ${remainingEntries} pessoa(s) (${newEntriesUsed}/${guest.total_allowed})`, 'success');
        } else {
          showAlert(`‚úÖ ${guest.name} - ENTRADA COMPLETA registrada! (${newEntriesUsed}/${guest.total_allowed})`, 'success');
        }
      } else {
        if (guest.current_status === 'outside') {
          showAlert(`${guest.name} j√° est√° fora do evento!`, 'warning');
          return;
        }
        
        const newHistory = [...guest.history, {
          action: 'exit',
          time: new Date().toISOString()
        }];
        
        updateGuest(guestId, {
          current_status: 'outside',
          history: newHistory,
          last_action_time: new Date().toISOString()
        });
        
        showAlert(`ÔøΩÔøΩÔøΩÔøΩ ${guest.name} - SA√çDA registrada!`, 'success');
      }
    }
    
    // Navega√ß√£o entre abas principais
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.getAttribute('data-tab');
        
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(`${targetTab}-content`).classList.add('active');
        
        if (targetTab !== 'scanner' && isScanning) {
          stopScanning();
        }
      });
    });
    
    document.getElementById('tab-entry').addEventListener('click', () => {
      scanMode = 'entry';
      document.getElementById('tab-entry').classList.add('active');
      document.getElementById('tab-exit').classList.remove('active');
    });
    
    document.getElementById('tab-exit').addEventListener('click', () => {
      scanMode = 'exit';
      document.getElementById('tab-exit').classList.add('active');
      document.getElementById('tab-entry').classList.remove('active');
    });
    
    document.getElementById('filter-all').addEventListener('click', () => {
      filterMode = 'all';
      updateFilterButtons('filter-all');
      renderGuestList();
    });
    
    document.getElementById('filter-inside').addEventListener('click', () => {
      filterMode = 'inside';
      updateFilterButtons('filter-inside');
      renderGuestList();
    });
    
    document.getElementById('filter-vip').addEventListener('click', () => {
      filterMode = 'vip';
      updateFilterButtons('filter-vip');
      renderGuestList();
    });
    
    function updateFilterButtons(activeId) {
      ['filter-all', 'filter-inside', 'filter-vip'].forEach(id => {
        document.getElementById(id).classList.toggle('active', id === activeId);
      });
    }
    
    function updateStats() {
      const total = currentGuests.length;
      const inside = currentGuests.filter(g => g.current_status === 'inside').length;
      const vip = currentGuests.filter(g => g.is_vip).length;
      const totalEntries = currentGuests.reduce((sum, g) => sum + g.entries_used, 0);
      
      document.getElementById('total-guests').textContent = total;
      document.getElementById('inside-guests').textContent = inside;
      document.getElementById('vip-guests').textContent = vip;
      document.getElementById('total-entries').textContent = totalEntries;
    }
    
    function renderGuestList() {
      const container = document.getElementById('guest-list');
      
      let filtered = currentGuests;
      if (filterMode === 'inside') {
        filtered = currentGuests.filter(g => g.current_status === 'inside');
      } else if (filterMode === 'vip') {
        filtered = currentGuests.filter(g => g.is_vip);
      }
      
      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>Nenhum convidado encontrado</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filtered.map(guest => {
        let itemClass = '';
        if (guest.current_status === 'inside') {
          itemClass = 'inside';
        } else if (guest.current_status === 'partial') {
          itemClass = 'partial';
        }
        if (guest.is_vip) {
          itemClass += ' vip';
        }
        
        let statusBadge = '';
        if (guest.entries_used === 0) {
          statusBadge = '<span class="badge badge-outside">Fora</span>';
        } else if (guest.entries_used < guest.total_allowed) {
          statusBadge = '<span class="badge badge-partial">Parcial</span>';
        } else {
          statusBadge = '<span class="badge badge-inside">Completo</span>';
        }
        
        return `
          <div class="guest-item ${itemClass}">
            <div class="guest-info">
              <div class="guest-name">
                ${guest.name}
                ${guest.is_vip ? '<span class="badge badge-vip">VIP</span>' : ''}
                ${statusBadge}
              </div>
              <div class="guest-status">
                ${guest.entries_used}/${guest.total_allowed} entrada(s) utilizadas
              </div>
            </div>
            <div class="guest-actions">
              <button class="btn-small ${guest.is_vip ? 'btn-vip-active' : 'btn-vip'}" onclick="toggleVIP('${guest.guest_id}')">
                ${guest.is_vip ? '‚≠ê VIP' : '‚òÜ VIP'}
              </button>
              <button class="btn-small btn-delete" onclick="confirmDeleteGuest('${guest.guest_id}')">
                üóëÔ∏è
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Fun√ß√£o global para alternar VIP
    window.toggleVIP = function(guestId) {
      const guest = currentGuests.find(g => g.guest_id === guestId);
      if (!guest) return;
      
      const newVipStatus = !guest.is_vip;
      updateGuest(guestId, { is_vip: newVipStatus });
      
      if (newVipStatus) {
        showAlert(`‚≠ê ${guest.name} marcado como VIP!`, 'success');
      } else {
        showAlert(`${guest.name} removido de VIP`, 'warning');
      }
    };
    
    // Fun√ß√£o global para confirmar dele√ß√£o
    window.confirmDeleteGuest = function(guestId) {
      const guest = currentGuests.find(g => g.guest_id === guestId);
      if (!guest) return;
      
      showConfirmModal(
        '‚ö†Ô∏è Confirmar Exclus√£o',
        `Tem certeza que deseja deletar "${guest.name}"? Esta a√ß√£o n√£o pode ser desfeita.`,
        () => {
          deleteGuest(guestId);
          showAlert(`"${guest.name}" foi deletado com sucesso!`, 'success');
        }
      );
    };
    
    document.getElementById('download-pdf-btn').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(18);
      doc.text('Relat√≥rio de Acesso', 105, 20, { align: 'center' });
      
      doc.setFontSize(12);
      doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 35);
      doc.text(`Hora: ${new Date().toLocaleTimeString('pt-BR')}`, 20, 42);
      
      doc.setFontSize(14);
      doc.text('Estat√≠sticas Gerais', 20, 55);
      doc.setFontSize(11);
      doc.text(`Total de Convidados: ${currentGuests.length}`, 20, 63);
      doc.text(`Convidados Dentro: ${currentGuests.filter(g => g.current_status === 'inside').length}`, 20, 70);
      doc.text(`Convidados VIP: ${currentGuests.filter(g => g.is_vip).length}`, 20, 77);
      doc.text(`Total de Entradas: ${currentGuests.reduce((sum, g) => sum + g.entries_used, 0)}`, 20, 84);
      
      let yPos = 100;
      doc.setFontSize(14);
      doc.text('Lista Detalhada de Convidados', 20, yPos);
      yPos += 10;
      
      doc.setFontSize(10);
      currentGuests.forEach((guest, index) => {
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        
        const vipLabel = guest.is_vip ? ' [VIP]' : '';
        const statusLabel = guest.current_status === 'inside' ? ' [DENTRO]' : guest.current_status === 'partial' ? ' [PARCIAL]' : ' [FORA]';
        
        doc.text(`${index + 1}. ${guest.name}${vipLabel}${statusLabel}`, 20, yPos);
        yPos += 6;
        doc.text(`   Entradas: ${guest.entries_used}/${guest.total_allowed}`, 20, yPos);
        yPos += 6;
        
        if (guest.history && guest.history.length > 0) {
          doc.text(`   Hist√≥rico:`, 20, yPos);
          yPos += 6;
          guest.history.slice(-3).forEach(h => {
            const time = new Date(h.time).toLocaleString('pt-BR');
            const action = h.action === 'entry' ? 'ENTRADA' : 'SA√çDA';
            doc.text(`     ‚Ä¢ ${action} - ${time}`, 20, yPos);
            yPos += 6;
          });
        }
        
        yPos += 4;
      });
      
      doc.save(`relatorio-acesso-${new Date().toISOString().split('T')[0]}.pdf`);
      showAlert('Relat√≥rio PDF baixado com sucesso!', 'success');
    });
    
    document.getElementById('export-data-btn').addEventListener('click', () => {
      const dataStr = JSON.stringify(currentGuests, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `backup-convidados-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
      showAlert('Dados exportados com sucesso!', 'success');
    });
    
    document.getElementById('reset-all-btn').addEventListener('click', () => {
      showConfirmModal(
        '‚ö†Ô∏è Confirmar Reset',
        'Tem certeza que deseja resetar todas as leituras? O hist√≥rico de entradas e sa√≠das ser√° limpo, mas os convidados permanecer√£o na lista.',
        () => {
          currentGuests = currentGuests.map(guest => ({
            ...guest,
            entries_used: 0,
            current_status: 'outside',
            history: [],
            last_action_time: new Date().toISOString()
          }));
          saveGuestsToStorage();
          updateStats();
          renderGuestList();
          showAlert('Todas as leituras foram resetadas!', 'success');
        }
      );
    });
    
    document.getElementById('delete-all-btn').addEventListener('click', () => {
      showConfirmModal(
        'üóëÔ∏è Deletar Toda a Lista',
        'ATEN√á√ÉO: Esta a√ß√£o ir√° deletar TODOS os convidados e TODO o hist√≥rico permanentemente. Esta a√ß√£o N√ÉO pode ser desfeita!',
        () => {
          deleteAllGuests();
          showAlert('Toda a lista foi deletada!', 'success');
        }
      );
    });
    
    function showConfirmModal(title, message, onConfirm) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <h2>${title}</h2>
        <p>${message}</p>
        <button class="btn btn-danger" id="modal-confirm">Confirmar</button>
        <button class="btn btn-secondary" id="modal-cancel">Cancelar</button>
      `;
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      
      document.getElementById('modal-confirm').addEventListener('click', () => {
        onConfirm();
        overlay.remove();
      });
      
      document.getElementById('modal-cancel').addEventListener('click', () => {
        overlay.remove();
      });
      
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.remove();
        }
      });
    }
    
    function showAlert(message, type) {
      const container = document.getElementById('alert-container');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.innerHTML = `
        <span style="font-size: 20px;">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</span>
        <span>${message}</span>
      `;
      container.appendChild(alert);
      
      setTimeout(() => {
        alert.style.opacity = '0';
        setTimeout(() => alert.remove(), 300);
      }, 4000);
    }
    
    // Carregar dados ao iniciar
    loadGuestsFromStorage();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a1fc1e4f6c63eb1',t:'MTc2MzcyMzYwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>